<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>INBDE PRO Lab - AI Powered</title>
<link rel="stylesheet" href="styles.css">
<!-- SUPABASE SDK (Necesario para la seguridad) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="lab-container">

    <!-- 1. HEADER -->
    <header class="header-area">
        <h1 class="lab-title" onclick="goBackToDashboard()">INBDE PRO <span style="font-weight:300; opacity:0.5;">Lab</span></h1>
        <div class="lab-subtitle">Train in our lab. Become a Pro.</div>
        <div id="header-welcome-section">
            <div class="user-welcome">
                <span>Welcome back, <span style="color:var(--accent); font-weight:700;" id="user-name-display">Doctor</span></span>
            </div>
            <div class="header-countdown" onclick="openDateModal()" id="countdown-badge">
                <span style="font-size:1.1em">‚è±</span> <span id="countdown-value">-- Days Left</span>
            </div>
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL DEL DASHBOARD -->
    <div id="dashboard-content">
        <!-- 2. COLUMNA IZQUIERDA -->
        <div class="col-side col-left">
            <div class="card-promo-style">
                <div class="promo-header"><div class="fire-icon">üî•</div><div class="promo-title">DAILY LAB <br>RUN</div></div>
                <div class="promo-desc">10-question sprint. Keep the streak alive.</div>
                <!-- CONECTADO A QUIZ ENGINE -->
                <button class="btn-start" onclick="startQuizEngine('daily')">START NOW</button>
            </div>
            <div class="card card-secondary card-notes square-card-bottom" onclick="openAIModal('notes')">
                <div class="card-title">üìù Notes ‚ú®</div>
                <div class="card-desc" style="font-style:italic; opacity:0.5;">Click to organize notes with AI...</div>
            </div>
        </div>

        <!-- 3. COLUMNA CENTRAL -->
        <div class="col-center">
            <div class="card-learn-banner">
                <div class="banner-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>
                <h2>Learn about the INBDE our way</h2>
            </div>
            <div class="center-row-hero">
                <div class="hero-card" onclick="showLearningLab()">
                    <div class="icon">üß™</div><div><div class="title">Learning Lab</div><div class="sub">Deep dive study</div></div>
                </div>
                <div class="hero-card" onclick="showSimulationLab()">
                    <div class="icon">‚ö°</div><div><div class="title">Simulation Lab</div><div class="sub">Exam mode</div></div>
                </div>
                <div class="hero-card" onclick="showPomodoro()">
                    <div class="icon">üçÖ</div><div><div class="title">Pomodoro</div><div class="sub">Focus timer</div></div>
                </div>
            </div>
            
            <!-- CONECTADO A STATS.HTML (Navegaci√≥n Segura) -->
            <div class="card card-metrics square-card-bottom" onclick="safeNavigate('stats.html')">
                <div class="metrics-header">
                    <span class="metrics-title">Performance</span>
                    <span class="metrics-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg></span>
                </div>
                <div class="pie-container"><div class="pie-chart-main"></div></div>
            </div>
        </div>

        <!-- 4. COLUMNA DERECHA -->
        <div class="col-side col-right">
            <div class="card-promo-style" onclick="openAIModal('ia_search')">
                <div class="promo-header"><div class="ai-icon">ü§ñ</div><div class="promo-title">IA LAB ‚ú®</div></div>
                <div class="promo-desc">Smart Search. Find or generate questions instantly.</div>
                <button class="btn-start">ASK AI</button>
            </div>
            <div class="card card-secondary usage-container square-card-bottom">
                <div class="usage-header"><div class="card-title" style="font-size:0.85rem;">Activity Log</div></div>
                <div class="ring-chart"></div>
                <div class="activity-dots"><div class="dot active"></div><div class="dot active"></div><div class="dot"></div><div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot active"></div><div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot active"></div><div class="dot"></div></div>
            </div>
        </div>
    </div>

    <!-- VISTA 2: LEARNING LAB -->
    <div id="learning-view" class="hidden">
        <div class="learning-cards-row">
            <div class="learning-card" onclick="openSelectionView('standalone')">
                <div class="learning-icon">üß†</div><h3>Stand Alone Questions</h3><p>Practice specific topics at your own pace.</p>
            </div>
            <div class="learning-card" onclick="openSelectionView('itemsets')">
                <div class="learning-icon">üîó</div><h3>Item Sets</h3><p>Complex scenarios connecting concepts.</p>
            </div>
        </div>
        <button class="btn-back-small" onclick="goBackToDashboard()">‚Üê Back to Home</button>
    </div>

    <!-- VISTA 3: SIMULATION LAB -->
    <div id="simulation-view" class="hidden">
        <div class="learning-cards-row">
            <div class="learning-card" onclick="openSimulationCustomization()">
                <div class="learning-icon">üõ†Ô∏è</div><h3>Customize your simulation</h3><p>Adjust time and subjects.</p>
            </div>
            <!-- CONECTADO A QUIZ ENGINE (Standard Exam) -->
            <div class="learning-card" onclick="startQuizEngine('simulation_standard')">
                <div class="learning-icon">‚ñ∂Ô∏è</div><h3>Start simulation</h3><p>Begin standard exam mode.</p>
            </div>
        </div>
        <button class="btn-back-small" onclick="goBackToDashboard()">‚Üê Back to Home</button>
    </div>

    <!-- VISTA 4: POMODORO LAB -->
    <div id="pomodoro-view" class="hidden">
        <div class="learning-cards-row">
            <div class="learning-card" onclick="openPomodoroCustomization()">
                <div class="learning-icon">‚öôÔ∏è</div><h3>Customize your experience</h3><p>Set timer intervals.</p>
            </div>
            <!-- ESTE ABRE EL TIMER (Interno) -->
            <div class="learning-card" onclick="openPomodoroSession()">
                <div class="learning-icon">üçÖ</div><h3>IA POMODORO TECHNIQUE</h3><p>Focus timer technique.</p>
            </div>
        </div>
        <button class="btn-back-small" onclick="goBackToDashboard()">‚Üê Back to Home</button>
    </div>

    <!-- VISTA 5: GENERIC SELECTION VIEW (STAND ALONE) -->
    <div id="selection-view" class="hidden">
        <h2 id="selection-mode-title">Stand Alone Questions</h2>
        <div class="selection-container">
            <div class="card-categories open">
                <div class="cat-header" onclick="toggleCategories(this)"><h3>Subjects & Categories</h3><span class="cat-toggle">‚ñº</span></div>
                <div class="cat-list">
                    <div class="subject-item special-select-all" onclick="toggleSelectAll(this)"><div class="custom-checkbox"></div> Select All Categories</div>
                    <div class="subject-item" onclick="toggleCheck(this)"><div class="custom-checkbox"></div> Anatomy</div>
                    <div class="subject-item" onclick="toggleCheck(this)"><div class="custom-checkbox"></div> Prosthodontics</div>
                    <div class="subject-item" onclick="toggleCheck(this)"><div class="custom-checkbox"></div> Operative Dentistry</div>
                    <div class="subject-item" onclick="toggleCheck(this)"><div class="custom-checkbox"></div> Pharmacology</div>
                    <div class="subject-item" onclick="toggleCheck(this)"><div class="custom-checkbox"></div> Oral Surgery</div>
                </div>
            </div>
            <div class="card-start-quiz" onclick="openQuizSettings()">
                <div class="start-icon">üöÄ</div><h3>Start Quiz</h3><p>Begin session with selected topics</p>
            </div>
        </div>
        <button class="btn-back-small" onclick="goBackToLearning()">‚Üê Back to Learning Lab</button>
    </div>

    <!-- VISTA 6: SIMULATION CUSTOMIZATION -->
    <div id="simulation-customization-view" class="hidden">
        <h2 id="sim-custom-title">Customize Simulation</h2>
        <div class="customization-container">
            <div class="custom-section card-categories open">
                 <div class="cat-header"><h3>Select Topics</h3></div>
                 <div class="cat-list">
                    <div class="subject-item special-select-all" onclick="toggleSelectAll(this)"><div class="custom-checkbox"></div> Select All Categories</div>
                    <div class="subject-item" onclick="toggleCheck(this)"><div class="custom-checkbox"></div> Anatomy</div>
                    <div class="subject-item" onclick="toggleCheck(this)"><div class="custom-checkbox"></div> Prosthodontics</div>
                    <div class="subject-item" onclick="toggleCheck(this)"><div class="custom-checkbox"></div> Pharmacology</div>
                 </div>
            </div>
            <div class="custom-section config-panel">
                <div class="config-group">
                    <label class="settings-label">Question Count</label>
                    <select class="question-count-select" id="sim-count">
                        <option value="25">25 Questions</option>
                        <option value="50">50 Questions</option>
                        <option value="75">75 Questions</option>
                        <option value="100">100 Questions</option>
                    </select>
                </div>
                <div class="config-group">
                    <label class="settings-label">Difficulty</label>
                    <div class="difficulty-selector">
                        <div class="diff-option active" onclick="selectDifficulty(this, 'easy')">Easy</div>
                        <div class="diff-option" onclick="selectDifficulty(this, 'medium')">Medium</div>
                        <div class="diff-option" onclick="selectDifficulty(this, 'hard')">Hard</div>
                    </div>
                </div>
                <!-- CONECTADO A QUIZ ENGINE (Custom Sim) -->
                <button class="btn-start-confirm" onclick="startQuizEngine('simulation_custom')">START SIMULATION üöÄ</button>
            </div>
        </div>
        <button class="btn-back-small" onclick="goBackToSimulation()">‚Üê Back to Simulation</button>
    </div>

    <!-- VISTA 7: POMODORO CUSTOMIZATION -->
    <div id="pomodoro-customization-view" class="hidden">
        <h2 id="pomodoro-custom-title">Customize Experience</h2>
        <div class="customization-container">
            <div class="custom-section card-categories open">
                 <div class="cat-header"><h3>Select Study Topics</h3></div>
                 <div class="cat-list">
                    <div class="subject-item special-select-all" onclick="toggleSelectAll(this)"><div class="custom-checkbox"></div> Select All</div>
                    <div class="subject-item" onclick="toggleCheck(this)"><div class="custom-checkbox"></div> Anatomy</div>
                    <div class="subject-item" onclick="toggleCheck(this)"><div class="custom-checkbox"></div> Prosthodontics</div>
                    <div class="subject-item" onclick="toggleCheck(this)"><div class="custom-checkbox"></div> Pharmacology</div>
                 </div>
            </div>
            <div class="custom-section config-panel" style="display: flex; flex-direction: column; justify-content: center;">
                <!-- CONECTADO A QUIZ ENGINE (Pomodoro Mode) -->
                <div class="card-start-quiz" onclick="startQuizEngine('pomodoro_mode')">
                    <div class="start-icon">üçÖ</div>
                    <h3>Start Pomodoro Study</h3>
                    <p>Begin focused session with questions</p>
                </div>
            </div>
        </div>
        <button class="btn-back-small" onclick="goBackToPomodoro()">‚Üê Back to Pomodoro Lab</button>
    </div>

    <!-- VISTA 8: POMODORO TIMER SESSION -->
    <div id="pomodoro-timer-view" class="hidden">
        <h2 style="color:#fff; margin-bottom:5px;">POMODORO FOCUS</h2>
        <div class="pomo-modes">
            <button class="mode-btn active" id="btn-classic" onclick="setPomodoroMode('classic')">Classic 25/5</button>
            <button class="mode-btn" id="btn-flow" onclick="setPomodoroMode('flow')">Flow 50/10</button>
        </div>
        <div class="pomo-container">
            <input type="text" class="pomo-task-input" placeholder="What are you studying?">
            <div class="pomo-cycles"><div class="cycle-dot" id="dot-1"></div><div class="cycle-dot" id="dot-2"></div><div class="cycle-dot" id="dot-3"></div><div class="cycle-dot" id="dot-4"></div></div>
            <div class="pomo-timer-display" id="timer-display">25:00</div>
            <div class="pomo-controls">
                <button class="pomo-btn main" onclick="toggleTimer()"><span id="play-icon">‚ñ∂</span></button>
                <button class="pomo-btn" onclick="resetTimer()">‚Ü∫</button>
            </div>
        </div>
        <div class="distraction-pad"><textarea class="distraction-input" placeholder="Distractions? Park them here... (Brain Dump)"></textarea></div>
        <button class="btn-back-small" onclick="goBackToPomodoro()">End Session</button>
    </div>

</div>

<!-- MODALS & SCRIPTS -->
<div id="ai-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><div class="modal-title"><span id="ai-modal-icon">üß™</span><span id="ai-modal-title">AI Tutor</span></div><button class="close-btn" onclick="closeAIModal()">√ó</button></div><p id="ai-modal-desc" style="color:#aaa; font-size:0.9rem;">Ask any dental question.</p><textarea id="ai-input" class="ai-input-area" placeholder="E.g. Explain Amelogenesis..."></textarea><button id="ai-submit-btn" class="ai-action-btn" onclick="callGemini()"><span class="loader" id="ai-loader"></span><span id="ai-btn-text">Generate with AI ‚ú®</span></button><div id="ai-output" class="ai-response"></div></div></div>

<div id="quiz-settings-modal" class="modal-overlay quiz-settings-modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">‚öôÔ∏è Quiz Settings</div><button class="close-btn" onclick="closeQuizSettings()">√ó</button></div><p style="color:#aaa; margin-bottom:20px;">Configure your practice session.</p><label class="settings-label">Number of Questions:</label><select class="question-count-select" id="quiz-count"><option value="20">20 Questions</option><option value="25">25 Questions</option><option value="30">30 Questions</option><option value="50">50 Questions</option></select><button class="btn-start-confirm" onclick="startQuizEngine('practice_custom')">START NOW üöÄ</button></div></div>

<!-- NEW DATE SETUP MODAL -->
<div id="date-setup-modal" class="modal-overlay active"><div class="modal-content"><div class="modal-header"><div class="modal-title">üìÖ Set Exam Date</div></div><p style="color:#aaa; margin-bottom:20px;">When is your INBDE exam?</p><input type="date" id="exam-date-input" class="date-input"><button class="btn-start-confirm" onclick="saveExamDate()">Start Prep üöÄ</button></div></div>

<script>
    // CONFIGURACI√ìN SUPABASE (Tus claves)
    const SUPABASE_URL = 'https://arumiloijqsxthlswojt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFydW1pbG9panFzeHRobHN3b2p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MzUzNTEsImV4cCI6MjA3OTAxMTM1MX0.5EaB81wglbbtNi8FOzJoDMNd_aOmMULzm27pDClJDSg';
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const apiKey = ""; // Gemini Key
    
    const headerWelcome = document.getElementById('header-welcome-section');

    // --- 1. AUTHENTICATION CHECK (CRITICAL) ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Verificar Sesi√≥n
        const { data: { session } } = await _supabase.auth.getSession();
        if (!session) {
            // SI NO HAY SESI√ìN, REDIRIGIR A LOGIN SEGURO
            safeNavigate('index.html');
        } else {
            // Si hay sesi√≥n, inicializar resto
            const userEmail = session.user.email;
            const name = session.user.user_metadata.full_name || userEmail.split('@')[0];
            document.getElementById('user-name-display').innerText = name;
            initCountdown();
        }
    });

    // --- UTILS FOR SAFE NAVIGATION ---
    function safeNavigate(url) {
        try {
            window.location.href = url;
        } catch (e) {
            console.warn("Redirect failed (Preview Mode):", e);
            // Fallback visual si estamos en preview y falla
            if (url === 'index.html') {
                document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;color:white;"><h2>Session Expired. Please reload.</h2></div>';
            } else {
                console.log("Navegaci√≥n simulada a: " + url);
            }
        }
    }

    // --- QUIZ ENGINE REDIRECTOR ---
    function startQuizEngine(mode) {
        // Recolectar par√°metros si es necesario (ej: cantidad de preguntas)
        let count = 10; // Default
        if (document.getElementById('quiz-count')) {
            count = document.getElementById('quiz-count').value;
        }
        if (document.getElementById('sim-count') && mode === 'simulation_custom') {
            count = document.getElementById('sim-count').value;
        }
        
        // Redirigir a la p√°gina del motor de quiz con par√°metros
        const url = `quiz_engine.html?mode=${mode}&count=${count}`;
        safeNavigate(url);
    }

    // --- DATE LOGIC ---
    function initCountdown() {
        const storedDate = localStorage.getItem('examDate');
        // Solo mostramos modal si no hay fecha Y no estamos en el modal ya (evita loop si recarga)
        if (!storedDate) { 
            document.getElementById('date-setup-modal').classList.add('active'); 
        } else { 
            document.getElementById('date-setup-modal').classList.remove('active'); 
            updateDaysLeft(storedDate); 
        }
    }
    function saveExamDate() {
        const dateInput = document.getElementById('exam-date-input').value;
        if (!dateInput) return alert("Please select a date.");
        localStorage.setItem('examDate', dateInput);
        document.getElementById('date-setup-modal').classList.remove('active');
        updateDaysLeft(dateInput);
    }
    function updateDaysLeft(dateString) {
        const target = new Date(dateString); const today = new Date();
        const diffTime = target - today; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        const display = diffDays > 0 ? `${diffDays} Days Left` : "Exam Day!";
        document.getElementById('countdown-value').innerText = display;
    }
    function openDateModal() { document.getElementById('date-setup-modal').classList.add('active'); }

    // --- NAVIGATION ---
    function showLearningLab() { switchView('learning-view'); }
    function showSimulationLab() { switchView('simulation-view'); }
    function showPomodoro() { switchView('pomodoro-view'); }
    function openSelectionView(mode) { 
        document.getElementById('selection-mode-title').innerText = mode === 'standalone' ? "Stand Alone Questions" : "Item Sets";
        switchView('selection-view'); 
    }
    function openSimulationCustomization() { switchView('simulation-customization-view'); }
    function openPomodoroCustomization() { switchView('pomodoro-customization-view'); }
    function openPomodoroSession() { switchView('pomodoro-timer-view'); resetTimer(); }

    function goBackToDashboard() { switchView('dashboard-content', true); }
    function goBackToLearning() { switchView('learning-view'); }
    function goBackToSimulation() { switchView('simulation-view'); }
    function goBackToPomodoro() { switchView('pomodoro-view'); }

    function switchView(targetId, showHeader = false) {
        const views = ['dashboard-content', 'learning-view', 'simulation-view', 'pomodoro-view', 'selection-view', 'simulation-customization-view', 'pomodoro-customization-view', 'pomodoro-timer-view'];
        let current = views.find(id => !document.getElementById(id).classList.contains('hidden'));
        if(current) {
            document.getElementById(current).classList.add('fade-out');
            setTimeout(() => {
                document.getElementById(current).classList.add('hidden');
                document.getElementById(current).classList.remove('fade-out');
                document.getElementById(targetId).classList.remove('hidden');
                document.getElementById(targetId).classList.add('fade-in');
                if(showHeader) headerWelcome.classList.remove('hidden');
                else headerWelcome.classList.add('hidden');
            }, 300);
        } else { document.getElementById(targetId).classList.remove('hidden'); }
    }

    function toggleCategories(header) { header.parentElement.classList.toggle('open'); }
    function toggleCheck(item) { item.classList.toggle('active'); }
    function toggleSelectAll(source) {
        const isChecked = source.classList.contains('active');
        source.classList.toggle('active');
        const allItems = source.closest('.cat-list').querySelectorAll('.subject-item:not(.special-select-all)');
        allItems.forEach(item => isChecked ? item.classList.remove('active') : item.classList.add('active'));
    }
    function selectDifficulty(option, level) {
        const siblings = option.parentElement.children;
        for (let sib of siblings) sib.classList.remove('active');
        option.classList.add('active');
    }
    
    // Quiz Settings for Stand Alone (uses startQuizEngine now)
    function openQuizSettings() { document.getElementById('quiz-settings-modal').classList.add('active'); }
    function closeQuizSettings() { document.getElementById('quiz-settings-modal').classList.remove('active'); }

    // --- POMODORO LOGIC ---
    let timerInterval; let timeLeft = 1500; let isRunning = false; let currentCycle = 0; let isBreak = false; let pMode = 'classic'; 
    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
        const s = (timeLeft % 60).toString().padStart(2, '0');
        document.getElementById('timer-display').innerText = `${m}:${s}`;
    }
    function toggleTimer() {
        const btn = document.getElementById('play-icon');
        if (isRunning) { clearInterval(timerInterval); btn.innerText = '‚ñ∂'; } 
        else {
            timerInterval = setInterval(() => {
                if (timeLeft > 0) { timeLeft--; updateTimerDisplay(); } 
                else { completeCycle(); }
            }, 1000);
            btn.innerText = '‚ùö‚ùö';
        }
        isRunning = !isRunning;
    }
    function completeCycle() {
        clearInterval(timerInterval); isRunning = false; document.getElementById('play-icon').innerText = '‚ñ∂';
        alert(isBreak ? "Break Over! Back to work." : "Time's up! Take a break.");
        if (!isBreak) {
            currentCycle++; updateDots();
            if (currentCycle >= 4) { isBreak = true; timeLeft = pMode === 'classic' ? 15 * 60 : 20 * 60; currentCycle = 0; updateDots(true); } 
            else { isBreak = true; timeLeft = pMode === 'classic' ? 5 * 60 : 10 * 60; }
        } else { isBreak = false; timeLeft = pMode === 'classic' ? 25 * 60 : 50 * 60; }
        updateTimerDisplay();
    }
    function updateDots(clear = false) {
        for (let i = 1; i <= 4; i++) {
            const dot = document.getElementById(`dot-${i}`);
            if (clear) dot.classList.remove('filled');
            else if (i <= currentCycle) dot.classList.add('filled');
        }
    }
    function resetTimer() {
        clearInterval(timerInterval); isRunning = false; isBreak = false;
        document.getElementById('play-icon').innerText = '‚ñ∂';
        timeLeft = pMode === 'classic' ? 25 * 60 : 50 * 60;
        updateTimerDisplay();
    }
    function setPomodoroMode(mode) {
        pMode = mode;
        document.getElementById('btn-classic').classList.toggle('active', mode === 'classic');
        document.getElementById('btn-flow').classList.toggle('active', mode === 'flow');
        resetTimer();
    }

    // AI Logic
    const modal = document.getElementById('ai-modal');
    const inputArea = document.getElementById('ai-input');
    const outputArea = document.getElementById('ai-output');
    const submitBtn = document.getElementById('ai-submit-btn');
    const loader = document.getElementById('ai-loader');
    const btnText = document.getElementById('ai-btn-text');
    let currentAIMode = 'tutor'; 

    function openAIModal(mode) {
        currentAIMode = mode; modal.classList.add('active'); outputArea.style.display = 'none'; outputArea.innerHTML = ''; inputArea.value = '';
        if (mode === 'ia_search') {
            document.getElementById('ai-modal-title').textContent = "INBDE Pro IA";
            document.getElementById('ai-modal-desc').textContent = "Find questions instantly.";
        }
    }
    function closeAIModal() { modal.classList.remove('active'); }
    async function callGemini() {
        const userQuery = inputArea.value.trim();
        if (!userQuery) return;
        submitBtn.disabled = true; loader.style.display = 'inline-block'; btnText.style.display = 'none'; outputArea.style.display = 'none';
        let systemPrompt = "You are a helpful dental study assistant.";
        if (currentAIMode === 'ia_search') systemPrompt = "You are an intelligent assistant for INBDE candidates. Generate practice questions.";
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } }) });
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
            const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            outputArea.innerHTML = formattedText; outputArea.style.display = 'block';
        } catch (error) { outputArea.innerHTML = "Error contacting Gemini API."; outputArea.style.display = 'block'; } finally { submitBtn.disabled = false; loader.style.display = 'none'; btnText.style.display = 'inline'; }
    }
</script>

</body>
</html>
