<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>INBDE PRO Lab</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    /* --- 1. VARIABLES & BASE --- */
    :root {
        --accent: #facc15; 
        --accent-glow: rgba(250, 204, 21, 0.15);
        --bg-dark: #050505;
        --card-bg: #121214;
        --card-bg-hero: #1c1c20;
        --card-border: #27272a;
        --text-main: #f4f4f5;
        --text-muted: #71717a;
        
        /* DIMENSIONES DE ESCRITORIO */
        --col-width: 200px;
        --sq-size: 190px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        margin: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background-color: #000;
        color: var(--text-main);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: radial-gradient(circle at 50% 50%, #1a1830 0%, #000000 70%);
    }

    /* --- 2. GRID LAYOUT (DESKTOP) --- */
    .lab-container {
        width: 100%;
        max-width: 1500px;
        height: 96vh;
        display: grid;
        grid-template-columns: var(--col-width) 1fr var(--col-width);
        grid-template-rows: auto 1fr;
        gap: 25px; 
        padding: 20px;
        overflow: hidden;
        position: relative;
    }

    /* Clases de Utilidad */
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.5s ease forwards; }
    .fade-out { animation: fadeOut 0.3s ease forwards; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    /* --- 3. HEADER AREA --- */
    .header-area {
        grid-column: 2 / 3;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding-bottom: 20px;
        z-index: 10;
        min-height: 80px;
    }

    .lab-title {
        font-size: 2.2rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: -1px;
        margin: 0;
        color: #fff;
        cursor: pointer;
    }

    .lab-subtitle {
        color: var(--accent);
        font-weight: 600;
        font-size: 0.9rem;
        letter-spacing: 2px;
        text-transform: uppercase;
        margin-top: 5px;
        opacity: 0.8;
    }

    #header-welcome-section {
        margin-top: 10px;
        display: flex; 
        flex-direction: column;
        align-items: center;
        gap: 5px;
        transition: opacity 0.3s;
    }

    .user-welcome {
        font-size: 1.2rem;
        color: var(--text-muted);
        font-weight: 400;
        display: flex; align-items: center; gap: 15px;
    }

    .header-countdown {
        background: rgba(250, 204, 21, 0.1);
        border: 1px solid rgba(250, 204, 21, 0.3);
        color: var(--accent);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        display: inline-flex; align-items: center; gap: 6px;
        cursor: pointer; /* Clickable to edit date */
        transition: all 0.2s;
    }
    .header-countdown:hover {
        background: rgba(250, 204, 21, 0.2);
        transform: scale(1.05);
    }

    /* Bot√≥n Logout Estilizado */
    .btn-logout-icon {
        background: rgba(255, 107, 107, 0.1);
        color: #ff6b6b;
        border: 1px solid #ff6b6b;
        border-radius: 50%;
        width: 30px; height: 30px;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer; font-size: 0.8rem;
        transition: all 0.2s;
    }
    .btn-logout-icon:hover { background: #ff6b6b; color: #000; }

    /* --- 4. DASHBOARD CONTENT --- */
    #dashboard-content { display: contents; }

    .col-side { display: flex; flex-direction: column; justify-content: space-between; padding-top: 40px; gap: 20px; opacity: 0.9; transition: opacity 0.3s; }
    .col-side:hover { opacity: 1; }
    .col-left { grid-column: 1 / 2; grid-row: 1 / 3; }
    .col-right { grid-column: 3 / 4; grid-row: 1 / 3; }
    .col-center { grid-column: 2 / 3; grid-row: 2 / 3; display: flex; flex-direction: column; align-items: center; gap: 25px; position: relative; }

    /* --- 5. CARDS STYLES --- */
    .card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 14px; padding: 15px; position: relative; transition: all 0.3s; cursor: pointer; }
    .card-secondary { box-shadow: none; }
    .card-secondary:hover { background: #18181b; border-color: #52525b; }
    .card-secondary .card-title { font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px; } 
    .card-secondary .card-desc { font-size: 0.75rem; }

    .card-promo-style {
        width: 100%; background: linear-gradient(145deg, rgba(250, 204, 21, 0.15), rgba(0,0,0,0) 70%); border: 2px solid var(--accent); border-radius: 16px; padding: 20px;
        box-shadow: 0 0 20px rgba(250, 204, 21, 0.15); cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; min-height: 160px; 
        display: flex; flex-direction: column; justify-content: center;
    }
    .card-promo-style:hover { transform: scale(1.05) translateY(-5px); box-shadow: 0 10px 30px rgba(250, 204, 21, 0.3); background: linear-gradient(145deg, rgba(250, 204, 21, 0.25), rgba(0,0,0,0) 80%); }

    .promo-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    @keyframes pulse-fire { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    .fire-icon { font-size: 1.5rem; animation: pulse-fire 2s infinite ease-in-out; }
    .ai-icon { font-size: 1.5rem; filter: drop-shadow(0 0 5px var(--accent)); }
    .promo-title { font-size: 1rem; font-weight: 800; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; }
    .promo-desc { font-size: 0.8rem; color: #ddd; margin-bottom: 15px; line-height: 1.3; }
    .btn-start { display: block; width: 100%; background: var(--accent); color: #000; font-weight: 900; font-size: 0.85rem; padding: 12px 0; border-radius: 8px; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 10px rgba(250, 204, 21, 0.3); text-align: center; border: none; cursor: pointer; }

    .card-learn-banner { width: 100%; padding: 20px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 15px; border: 2px solid var(--accent); background: rgba(250, 204, 21, 0.05); margin-bottom: 20px; border-radius: 16px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .card-learn-banner:hover { background: rgba(250, 204, 21, 0.12); transform: translateY(-2px); }
    .card-learn-banner h2 { margin: 0; font-size: 1.2rem; font-weight: 700; color: #fff; }
    .banner-icon { color: var(--accent); display: flex; }

    .center-row-hero { width: 100%; display: flex; justify-content: center; gap: 25px; flex: 1; align-items: flex-start; }
    .hero-card { flex: 1; max-width: 260px; aspect-ratio: 1 / 1; background: var(--card-bg-hero); border: 1px solid var(--accent); box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5), 0 0 20px var(--accent-glow); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 15px; cursor: pointer; }
    .hero-card:hover { transform: translateY(-8px) scale(1.02); background: #23232a; }
    .hero-card .icon { font-size: 3rem; margin-bottom: 15px; }
    .hero-card .title { font-size: 1.2rem; font-weight: 800; color: #fff; margin-bottom: 5px; }
    .hero-card .sub { font-size: 0.8rem; color: var(--text-muted); }

    .square-card-bottom { width: var(--sq-size); height: var(--sq-size); margin-top: auto; display: flex; flex-direction: column; }
    .card-notes { background-image: radial-gradient(#333 1px, transparent 1px); background-size: 12px 12px; }
    .card-metrics { background: linear-gradient(180deg, var(--card-bg-hero) 0%, #080808 100%); border-top: 1px solid #333; box-shadow: 0 -10px 40px -20px rgba(0,0,0,1); }
    .metrics-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .metrics-title { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    .pie-container { flex: 1; display: flex; align-items: center; justify-content: center; }
    .pie-chart-main { width: 90px; height: 90px; border-radius: 50%; background: conic-gradient(var(--accent) 0% 65%, #27272a 65% 100%); box-shadow: 0 0 15px rgba(0,0,0,0.5); }
    .usage-container { align-items: center; justify-content: center; gap: 10px; }
    .usage-header { width: 100%; text-align: left; }
    .ring-chart { width: 60px; height: 60px; border-radius: 50%; background: conic-gradient(var(--accent) 65%, #27272a 0); display: flex; justify-content: center; align-items: center; }
    .ring-chart::after { content: ""; width: 48px; height: 48px; background: var(--card-bg); border-radius: 50%; }
    .activity-dots { display: flex; gap: 3px; justify-content: center; flex-wrap: wrap; width: 100%; }
    .dot { width: 6px; height: 6px; background: #333; border-radius: 1px; }
    .dot.active { background: var(--accent); }

    /* --- LEARNING / SIMULATION / POMODORO VIEWS (DESKTOP) --- */
    #learning-view, #simulation-view, #pomodoro-view { grid-column: 1 / -1; grid-row: 2 / -1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 30px; height: 100%; }
    .learning-cards-row { display: flex; flex-direction: row; gap: 40px; justify-content: center; align-items: center; width: 100%; }
    .learning-card { width: 300px; height: 300px; background: linear-gradient(145deg, rgba(250, 204, 21, 0.1), rgba(0,0,0,0) 70%); border: 2px solid var(--accent); border-radius: 24px; padding: 30px; box-shadow: 0 0 30px rgba(250, 204, 21, 0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; cursor: pointer; transition: all 0.4s; }
    .learning-card:hover { transform: translateY(-10px) scale(1.05); box-shadow: 0 20px 50px rgba(250, 204, 21, 0.25); background: linear-gradient(145deg, rgba(250, 204, 21, 0.2), rgba(0,0,0,0) 80%); }
    .learning-card h3 { font-size: 1.5rem; margin-bottom: 10px; color: #fff; text-transform: uppercase; }
    .learning-card p { font-size: 0.9rem; color: #aaa; }
    .learning-icon { font-size: 4rem; margin-bottom: 20px; }
    .btn-back-small { background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); padding: 10px 25px; border-radius: 30px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; }
    .btn-back-small:hover { border-color: var(--accent); color: var(--accent); background: rgba(250, 204, 21, 0.05); }

    /* --- SELECTION / CUSTOMIZATION VIEWS --- */
    #selection-view, #simulation-customization-view, #pomodoro-customization-view { grid-column: 1 / -1; grid-row: 2 / -1; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; gap: 20px; height: 100%; padding: 20px; overflow-y: auto; }
    .selection-container, .customization-container { display: flex; width: 100%; max-width: 1000px; gap: 30px; height: 100%; }
    
    .card-categories, .config-panel { flex: 1; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px; display: flex; flex-direction: column; max-height: 600px; }
    .card-categories { flex: 2; }
    .cat-header { padding: 20px; border-bottom: 1px solid var(--card-border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: rgba(255,255,255,0.02); }
    .cat-header h3 { margin: 0; color: var(--accent); font-size: 1.2rem; text-transform: uppercase; }
    .cat-list { padding: 20px; overflow-y: auto; display: block; } /* Changed to block for easier JS manipulation */
    .card-categories.open .cat-list { display: block; }
    
    .subject-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-muted); cursor: pointer; transition: color 0.2s; }
    .subject-item:hover { color: #fff; }
    .custom-checkbox { width: 20px; height: 20px; border: 2px solid var(--text-muted); border-radius: 4px; margin-right: 15px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .subject-item.active .custom-checkbox { border-color: var(--accent); background: rgba(250, 204, 21, 0.2); box-shadow: 0 0 10px var(--accent-glow); }
    .subject-item.active { color: #fff; font-weight: 600; }
    .subject-item.active .custom-checkbox::after { content: '‚úî'; color: var(--accent); font-size: 0.8rem; }
    .special-select-all { color: var(--accent); font-weight: 700; border-bottom: 2px solid rgba(250, 204, 21, 0.2); margin-bottom: 10px; }
    .special-select-all .custom-checkbox { border-color: var(--accent); }

    .config-panel { padding: 30px; justify-content: center; background: linear-gradient(145deg, rgba(32,38,50,0.5), rgba(0,0,0,0.8)); border: 1px solid var(--border-light); }
    .config-group { margin-bottom: 30px; width: 100%; }
    .difficulty-selector { display: flex; border: 1px solid var(--text-muted); border-radius: 8px; overflow: hidden; }
    .diff-option { flex: 1; padding: 12px; text-align: center; color: var(--text-muted); cursor: pointer; font-weight: 600; transition: all 0.2s; border-right: 1px solid #333; }
    .diff-option:last-child { border-right: none; }
    .diff-option:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .diff-option.active { background: var(--accent); color: #000; font-weight: 800; }

    .card-start-quiz { flex: 1; background: linear-gradient(145deg, rgba(250, 204, 21, 0.1), rgba(0,0,0,0) 70%); border: 2px solid var(--accent); border-radius: 16px; padding: 30px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; cursor: pointer; transition: all 0.3s; height: fit-content; }
    .card-start-quiz:hover { transform: scale(1.03); box-shadow: 0 0 30px rgba(250, 204, 21, 0.2); }
    .card-start-quiz h3 { font-size: 1.8rem; color: #fff; margin-bottom: 10px; text-transform: uppercase; }
    .start-icon { font-size: 3rem; margin-bottom: 15px; }

    #selection-mode-title, #sim-custom-title, #pomodoro-custom-title { width: 100%; text-align: center; margin-bottom: 10px; color: white; text-transform: uppercase; font-weight: 800; font-size: 1.5rem; letter-spacing: 1px; }

    /* --- POMODORO TIMER VIEW --- */
    #pomodoro-timer-view { grid-column: 1 / -1; grid-row: 2 / -1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; height: 100%; width: 100%; max-width: 600px; margin: 0 auto; }
    .pomo-container { width: 100%; background: var(--card-bg); border: 1px solid var(--accent); border-radius: 24px; padding: 40px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 0 40px rgba(250,204,21,0.1); position: relative; }
    .pomo-task-input { background: transparent; border: none; border-bottom: 1px solid #444; color: #fff; width: 80%; text-align: center; font-size: 1.2rem; padding: 10px; margin-bottom: 30px; font-family: inherit; outline: none; transition: border-color 0.3s; }
    .pomo-task-input:focus { border-color: var(--accent); }
    .pomo-timer-display { font-size: 6rem; font-weight: 900; font-variant-numeric: tabular-nums; color: #fff; margin: 10px 0; text-shadow: 0 0 20px rgba(255,255,255,0.1); }
    .pomo-controls { display: flex; gap: 20px; margin-bottom: 30px; }
    .pomo-btn { background: #333; color: #fff; border: none; width: 60px; height: 60px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.2s; }
    .pomo-btn.main { background: var(--accent); color: #000; width: 80px; height: 80px; font-size: 2rem; box-shadow: 0 0 20px rgba(250,204,21,0.3); }
    .pomo-btn:hover { transform: scale(1.1); }
    .pomo-cycles { display: flex; gap: 10px; margin-bottom: 30px; }
    .cycle-dot { width: 12px; height: 12px; border-radius: 50%; background: #333; border: 1px solid #555; }
    .cycle-dot.filled { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 5px var(--accent); }
    .pomo-modes { display: flex; gap: 10px; background: #111; padding: 5px; border-radius: 30px; margin-bottom: 20px; }
    .mode-btn { padding: 8px 20px; border-radius: 20px; border: none; background: transparent; color: #888; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s; }
    .mode-btn.active { background: #333; color: #fff; }
    .distraction-pad { width: 100%; margin-top: 20px; }
    .distraction-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px dashed #444; border-radius: 8px; padding: 15px; color: #aaa; font-size: 0.9rem; resize: none; min-height: 60px; }
    .distraction-input:focus { border-color: #666; color: #fff; outline: none; }

    /* --- DATE SETTINGS MODAL --- */
    .date-input { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 15px; font-size: 1.2rem; text-align: center; border-radius: 8px; margin-bottom: 20px; color-scheme: dark; }
    .date-input:focus { border-color: var(--accent); outline: none; }

    /* --- SELECT NUMBER OF QUESTIONS MODAL & PANEL --- */
    .quiz-settings-modal .modal-content { max-width: 400px; text-align: center; }
    .settings-label { display: block; color: #ccc; margin-bottom: 15px; font-size: 1.1rem; text-align: left; }
    .question-count-select { width: 100%; padding: 15px; font-size: 1.2rem; background: #000; border: 1px solid var(--accent); color: #fff; border-radius: 8px; margin-bottom: 25px; text-align: center; cursor: pointer; appearance: none; }
    .question-count-select option { background: #222; color: #fff; }
    .btn-start-confirm { width: 100%; background: var(--accent); color: #000; padding: 15px; border: none; font-weight: 900; border-radius: 8px; cursor: pointer; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; }

    /* --- AI MODAL & GENERIC MODAL UI --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    .modal-content { background: #18181b; border: 1px solid var(--card-border); border-radius: 20px; width: 90%; max-width: 500px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform: translateY(20px); transition: transform 0.3s ease; display: flex; flex-direction: column; gap: 15px; }
    .modal-overlay.active .modal-content { transform: translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .modal-title { font-size: 1.5rem; font-weight: 800; color: #fff; display: flex; align-items: center; gap: 10px; }
    .close-btn { background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer; }
    .ai-input-area { width: 100%; background: #000; border: 1px solid #333; border-radius: 12px; padding: 15px; color: #fff; font-family: inherit; resize: vertical; min-height: 100px; font-size: 1rem; }
    .ai-input-area:focus { outline: none; border-color: var(--accent); }
    .ai-action-btn { background: var(--accent); color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition: transform 0.2s; }
    .ai-action-btn:hover { transform: scale(1.02); background: #fff; }
    .ai-action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .ai-response { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; color: #ccc; font-size: 0.95rem; line-height: 1.6; max-height: 300px; overflow-y: auto; border-left: 3px solid var(--accent); display: none; }
    .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* RECOVERY INPUT STYLES ADAPTED TO DARK THEME */
    .input-pass { width: 100%; padding: 15px; border: 2px solid var(--card-border); background: #000; color: #fff; border-radius: 8px; font-size: 1rem; text-align: center; }
    .input-pass:focus { border-color: var(--accent); outline: none; }
    .password-alert { background: rgba(250, 204, 21, 0.2); color: var(--accent); border: 1px solid var(--accent); padding: 15px; text-align: center; margin-bottom: 20px; border-radius: 10px; display: none; }

    /* =========================================
       3. MEDIA QUERIES (VISTA M√ìVIL)
       ========================================= */
   /* =========================================
       3. MEDIA QUERIES (VISTA M√ìVIL)
       ========================================= */
    @media (max-width: 1024px) {
        /* CAMBIO 1: height: auto, min-height: 100dvh y overflow-y: auto habilitan el scroll */
        body { height: auto; min-height: 100dvh; overflow-y: auto; align-items: flex-start; padding: 0; }
        
        .lab-container {
            /* CAMBIO 2: height: auto permite que el contenedor crezca m√°s all√° de la pantalla */
            height: auto;
            display: grid;
            /* ESTRUCTURA BENTO 2 COLUMNAS */
            grid-template-columns: 1fr 1fr; 
            /* Filas ajustadas: Header | Banner | Hero | Daily/Metrics | Notes/Activity | IA (Footer) */
            grid-template-rows: min-content min-content 400px min-content min-content min-content; /* Se ajust√≥ la fila del Hero a 400px fijos para dar espacio */
            gap: 8px; 
            padding: 10px 12px 40px 12px; /* A√±adido padding inferior para scroll extra */
            width: 100%;
            overflow: visible;
        }

        /* ... el resto del c√≥digo dentro del media query sigue igual ... */

        .col-side, .col-center { display: contents; }

        /* 1. HEADER */
        .header-area { grid-column: 1 / -1; order: 0; margin: 0; padding-bottom: 5px; min-height: auto; }
        .lab-title { font-size: 1.5rem; }
        .header-countdown { padding: 2px 8px; font-size: 0.7rem; }

        /* 2. BANNER LEARN */
        .card-learn-banner { grid-column: 1 / -1; order: 1; margin: 0; padding: 8px; min-height: 40px; }
        .card-learn-banner h2 { font-size: 0.85rem; }

        /* 3. HERO CARDS (PRINCIPALES - GRANDES Y VERTICALES) */
        .center-row-hero {
            grid-column: 1 / -1; 
            order: 2;
            flex-direction: row !important;
            gap: 6px;
            margin: 0;
            height: 100%; 
            align-items: stretch;
        }
        .hero-card {
            min-height: 0;
            padding: 12px 5px;
            flex-direction: column; 
            justify-content: center;
            flex: 1;
        }
        .hero-card .icon { margin-bottom: 8px; font-size: 2.5rem; }
        .hero-card .title { font-size: 0.9rem; line-height: 1.1; }

        /* 4. DAILY & METRICS (SECUNDARIAS - PEQUE√ëAS) */
        .col-left .card-promo-style { /* Daily */
            grid-column: 1 / 2; order: 3;
            min-height: 110px; 
            margin: 0; padding: 10px;
            border: 2px solid var(--accent) !important;
            flex-direction: column; /* Restaurar verticalidad para bento */
            align-items: center;
            justify-content: center;
        }
        .card-metrics { /* Metrics */
            display: flex !important; /* Restaurar visibilidad */
            grid-column: 2 / 3; order: 3;
            min-height: 110px; 
            margin: 0; padding: 8px;
            background: linear-gradient(145deg, rgba(250, 204, 21, 0.15), rgba(0,0,0,0) 70%);
            border: 2px solid var(--accent);
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.15);
            border-radius: 16px;
        }
        .col-left .card-promo-style .promo-title, .metrics-title { font-size: 0.7rem; margin-bottom: 2px; }
        .col-left .card-promo-style .btn-start { font-size: 0.6rem; padding: 4px 0; margin-top: auto; width: 100%; }
        .col-left .card-promo-style .promo-header { margin-bottom: 5px; gap: 5px; }
        .col-left .card-promo-style .promo-desc { display: block; font-size: 0.6rem; margin-bottom: 5px; text-align: center; }
        .pie-chart-main { width: 45px; height: 45px; }
        
        /* 5. NOTES & ACTIVITY (SECUNDARIAS - BORDE AMARILLO) */
        .col-left .card-notes {
            display: flex !important; /* Restaurar visibilidad */
            grid-column: 1 / 2; order: 4;
            min-height: 90px; margin: 0; padding: 8px;
            border: 1px solid var(--accent);
        }
        .col-right .usage-container {
            display: flex !important; /* Restaurar visibilidad */
            grid-column: 2 / 3; order: 4;
            min-height: 90px; margin: 0; padding: 8px;
            border: 1px solid var(--accent);
            flex-direction: column; justify-content: center;
        }
        .card-notes .card-title, .usage-header .card-title { font-size: 0.7rem; }
        .ring-chart { width: 30px; height: 30px; margin-bottom: 0; }
        .ring-chart::after { width: 20px; height: 20px; }
        .activity-dots { display: none; }
        
        /* 6. IA LAB (AL FINAL - BARRA COMPLETA) */
        .col-right .card-promo-style {
            display: flex !important; /* Restaurar visibilidad */
            grid-column: 1 / -1; 
            order: 5;
            width: 100%;
            min-height: 45px;
            padding: 8px 15px;
            margin: 0;
            flex-direction: row; align-items: center; justify-content: space-between;
            border: 2px solid var(--accent);
        }
        .col-right .card-promo-style .promo-header { margin-bottom: 0; gap: 8px; }
        .col-right .card-promo-style .ai-icon { font-size: 1.1rem; }
        .col-right .card-promo-style .promo-title { font-size: 0.8rem; }
        .col-right .card-promo-style .promo-desc { display: none; } 
        .col-right .card-promo-style .btn-start { width: auto; padding: 5px 12px; font-size: 0.65rem; margin: 0; }
        
        .countdown-box { display: none; }

        /* --- VISTAS INTERNAS (LEARNING/SIMULATION/POMODORO) --- */
        /* Ajustar vistas internas para ocupar toda la pantalla */
        #learning-view, #simulation-view, #pomodoro-view, #selection-view, #simulation-customization-view, #pomodoro-customization-view, #pomodoro-timer-view {
             grid-column: 1 / -1; 
             grid-row: 2 / -1; 
             position: absolute; 
             z-index: 100;
             height: 100%;
             width: 100%;
             top: 0;
             left: 0;
             padding: 10px;
             background: #000; /* Ensure background covers dashboard */
        }

        /* REGLAS DE TARJETAS PEQUE√ëAS (Mantenidas del requerimiento anterior) */
        .learning-cards-row {
            flex-direction: row;
            gap: 15px;
            width: 100%;
            justify-content: center;
            max-width: 100%;
        }

        .learning-card {
            width: 48%; 
            height: auto;
            min-height: 180px;
            padding: 15px;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .learning-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .learning-card h3 { 
            font-size: 1rem;
        }
        
        .learning-card p {
            font-size: 0.8rem;
            line-height: 1.2;
        }
    }
</style>
</head>
<body>

<div id="password-alert-container" style="position: absolute; top: 0; left:0; width:100%; z-index:999;"></div>

<div class="lab-container">

    <header class="header-area">
    <h1 class="lab-title" onclick="goBackToDashboard()">
        INBDE PRO <span style="color: var(--accent); font-weight: 700;">Lab</span>
    </h1>
    <div class="lab-subtitle">Train in our lab. Become a Pro.</div>
    <div id="header-welcome-section">
            <div class="user-welcome">
                <span>Welcome back, <span id="user-name-display" style="color:var(--accent); font-weight:700;">Doctor</span></span>
                <button class="btn-logout-icon" onclick="logout()" title="Sign Out">‚èª</button>
            </div>
            <div class="header-countdown" onclick="openDateModal()" id="countdown-badge">
                <span style="font-size:1.1em">‚è±</span> <span id="countdown-value">-- Days Left</span>
            </div>
        </div>
    </header>

    <div id="dashboard-content">
        <div class="col-side col-left">
            <div class="card-promo-style">
                <div class="promo-header"><div class="fire-icon">üî•</div><div class="promo-title">DAILY LAB <br>RUN</div></div>
                <div class="promo-desc">10-question sprint. Keep the streak alive.</div>
                <button class="btn-start" onclick="startDailyRun()">START NOW</button>
            </div>
            <div class="card card-secondary card-notes square-card-bottom" onclick="openAIModal('notes')">
                <div class="card-title">üìù Notes ‚ú®</div>
                <div class="card-desc" style="font-style:italic; opacity:0.5;">Click to organize notes with AI...</div>
            </div>
        </div>

        <div class="col-center">
            <div class="card-learn-banner">
                <div class="banner-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>
                <h2>Learn about the INBDE our way</h2>
            </div>
            <div class="center-row-hero">
                <div class="hero-card" onclick="showLearningLab()">
                    <div class="icon">üß™</div><div><div class="title">Learning Lab</div><div class="sub">Deep dive study</div></div>
                </div>
                <div class="hero-card" onclick="showSimulationLab()">
                    <div class="icon">‚ö°</div><div><div class="title">Simulation Lab</div><div class="sub">Exam mode</div></div>
                </div>
                <div class="hero-card" onclick="showPomodoro()">
                    <div class="icon">üçÖ</div><div><div class="title">Pomodoro</div><div class="sub">Focus timer</div></div>
                </div>
            </div>
            <div class="card card-metrics square-card-bottom" onclick="window.location.href='stats.html'">
                <div class="metrics-header">
                    <span class="metrics-title">Performance</span>
                    <span class="metrics-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg></span>
                </div>
                <div class="pie-container"><div class="pie-chart-main"></div></div>
            </div>
        </div>

        <div class="col-side col-right">
            <div class="card-promo-style" onclick="openAIModal('ia_search')">
                <div class="promo-header"><div class="ai-icon">ü§ñ</div><div class="promo-title">IA LAB ‚ú®</div></div>
                <div class="promo-desc">Smart Search. Find or generate questions instantly.</div>
                <button class="btn-start">ASK AI</button>
            </div>
            <div class="card card-secondary usage-container square-card-bottom">
                <div class="usage-header"><div class="card-title" style="font-size:0.85rem;">Activity Log</div></div>
                <div class="ring-chart"></div>
                <div class="activity-dots"><div class="dot active"></div><div class="dot active"></div><div class="dot"></div><div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot active"></div><div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot active"></div><div class="dot"></div></div>
            </div>
        </div>
    </div>

    <div id="learning-view" class="hidden">
        <div class="learning-cards-row">
            <div class="learning-card" onclick="openSelectionView('standalone')">
                <div class="learning-icon">üß†</div><h3>Stand Alone Questions</h3><p>Practice specific topics at your own pace.</p>
            </div>
            <div class="learning-card" onclick="openSelectionView('itemsets')">
                <div class="learning-icon">üîó</div><h3>Item Sets</h3><p>Complex scenarios connecting concepts.</p>
            </div>
        </div>
        <button class="btn-back-small" onclick="goBackToDashboard()">‚Üê Back to Home</button>
    </div>

    <div id="simulation-view" class="hidden">
        <div class="learning-cards-row">
            <div class="learning-card" onclick="openSelectionView('simulation')">
                <div class="learning-icon">üõ†Ô∏è</div><h3>Customize your simulation</h3><p>Adjust time and subjects.</p>
            </div>
            <div class="learning-card" onclick="startQuizEngine('simulation_standard')">
                <div class="learning-icon">‚ñ∂Ô∏è</div><h3>Start simulation</h3><p>Begin standard exam mode.</p>
            </div>
        </div>
        <button class="btn-back-small" onclick="goBackToDashboard()">‚Üê Back to Home</button>
    </div>

    <div id="pomodoro-view" class="hidden">
        <div class="learning-cards-row">
            <div class="learning-card" onclick="openPomodoroCustomization()">
                <div class="learning-icon">‚öôÔ∏è</div><h3>Customize your experience</h3><p>Set timer intervals.</p>
            </div>
            <div class="learning-card" onclick="openPomodoroSession()">
                <div class="learning-icon">üçÖ</div><h3>IA POMODORO TECHNIQUE</h3><p>Focus timer technique.</p>
            </div>
        </div>
        <button class="btn-back-small" onclick="goBackToDashboard()">‚Üê Back to Home</button>
    </div>

    <div id="selection-view" class="hidden">
        <h2 id="selection-mode-title">Stand Alone Questions</h2>
        <div class="selection-container">
            <div class="card-categories open">
                <div class="cat-header" onclick="toggleCategories(this)"><h3>Subjects Available</h3><span class="cat-toggle">‚ñº</span></div>
                <div class="cat-list" id="dynamic-cat-list">
                    <div style="color:#666; text-align:center; padding:20px;">Loading Subjects...</div>
                </div>
            </div>
            <div class="card-start-quiz" onclick="openQuizSettings()">
                <div class="start-icon">üöÄ</div><h3>Start Quiz</h3><p>Begin session with selected topics</p>
            </div>
        </div>
        <button class="btn-back-small" onclick="goBackToLearning()">‚Üê Back</button>
    </div>

    <div id="pomodoro-customization-view" class="hidden">
        <h2 id="pomodoro-custom-title">Customize Experience</h2>
        <div class="customization-container">
            <div class="custom-section card-categories open">
                   <div class="cat-header"><h3>Select Study Topics</h3></div>
                   <div class="cat-list">
                        <div class="subject-item special-select-all" onclick="toggleSelectAll(this)"><div class="custom-checkbox"></div> Select All</div>
                        <div class="subject-item" onclick="toggleCheck(this)"><div class="custom-checkbox"></div> Anatomy</div>
                        <div class="subject-item" onclick="toggleCheck(this)"><div class="custom-checkbox"></div> Pharmacology</div>
                   </div>
            </div>
            <div class="custom-section config-panel" style="display: flex; flex-direction: column; justify-content: center;">
                <div class="card-start-quiz" onclick="openPomodoroSession()">
                    <div class="start-icon">üçÖ</div>
                    <h3>Start Pomodoro Study</h3>
                    <p>Begin focused session</p>
                </div>
            </div>
        </div>
        <button class="btn-back-small" onclick="goBackToPomodoro()">‚Üê Back to Pomodoro Lab</button>
    </div>

    <div id="pomodoro-timer-view" class="hidden">
        <h2 style="color:#fff; margin-bottom:5px;">POMODORO FOCUS</h2>
        <div class="pomo-modes">
            <button class="mode-btn active" id="btn-classic" onclick="setPomodoroMode('classic')">Classic 25/5</button>
            <button class="mode-btn" id="btn-flow" onclick="setPomodoroMode('flow')">Flow 50/10</button>
        </div>
        <div class="pomo-container">
            <input type="text" class="pomo-task-input" placeholder="What are you studying?">
            <div class="pomo-cycles"><div class="cycle-dot" id="dot-1"></div><div class="cycle-dot" id="dot-2"></div><div class="cycle-dot" id="dot-3"></div><div class="cycle-dot" id="dot-4"></div></div>
            <div class="pomo-timer-display" id="timer-display">25:00</div>
            <div class="pomo-controls">
                <button class="pomo-btn main" onclick="toggleTimer()"><span id="play-icon">‚ñ∂</span></button>
                <button class="pomo-btn" onclick="resetTimer()">‚Ü∫</button>
            </div>
        </div>
        <div class="distraction-pad"><textarea class="distraction-input" placeholder="Distractions? Park them here... (Brain Dump)"></textarea></div>
        <button class="btn-back-small" onclick="goBackToPomodoro()">End Session</button>
    </div>

</div>

<div id="ai-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><div class="modal-title"><span id="ai-modal-icon">üß™</span><span id="ai-modal-title">AI Tutor</span></div><button class="close-btn" onclick="closeAIModal()">√ó</button></div><p id="ai-modal-desc" style="color:#aaa; font-size:0.9rem;">Ask any dental question.</p><textarea id="ai-input" class="ai-input-area" placeholder="E.g. Explain Amelogenesis..."></textarea><button id="ai-submit-btn" class="ai-action-btn" onclick="callGemini()"><span class="loader" id="ai-loader"></span><span id="ai-btn-text">Generate with AI ‚ú®</span></button><div id="ai-output" class="ai-response"></div></div></div>
<div id="quiz-settings-modal" class="modal-overlay quiz-settings-modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">‚öôÔ∏è Quiz Settings</div><button class="close-btn" onclick="closeQuizSettings()">√ó</button></div><p style="color:#aaa; margin-bottom:20px;">Configure your practice session.</p><label class="settings-label">Number of Questions:</label><select class="question-count-select" id="quiz-count"><option value="20">20 Questions</option><option value="25">25 Questions</option><option value="30">30 Questions</option><option value="50">50 Questions</option></select><button class="btn-start-confirm" onclick="startQuiz()">START NOW üöÄ</button></div></div>

<div id="date-setup-modal" class="modal-overlay active"><div class="modal-content"><div class="modal-header"><div class="modal-title">üìÖ Set Exam Date</div></div><p style="color:#aaa; margin-bottom:20px;">When is your INBDE exam?</p><input type="date" id="exam-date-input" class="date-input"><button class="btn-start-confirm" onclick="saveExamDate()">Start Prep üöÄ</button></div></div>

<div id="recovery-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header"><div class="modal-title">Set Permanent Password</div></div>
        <p style="color:#aaa; margin-bottom:20px;">Create a secure password to ensure you can log in next time.</p>
        <input type="password" id="new-password-input" class="input-pass" placeholder="New Password (min 6 chars)">
        <button class="btn-start-confirm" onclick="saveNewPassword()">Save & Re-Login</button>
        <button onclick="document.getElementById('recovery-modal').classList.remove('active')" style="background:none; border:none; color:#666; margin-top:15px; cursor:pointer;">Cancel</button>
    </div>
</div>

<script>
    // --- CONFIGURACI√ìN SUPABASE ---
    const SUPABASE_URL = 'https://arumiloijqsxthlswojt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFydW1pbG9panFzeHRobHN3b2p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MzUzNTEsImV4cCI6MjA3OTAxMTM1MX0.5EaB81wglbbtNi8FOzJoDMNd_aOmMULzm27pDClJDSg';
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allQuizzes = [];
    let userCompletedIds = new Set();
    let currentUser = null;
    const headerWelcome = document.getElementById('header-welcome-section');

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        initApp(); // Carga de datos y Auth
        initCountdown(); // L√≥gica de fechas
    });

    // --- 1. L√ìGICA DE AUTENTICACI√ìN & DATOS ---
    _supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === "PASSWORD_RECOVERY") {
            showRecoveryAlert();
        }
    });

    async function initApp() {
        const urlParams = new URLSearchParams(window.location.search);
        const isRecovery = urlParams.get('recovery') === 'true';

        if (isRecovery) {
            window.history.replaceState({}, document.title, "dashboard.html"); // Limpiar URL
            showRecoveryAlert();
        }

        // Verificar Sesi√≥n
        const { data: { session } } = await _supabase.auth.getSession();
        if (!session) {
            // Si no hay sesi√≥n, volver al index (login)
            // window.location.href = './index.html'; // COMENTADO PARA PRUEBAS SIN LOGIN
            console.log("Modo sin sesi√≥n activa (Pruebas)");
            currentUser = { id: 'test-user', user_metadata: { full_name: 'Test Doctor' }, email: 'test@inbde.com' };
        } else {
            currentUser = session.user;
        }
        
        // Mostrar Nombre
        const displayName = currentUser.user_metadata.full_name || currentUser.email.split('@')[0];
        document.getElementById('user-name-display').innerText = displayName;

        // Cargar Datos
        await loadData();
    }

    async function loadData() {
        try {
            // Descargar Quizzes y Progreso
            const quizzesReq = _supabase.from('contenido_quizzes').select('*').order('materia', { ascending: true });
            
            // Solo pedir progreso si hay usuario real
            let progressReq = Promise.resolve({ data: [] });
            if (currentUser.id !== 'test-user') {
                progressReq = _supabase.from('user_progress').select('quiz_id').eq('user_id', currentUser.id);
            }

            const [quizzesRes, progressRes] = await Promise.all([quizzesReq, progressReq]);

            if (quizzesRes.error) throw quizzesRes.error;

            allQuizzes = quizzesRes.data;
            if (progressRes.data) {
                userCompletedIds = new Set(progressRes.data.map(p => p.quiz_id));
            }
            console.log("Datos cargados correctamente:", allQuizzes.length, "quizzes.");
        } catch (err) {
            console.error("Error cargando datos:", err);
            // Fallback data para que funcione la UI si la tabla est√° vac√≠a o hay error
            if (allQuizzes.length === 0) {
                 allQuizzes = [
                    { materia: 'Anatomy', tipo: 'single' }, { materia: 'Pharmacology', tipo: 'single' },
                    { materia: 'Pathology', tipo: 'itemsets' }, { materia: 'Operative', tipo: 'simulation' }
                 ];
            }
        }
    }

    async function logout() {
        await _supabase.auth.signOut();
        window.location.href = './index.html';
    }

    // --- RECUPERACI√ìN DE CONTRASE√ëA ---
    function showRecoveryAlert() {
        const alertBox = document.createElement('div');
        alertBox.className = 'password-alert';
        alertBox.innerHTML = `‚ö†Ô∏è <strong>ACTION REQUIRED:</strong> You are using a temporary access link. <span style="text-decoration:underline; cursor:pointer; font-weight:800;" onclick="openRecoveryModal()">Click here to set password</span>.`;
        document.getElementById('password-alert-container').appendChild(alertBox);
        alertBox.style.display = 'block';
        setTimeout(() => { openRecoveryModal(); }, 800);
    }

    function openRecoveryModal() {
        document.getElementById('recovery-modal').classList.add('active');
    }

    async function saveNewPassword() {
        const newPass = document.getElementById('new-password-input').value;
        // Reemplazamos alert() por window.confirm() para evitar problemas en iframes
        if (!newPass || newPass.length < 6) {
            window.confirm("Password must be at least 6 characters long.");
            return;
        }
        const { data, error } = await _supabase.auth.updateUser({ password: newPass });
        if (error) {
            window.confirm("Error: " + error.message);
        } else {
            window.confirm("Password updated successfully! Please log in with your new credentials.");
            logout();
        }
    }

    // --- 2. NAVEGACI√ìN Y RENDERIZADO DIN√ÅMICO ---
    function showLearningLab() { switchView('learning-view'); }
    function showSimulationLab() { switchView('simulation-view'); }
    function showPomodoro() { switchView('pomodoro-view'); }
    function goBackToDashboard() { switchView('dashboard-content', true); }
    function goBackToLearning() { switchView('learning-view'); }
    function goBackToSimulation() { switchView('simulation-view'); }
    function goBackToPomodoro() { switchView('pomodoro-view'); }
    function startQuizEngine(mode) { window.location.href = `quiz_engine.html?mode=${mode}&count=10`; }

    // Mapeo de modos visuales a tipos en base de datos
    function openSelectionView(mode) { 
        let title = "";
        let filterType = "";
        let backFunc = null;

        if (mode === 'standalone') {
            title = "Stand Alone Questions";
            filterType = 'single';
            backFunc = goBackToLearning;
        } else if (mode === 'itemsets') {
            title = "Item Sets";
            filterType = 'itemsets';
            backFunc = goBackToLearning;
        } else if (mode === 'simulation') {
            title = "Custom Simulation";
            filterType = 'simulation';
            backFunc = goBackToSimulation;
        }

        document.getElementById('selection-mode-title').innerText = title;
        
        // Renderizar lista din√°mica basada en Supabase
        renderDynamicCategories(filterType);

        // Ajustar bot√≥n de retorno din√°micamente
        const btnBack = document.querySelector('#selection-view .btn-back-small');
        btnBack.onclick = backFunc;

        switchView('selection-view'); 
    }

    function renderDynamicCategories(filterType) {
        const container = document.getElementById('dynamic-cat-list');
        container.innerHTML = ''; // Limpiar lista anterior

        // Filtrar quizzes por tipo (simulado si tipo no coincide exactamente con DB actual)
        // Nota: Ajusta 'tipo' seg√∫n tus columnas reales de DB
        const filteredQuizzes = allQuizzes; //.filter(q => q.tipo === filterType);
        
        // Extraer materias √∫nicas
        const uniqueSubjects = [...new Set(filteredQuizzes.map(q => q.materia))];

        if (uniqueSubjects.length === 0) {
            container.innerHTML = '<div style="padding:15px; text-align:center; color:#666;">No content available for this mode yet.</div>';
            return;
        }

        // Bot√≥n "Select All"
        const selectAllDiv = document.createElement('div');
        selectAllDiv.className = 'subject-item special-select-all';
        selectAllDiv.onclick = function() { toggleSelectAll(this); };
        selectAllDiv.innerHTML = `<div class="custom-checkbox"></div> Select All Categories`;
        container.appendChild(selectAllDiv);

        // Generar items de materia
        uniqueSubjects.forEach(subject => {
            if(!subject) return; 
            const count = filteredQuizzes.filter(q => q.materia === subject).length;
            const item = document.createElement('div');
            item.className = 'subject-item';
            item.onclick = function() { toggleCheck(this); };
            item.innerHTML = `<div class="custom-checkbox"></div> ${subject} <span style="font-size:0.7em; margin-left:auto; opacity:0.5;">(${count})</span>`;
            item.dataset.subject = subject; // Guardar nombre para uso posterior
            container.appendChild(item);
        });
    }

    function openSimulationCustomization() { openSelectionView('simulation'); } // Reutilizamos la vista de selecci√≥n
    function openPomodoroCustomization() { switchView('pomodoro-customization-view'); }
    function openPomodoroSession() { switchView('pomodoro-timer-view'); resetTimer(); }

    function switchView(targetId, showHeader = false) {
        const views = ['dashboard-content', 'learning-view', 'simulation-view', 'pomodoro-view', 'selection-view', 'pomodoro-customization-view', 'pomodoro-timer-view'];
        let current = views.find(id => !document.getElementById(id).classList.contains('hidden'));
        
        if(current) {
            document.getElementById(current).classList.add('fade-out');
            setTimeout(() => {
                document.getElementById(current).classList.add('hidden');
                document.getElementById(current).classList.remove('fade-out');
                document.getElementById(targetId).classList.remove('hidden');
                document.getElementById(targetId).classList.add('fade-in');
                if(showHeader) headerWelcome.classList.remove('hidden');
                else headerWelcome.classList.add('hidden');
            }, 300);
        } else {
            document.getElementById(targetId).classList.remove('hidden');
        }
    }

    // --- DATE LOGIC ---
    function initCountdown() {
        const storedDate = localStorage.getItem('examDate');
        if (!storedDate) {
            document.getElementById('date-setup-modal').classList.add('active');
        } else {
            document.getElementById('date-setup-modal').classList.remove('active');
            updateDaysLeft(storedDate);
        }
    }

    function saveExamDate() {
        const dateInput = document.getElementById('exam-date-input').value;
        if (!dateInput) return window.confirm("Please select a date.");
        localStorage.setItem('examDate', dateInput);
        document.getElementById('date-setup-modal').classList.remove('active');
        updateDaysLeft(dateInput);
    }

    function updateDaysLeft(dateString) {
        const target = new Date(dateString);
        const today = new Date();
        const diffTime = target - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        const display = diffDays > 0 ? `${diffDays} Days Left` : "Exam Day!";
        document.getElementById('countdown-value').innerText = display;
    }

    function openDateModal() {
        document.getElementById('date-setup-modal').classList.add('active');
    }

    // --- UI INTERACTION HELPERS ---
    function toggleCategories(header) { header.parentElement.classList.toggle('open'); }
    function toggleCheck(item) { item.classList.toggle('active'); }
    function toggleSelectAll(source) {
        const isChecked = source.classList.contains('active');
        source.classList.toggle('active');
        const allItems = source.closest('.cat-list').querySelectorAll('.subject-item:not(.special-select-all)');
        allItems.forEach(item => isChecked ? item.classList.remove('active') : item.classList.add('active'));
    }

    function openQuizSettings() { 
        // Verificar que haya algo seleccionado
        const selected = document.querySelectorAll('#dynamic-cat-list .subject-item.active:not(.special-select-all)');
        if(selected.length === 0) {
            window.confirm("Please select at least one subject.");
            return;
        }
        document.getElementById('quiz-settings-modal').classList.add('active'); 
    }
    function closeQuizSettings() { document.getElementById('quiz-settings-modal').classList.remove('active'); }
    
    function startQuiz() { 
        closeQuizSettings(); 
        const count = document.getElementById('quiz-count').value;
        const selectedSubjects = Array.from(document.querySelectorAll('#dynamic-cat-list .subject-item.active:not(.special-select-all)')).map(el => el.dataset.subject);
        
        if (selectedSubjects.length === 0) {
            window.confirm("Please select at least one subject.");
            return;
        }

        console.log("Starting Quiz:", {count, subjects: selectedSubjects});
        
        // FIX: Redirect to quiz_engine.html with parameters
        // Encoding subjects to ensure URL safety
        const subjectsParam = encodeURIComponent(selectedSubjects.join(','));
        window.location.href = `quiz_engine.html?mode=practice&count=${count}&subjects=${subjectsParam}`;
    }

    // --- POMODORO LOGIC (Manteniendo la existente) ---
    let timerInterval;
    let timeLeft = 1500; 
    let isRunning = false;
    let currentCycle = 0;
    let isBreak = false;
    let pMode = 'classic'; 

    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
        const s = (timeLeft % 60).toString().padStart(2, '0');
        document.getElementById('timer-display').innerText = `${m}:${s}`;
    }

    function toggleTimer() {
        const btn = document.getElementById('play-icon');
        if (isRunning) {
            clearInterval(timerInterval);
            btn.innerText = '‚ñ∂';
        } else {
            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateTimerDisplay();
                } else {
                    completeCycle();
                }
            }, 1000);
            btn.innerText = '‚ùö‚ùö';
        }
        isRunning = !isRunning;
    }

    function completeCycle() {
        clearInterval(timerInterval);
        isRunning = false;
        document.getElementById('play-icon').innerText = '‚ñ∂';
        window.confirm(isBreak ? "Break Over! Back to work." : "Time's up! Take a break.");
        if (!isBreak) {
            currentCycle++;
            updateDots();
            if (currentCycle >= 4) {
                isBreak = true;
                timeLeft = pMode === 'classic' ? 15 * 60 : 20 * 60; 
                currentCycle = 0; 
                updateDots(true); 
            } else {
                isBreak = true;
                timeLeft = pMode === 'classic' ? 5 * 60 : 10 * 60;
            }
        } else {
            isBreak = false;
            timeLeft = pMode === 'classic' ? 25 * 60 : 50 * 60;
        }
        updateTimerDisplay();
    }

    function updateDots(clear = false) {
        for (let i = 1; i <= 4; i++) {
            const dot = document.getElementById(`dot-${i}`);
            if (clear) dot.classList.remove('filled');
            else if (i <= currentCycle) dot.classList.add('filled');
        }
    }

    function resetTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        isBreak = false;
        document.getElementById('play-icon').innerText = '‚ñ∂';
        timeLeft = pMode === 'classic' ? 25 * 60 : 50 * 60;
        updateTimerDisplay();
    }

    function setPomodoroMode(mode) {
        pMode = mode;
        document.getElementById('btn-classic').classList.toggle('active', mode === 'classic');
        document.getElementById('btn-flow').classList.toggle('active', mode === 'flow');
        resetTimer();
    }

    // --- AI MODAL LOGIC (Placeholder) ---
    const modal = document.getElementById('ai-modal');
    const inputArea = document.getElementById('ai-input');
    const outputArea = document.getElementById('ai-output');
    
    function openAIModal(mode) {
        modal.classList.add('active'); 
        outputArea.style.display = 'none'; 
        outputArea.innerHTML = ''; 
        inputArea.value = '';
        if (mode === 'ia_search') {
            document.getElementById('ai-modal-title').textContent = "INBDE Pro IA";
            document.getElementById('ai-modal-desc').textContent = "Find questions instantly.";
        } else {
            document.getElementById('ai-modal-title').textContent = "AI Tutor";
            document.getElementById('ai-modal-desc').textContent = "Ask any dental question.";
        }
    }
    function closeAIModal() { modal.classList.remove('active'); }
    async function callGemini() {
        // L√≥gica de IA Placeholder
        window.confirm("AI Integration would trigger here.");
    }

    // --- L√ìGICA DAILY RUN (ALEATORIO DIARIO) ---

    // 1. Generador de n√∫meros aleatorios con semilla (para que sea igual todo el d√≠a)
    function seededRandom(seed) {
        var m = 0x80000000;
        var a = 1103515245;
        var c = 12345;
        var state = seed ? seed : Math.floor(Math.random() * (m - 1));
        return function() {
            state = (a * state + c) % m;
            return state / (m - 1);
        }
    }

    // 2. Convertir string (fecha) a n√∫mero hash
    function hashCode(str) {
        var hash = 0;
        for (var i = 0; i < str.length; i++) {
            var character = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + character;
            hash = hash & hash; 
        }
        return Math.abs(hash);
    }

    // 3. Funci√≥n Principal del Daily Run
    function startDailyRun() {
        if (!allQuizzes || allQuizzes.length === 0) {
            // Si los datos a√∫n no cargan, intentamos esperar o avisar
            if(confirm("Data is loading. Click OK to try fetching again or Cancel to wait.")) {
                 loadData().then(startDailyRun);
            }
            return;
        }

        // A. Filtrar solo preguntas 'Stand Alone' (tipo 'single' o null, excluyendo itemsets/simulaciones)
        // Nota: Ajusta la l√≥gica 'q.tipo' seg√∫n c√≥mo est√©n guardados en tu Supabase real.
        const standAloneQuestions = allQuizzes.filter(q => 
            q.tipo !== 'itemsets' && q.tipo !== 'simulation'
        );

        if (standAloneQuestions.length < 10) {
            alert("Not enough questions in database for a Daily Run (Need 10).");
            return;
        }

        // B. Generar Semilla basada en la fecha local (YYYY-MM-DD)
        // Esto asegura que "Random" sea igual para todos los intentos del mismo d√≠a.
        const todayStr = new Date().toLocaleDateString('en-CA'); // Formato YYYY-MM-DD
        const seed = hashCode(todayStr);
        const rng = seededRandom(seed);

        // C. Mezclar el array (Shuffle) usando el RNG con semilla
        let shuffled = [...standAloneQuestions]; // Copia para no da√±ar el orden original
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(rng() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }

        // D. Tomar las primeras 10
        const selected10 = shuffled.slice(0, 10);
        
        // E. Extraer los IDs y pasarlos a la URL
        const selectedIds = selected10.map(q => q.id).join(',');

        console.log("Starting Daily Run for:", todayStr, "Questions:", selectedIds);

        // F. Redirigir al motor de quiz
        // Pasamos 'mode=daily' y un nuevo par√°metro 'ids' que el motor deber√° leer
        window.location.href = `quiz_engine.html?mode=daily&count=10&ids=${selectedIds}`;
    }
</script>

</body>
</html>
