<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INBDE Pro - Oral Pathology Quiz</title>
<style>
    /* --- CSS VARIABLES --- */
    :root {
        --primary-color: #fcdc11; --primary-dark: #121212; --light-bg: #f3f4f6;
        --white: #ffffff; --border-color: #e5e7eb; --correct-bg: #e6fcf5;
        --correct-border: #22c55e; --correct-text: #15803d; --incorrect-bg: #fff5f5;
        --incorrect-border: #ef4444; --incorrect-text: #b91c1c; --text-muted: #6b7280;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background-color: var(--light-bg); color: var(--primary-dark);
        margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh;
        box-sizing: border-box;
    }

    .quiz-wrapper {
        display: flex; flex-direction: column; width: 1200px; max-width: 100%;
        background-color: var(--white); box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color);
        position: relative; min-height: 80vh;
    }

    /* HEADER */
    .brand-header {
        background-color: var(--primary-dark); color: var(--primary-color);
        padding: 15px 20px; font-weight: 800; font-size: 1.1em;
        border-bottom: 4px solid var(--primary-color);
        display: flex; justify-content: space-between; align-items: center;
        flex-wrap: wrap; gap: 10px;
    }

    .header-right { display: flex; align-items: center; gap: 15px; font-size: 0.9em; color: white; }
    .timer-box { background: rgba(255,255,255,0.15); padding: 5px 10px; border-radius: 4px; font-family: monospace; font-weight: 700; letter-spacing: 1px; }
    .question-counter { color: var(--white); font-weight: 600; }
    .btn-stats-link { background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 5px 10px; font-size: 0.8em; font-weight: 700; cursor: pointer; border-radius: 4px; text-decoration: none; text-transform: uppercase; transition: background 0.2s; }
    .btn-stats-link:hover { background-color: rgba(252, 220, 17, 0.2); }

    /* VISTAS */
    .view-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; flex: 1; overflow-y: auto; }
    #welcome-view { display: flex; } 
    #quiz-view { display: none; flex-direction: row; flex: 1; overflow: hidden; } 
    #results-view { display: none; }

    /* SIDEBAR & MAIN */
    .sidebar { width: 300px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; background-color: #fafafa; overflow-y: auto; }
    .main-content { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; background: var(--white); }

    /* WELCOME */
    .welcome-title { font-size: 2.5em; margin-bottom: 10px; line-height: 1.2; }
    .welcome-subtitle { font-size: 1.2em; color: var(--text-muted); margin-bottom: 30px; }
    .info-pill { background: #f3f4f6; padding: 8px 20px; border-radius: 30px; font-weight: 600; border: 1px solid var(--border-color); display: inline-block; margin: 5px; }
    .user-input { padding: 12px; width: 100%; max-width: 300px; font-size: 1em; border: 2px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; text-align: center; }
    .btn-start { background-color: var(--primary-color); color: var(--primary-dark); padding: 14px 40px; font-size: 1.2em; font-weight: 800; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s; }
    .btn-start:hover { transform: translateY(-2px); }

    /* QUIZ COMPONENTS */
    .toggle-buttons { padding: 10px; display: flex; gap: 10px; justify-content: center; border-bottom: 1px solid var(--border-color); background: #fff; }
    .btn-toggle { background: var(--white); border: 1px solid var(--primary-dark); padding: 6px 12px; font-weight: 700; cursor: pointer; font-size: 0.8em; }
    .btn-toggle:hover:not(.disabled-btn) { background-color: var(--primary-color); }
    .btn-toggle.disabled-btn { opacity: 0.3; cursor: not-allowed; }

    .info-block { border-bottom: 1px solid var(--border-color); }
    .info-header { background-color: #e5e7eb; padding: 8px 15px; font-weight: 700; font-size: 0.85em; text-transform: uppercase; }
    .info-content { padding: 15px; font-size: 0.95em; line-height: 1.5; color: #333; }

    .scoreboard { display: flex; flex-wrap: wrap; gap: 15px; background-color: #f8f9fa; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; margin-bottom: 20px; font-weight: 600; font-size: 0.9em; }
    .score-item { display: flex; align-items: center; gap: 6px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; }
    .dot.gray { background: #ccc; } .dot.green { background: #22c55e; } .dot.red { background: #ef4444; }

    .question-text { font-size: 1.2em; font-weight: 600; margin-bottom: 20px; line-height: 1.5; }
    .options-list { display: flex; flex-direction: column; gap: 10px; }
    .option { display: flex; align-items: center; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 1em; transition: all 0.2s; background: white; }
    .option:hover:not(.disabled) { border-color: var(--primary-dark); background-color: #fffce0; }
    .option-circle { height: 24px; width: 24px; min-width: 24px; border-radius: 50%; border: 2px solid #9ca3af; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white; }
    
    .option.correct-answer { background-color: var(--correct-bg); border-color: var(--correct-border); color: var(--correct-text); font-weight: 600; }
    .option.correct-answer .option-circle { border-color: var(--correct-border); background-color: var(--correct-border); content: "‚úì"; }
    .option.wrong-answer { background-color: var(--incorrect-bg); border-color: var(--incorrect-border); color: var(--incorrect-text); }
    .option.wrong-answer .option-circle { border-color: var(--incorrect-border); background-color: var(--incorrect-border); }
    .option.disabled { pointer-events: none; opacity: 0.8; }

    .feedback-message { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: 700; text-align: center; display: none; }
    .feedback-message.success { background: var(--correct-bg); color: var(--correct-text); border: 1px solid var(--correct-border); }
    .feedback-message.error { background: var(--incorrect-bg); color: var(--incorrect-text); border: 1px solid var(--incorrect-border); }
    .time-badge { display: block; font-size: 0.8em; font-weight: 400; margin-top: 5px; opacity: 0.8; }

    .btn-next { background-color: var(--primary-dark); color: var(--primary-color); padding: 12px 30px; border: none; border-radius: 6px; font-size: 1em; font-weight: 700; cursor: pointer; margin-top: 20px; display: none; width: 100%; }

    /* RESULTS */
    .score-card { background-color: var(--primary-dark); color: var(--white); padding: 30px; border-radius: 12px; width: 100%; max-width: 400px; margin-bottom: 20px; }
    .score-number { font-size: 4em; font-weight: 900; color: var(--primary-color); display: block; margin: 10px 0; }
    .final-time-value { font-family: monospace; font-size: 1.4em; font-weight: bold; }
    .review-list { width: 100%; text-align: left; display: flex; flex-direction: column; gap: 15px; }
    .review-item { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; background: #fff; }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; text-transform: uppercase; }
    .badge.correct { background: var(--correct-bg); color: var(--correct-text); }
    .badge.incorrect { background: var(--incorrect-bg); color: var(--incorrect-text); }
    .explanation-box { display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-left: 4px solid var(--primary-color); font-size: 0.9em; }

    /* RESPONSIVE */
    @media (max-width: 768px) {
        body { padding: 0; }
        .quiz-wrapper { border-radius: 0; border: none; height: 100vh; }
        #quiz-view { flex-direction: column; }
        .sidebar { width: 100%; height: auto; max-height: 35vh; border-right: none; border-bottom: 2px solid var(--primary-color); }
        .main-content { padding: 20px; }
        .brand-header { padding: 10px 15px; font-size: 0.9em; }
        .btn-start { width: 100%; padding: 15px; }
    }
    
    /* MODAL */
    .modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
    .modal-content img { max-width: 95vw; max-height: 80vh; border: 2px solid #fff; border-radius: 4px; }
    .close-btn { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 40px; cursor: pointer; }
    .brand-footer { padding: 10px; text-align: center; font-weight: 600; border-top: 1px solid var(--border-color); background: #fafafa; font-size: 0.8em; }
</style>
</head>
<body>

<div class="quiz-wrapper">
    <div class="brand-header">
        <span class="header-left">INBDE Pro - Oral Pathology</span>
        <div class="header-right">
            <span id="timer" class="timer-box" style="display:none;">30:00</span>
            <span id="question-counter" class="question-counter" style="display:none;">Question 1 of 25</span>
            <a href="dashboard.html" class="btn-stats-link">üè† Home</a>
        </div>
    </div>

    <div id="welcome-view" class="view-container">
        <div class="welcome-card">
            <h1 class="welcome-title">Oral Pathology I</h1>
            <p class="welcome-subtitle">Cysts, Tumors & Bone Lesions</p>
            <input type="hidden" id="username-input">
            <div class="welcome-info">
                <span class="info-pill">üìù 25 Questions</span>
                <span class="info-pill">‚è±Ô∏è 30 Minutes</span>
            </div>
            <button class="btn-start" onclick="startQuiz()">START QUIZ</button>
        </div>
    </div>

    <div id="quiz-view">
        <div class="sidebar">
            <div class="toggle-buttons">
                <button class="btn-toggle" id="btn-xray" onclick="openImage('xray')">X-RAYS</button>
                <button class="btn-toggle" id="btn-photo" onclick="openImage('photo')">PHOTOS</button>
            </div>
            <div class="info-block"><div class="info-header">Patient</div><div class="info-content" id="sidebar-patient">...</div></div>
            <div class="info-block"><div class="info-header">Chief Complaint</div><div class="info-content" id="sidebar-cc">...</div></div>
            <div class="info-block"><div class="info-header">History</div><div class="info-content" id="sidebar-history">...</div></div>
            <div class="info-block"><div class="info-header">Current Findings</div><div class="info-content" id="sidebar-findings">...</div></div>
        </div>
        <div class="main-content">
            <div class="scoreboard">
                <div class="score-item"><span class="dot gray"></span>Ans: <span id="score-answered">0</span></div>
                <div class="score-item"><span class="dot green"></span>Correct: <span id="score-correct">0</span></div>
                <div class="score-item"><span class="dot red"></span>Wrong: <span id="score-incorrect">0</span></div>
            </div>
            <div class="question-text" id="question-text">Loading...</div>
            <div class="options-list" id="options-container"></div>
            <div id="feedbackDisplay" class="feedback-message"></div>
            <button class="btn-next" id="btn-next" onclick="nextQuestion()">Next Question ‚Üí</button>
        </div>
    </div>

    <div id="results-view" class="view-container">
        <div class="score-card">
            <h2>Quiz Complete</h2>
            <span class="score-number" id="final-score">0%</span>
            <p id="score-text">...</p>
            <div class="final-time-container">
                <span class="final-time-label">Total Time</span>
                <span id="final-time-value" class="final-time-value">0m 0s</span>
            </div>
        </div>
        <h3>Review Answers</h3>
        <div class="review-list" id="review-list"></div>
        <a href="dashboard.html" class="btn-start" style="margin-top:30px; text-decoration:none; display:block;">Back to Dashboard</a>
    </div>
    <div class="brand-footer">INBDE Pro</div>
</div>

<div id="image-modal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <img id="modal-img" src="" alt="Clinical Image">
        <div id="modal-caption" class="modal-caption" style="color:#fff; margin-top:10px;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // 1. CONFIGURACI√ìN INICIAL (UNA SOLA VEZ)
    const SUPABASE_URL = 'https://arumiloijqsxthlswojt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFydW1pbG9panFzeHRobHN3b2p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MzUzNTEsImV4cCI6MjA3OTAxMTM1MX0.5EaB81wglbbtNi8FOzJoDMNd_aOmMULzm27pDClJDSg';
    
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// --- DATA (25 QUESTIONS - ORAL PATHOLOGY) ---
const questions = [
    { 
        id: 1, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 22 years old", cc: "\"Check up.\"", history: "No pain.", findings: "Impacted #32." }, 
        text: "A routine panoramic radiograph reveals a well-defined, unilocular radiolucency surrounding the crown of an unerupted mandibular third molar. The lesion appears to displace the adjacent tooth. What is the MOST LIKELY diagnosis?", 
        options: ["Periapical Cyst", "Dentigerous Cyst", "Eruption Cyst", "Lateral Periodontal Cyst"], 
        correct: 1, 
        explanation: "A dentigerous cyst typically surrounds the crown of an unerupted or partially erupted tooth, most commonly in the mandibular third molar region." 
    },
    { 
        id: 2, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Female, 6 years old", cc: "\"Blue bump on gum.\"", history: "Tooth erupting.", findings: "Soft swelling." }, 
        text: "A young child presents with a soft, fluid-filled, bluish swelling on the gingiva overlying an erupting permanent first molar. The radiograph shows a radiolucency associated with the unerupted tooth. What is the indicated treatment?", 
        options: ["Surgical enucleation", "Marsupialization", "No intervention needed", "Antibiotic therapy"], 
        correct: 2, 
        explanation: "This describes an Eruption Cyst. Treatment typically involves no intervention as it usually resolves on its own after the tooth erupts." 
    },
    { 
        id: 3, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 35 years old", cc: "\"Jaw feels swollen.\"", history: "Recurrent swelling.", findings: "Expansile lesion." }, 
        text: "A radiograph reveals a well-defined, multilocular radiolucency with a 'soap bubble' appearance in the posterior mandible. Histopathology indicates the lesion is derived from the dental lamina. Which condition is MOST LIKELY?", 
        options: ["Odontogenic Keratocyst (OKC)", "Dentigerous Cyst", "Traumatic Bone Cyst", "Periapical Cyst"], 
        correct: 0, 
        explanation: "The Odontogenic Keratocyst (OKC) is characterized by a 'soap bubble' or 'honeycomb' appearance and arises from the dental lamina." 
    },
    { 
        id: 4, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Female, 45 years old", cc: "\"Routine exam.\"", history: "Asymptomatic.", findings: "Radiolucency between roots." }, 
        text: "A small, well-defined, unilocular radiolucency is discovered adjacent to the lateral root surface of a vital mandibular premolar. The patient is asymptomatic. What is the MOST LIKELY diagnosis?", 
        options: ["Periapical Cyst", "Lateral Periodontal Cyst", "Dentigerous Cyst", "Gingival Cyst"], 
        correct: 1, 
        explanation: "Lateral Periodontal Cysts are typically found in the mandibular premolar-canine region, adjacent to the root of a vital tooth." 
    },
    { 
        id: 5, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 28 years old", cc: "\"Tooth discoloration.\"", history: "Trauma years ago.", findings: "Non-vital #8." }, 
        text: "A periapical cyst is an inflammatory cyst that is MOST LIKELY caused by which of the following?", 
        options: ["Remnants of the dental lamina", "Necrosis of pulp tissue", "Trauma without pulp death", "Impacted teeth"], 
        correct: 1, 
        explanation: "The etiology of a Periapical (Radicular) Cyst is inflammation due to the necrosis of pulp tissue." 
    },
    { 
        id: 6, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 55 years old", cc: "\"Missing tooth area.\"", history: "Extraction 5 years ago.", findings: "Radiolucency in edentulous area." }, 
        text: "A well-defined radiolucency is noted at the site of a previous tooth extraction. The patient reports the tooth had a 'cyst' that was not removed when the tooth was pulled. This lesion is known as a:", 
        options: ["Residual Cyst", "Primordial Cyst", "Dentigerous Cyst", "Traumatic Bone Cyst"], 
        correct: 0, 
        explanation: "A Residual Cyst arises from remnants of a periapical cyst that were left behind after a tooth extraction." 
    },
    { 
        id: 7, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Female, 40 years old", cc: "\"Lip swelling.\"", history: "Slow growth.", findings: "Swelling near nose." }, 
        text: "A patient presents with swelling of the upper lip near the nasolabial fold. Radiographs show no bony changes, but the maxillary lateral incisor appears slightly displaced. What is the MOST LIKELY diagnosis?", 
        options: ["Nasopalatine Duct Cyst", "Nasolabial Cyst", "Globulomaxillary Cyst", "Periapical Cyst"], 
        correct: 1, 
        explanation: "Nasolabial Cysts present as soft tissue swelling in the upper lip/nasolabial fold and are typically not seen on radiographs." 
    },
    { 
        id: 8, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 30 years old", cc: "\"Check X-ray.\"", history: "No pain.", findings: "Pear-shaped lesion." }, 
        text: "Which of the following cysts presents radiographically as a well-defined, pear-shaped radiolucency located between the roots of the maxillary lateral incisor and canine?", 
        options: ["Nasopalatine Duct Cyst", "Globulomaxillary Cyst", "Lateral Periodontal Cyst", "Incise Canal Cyst"], 
        correct: 1, 
        explanation: "The Globulomaxillary Cyst is classically described as a pear-shaped radiolucency between the maxillary lateral incisor and canine." 
    },
    { 
        id: 9, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 45 years old", cc: "\"Salty taste.\"", history: "Midline palate swelling.", findings: "Heart-shaped lucency." }, 
        text: "A 45-year-old male presents with mild swelling in the midline of the hard palate. A radiograph shows an oval or heart-shaped radiolucency between the roots of the maxillary central incisors. The teeth are vital. Diagnosis?", 
        options: ["Nasolabial Cyst", "Median Palatal Cyst", "Nasopalatine Duct Cyst", "Periapical Cyst"], 
        correct: 2, 
        explanation: "The Nasopalatine Duct Cyst (Incisive Canal Cyst) appears as a heart-shaped radiolucency between the maxillary central incisors." 
    },
    { 
        id: 10, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Female, 18 years old", cc: "\"Lump in neck.\"", history: "Moves when swallowing.", findings: "Midline neck mass." }, 
        text: "A patient presents with a midline swelling of the neck near the thyroid cartilage. This is the most common congenital cyst of the neck. What is the etiology?", 
        options: ["Remnants of the dental lamina", "Remnants of the thyroglossal duct", "Obstruction of salivary glands", "Trauma"], 
        correct: 1, 
        explanation: "Thyroglossal Duct Cysts arise from remnants of the thyroglossal duct and present as midline neck swelling." 
    },
    { 
        id: 11, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 16 years old", cc: "\"Routine recall.\"", history: "Football injury last year.", findings: "Scalloped radiolucency." }, 
        text: "A panoramic radiograph of a teenager reveals a radiolucent area with a scalloped outline extending between the roots of the mandibular molars. The patient recalls trauma to the jaw a year ago. Diagnosis?", 
        options: ["Ameloblastoma", "Odontogenic Keratocyst", "Traumatic Bone Cyst", "Ossifying Fibroma"], 
        correct: 2, 
        explanation: "Traumatic Bone Cysts often appear as a well-defined radiolucency with a scalloped outline between roots and are associated with trauma." 
    },
    { 
        id: 12, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Female, 14 years old", cc: "\"Tooth hasn't come in.\"", history: "Anterior maxilla.", findings: "Lesion around canine." }, 
        text: "An Adenomatoid Odontogenic Tumor (AOT) is MOST LIKELY to occur in which of the following demographic and anatomical groups?", 
        options: ["Males, posterior mandible", "Females, anterior maxilla", "Females, posterior mandible", "Males, anterior maxilla"], 
        correct: 1, 
        explanation: "AOTs are more common in females (2nd decade) and typically occur in the anterior maxilla associated with an unerupted tooth." 
    },
    { 
        id: 13, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 20 years old", cc: "\"Check up.\"", history: "Asymptomatic.", findings: "Radiopaque mass." }, 
        text: "Which benign odontogenic tumor is characterized radiographically by a well-defined radiopaque mass containing tooth-like structures (enamel/dentin) surrounded by a radiolucent zone?", 
        options: ["Ameloblastoma", "Odontoma", "Cementoblastoma", "Osteoma"], 
        correct: 1, 
        explanation: "Odontomas appear as radiopaque masses with tooth-like structures (dentin, enamel) and are the most common benign odontogenic tumor." 
    },
    { 
        id: 14, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 25 years old", cc: "\"Painful molar.\"", history: "Vital tooth.", findings: "Radio-opacity on root." }, 
        text: "A patient complains of pain in the mandibular molar region. Radiographs show a well-defined radiopaque mass fused to the root of the tooth, surrounded by a radiolucent halo. What is the treatment?", 
        options: ["Root canal therapy only", "Extraction of the tooth and lesion", "Observation", "Antibiotics"], 
        correct: 1, 
        explanation: "Cementoblastoma presents as a painful mass fused to the root. Treatment requires extraction of the affected tooth and the lesion." 
    },
    { 
        id: 15, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Female, 50 years old", cc: "\"Soft bump on cheek.\"", history: "Yellowish hue.", findings: "Mobile mass." }, 
        text: "A painless, soft, mobile, and compressible mass is noted on the buccal mucosa. It is composed of benign adipose tissue. This lesion is a:", 
        options: ["Fibroma", "Lipoma", "Mucocele", "Ranula"], 
        correct: 1, 
        explanation: "Lipoma is a benign tumor of adipose (fat) tissue, described as soft, mobile, and compressible." 
    },
    { 
        id: 16, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 40 years old", cc: "\"Hard lump on jaw.\"", history: "Slow growing.", findings: "Bony hard." }, 
        text: "Radiographically, an Osteoma appears as a dense, radiopaque lesion within the bone. In which region is this rare lesion more commonly found?", 
        options: ["Anterior Mandible", "Craniofacial region", "Posterior Maxilla", "Sublingual space"], 
        correct: 1, 
        explanation: "Osteomas are rare and are more common in the craniofacial region." 
    },
    { 
        id: 17, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Female, 60 years old", cc: "\"Bumps on gums.\"", history: "Bilateral.", findings: "Lingual mandible." }, 
        text: "A patient presents with bony growths on the lingual aspect of the mandible. These are asymptomatic. What is the MOST LIKELY diagnosis?", 
        options: ["Osteoma", "Exostosis (Tori)", "Fibrous Dysplasia", "Cementoblastoma"], 
        correct: 1, 
        explanation: "Exostosis is a benign bony growth on the surface of the jaw, typically on the palate or buccal/lingual aspect of the mandible." 
    },
    { 
        id: 18, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Child, 10 years old", cc: "\"Swollen cheek.\"", history: "Asymptomatic.", findings: "Expansile bone." }, 
        text: "Which condition is a developmental abnormality where normal bone is replaced by fibrous tissue, showing a radiographic 'ground glass' appearance?", 
        options: ["Osteomyelitis", "Fibrous Dysplasia", "Condensing Osteitis", "Ameloblastoma"], 
        correct: 1, 
        explanation: "Fibrous Dysplasia is characterized by a 'ground glass' radiographic appearance and the replacement of bone with fibrous tissue." 
    },
    { 
        id: 19, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 45 years old", cc: "\"Severe jaw pain/fever.\"", history: "Dental infection.", findings: "Moth-eaten bone." }, 
        text: "A patient presents with pain, swelling, and fever. Radiographs reveal a radiolucency with a 'moth-eaten' appearance and periosteal reaction. What is the MOST LIKELY etiology?", 
        options: ["Trauma", "Infection of the bone", "Benign tumor", "Genetic mutation"], 
        correct: 1, 
        explanation: "Osteomyelitis is an infection of the bone (often secondary to dental infection) showing a 'moth-eaten' radiolucency." 
    },
    { 
        id: 20, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Female, 22 years old", cc: "\"Check up.\"", history: "Root canal on #30.", findings: "Dense bone at apex." }, 
        text: "Condensing Osteitis typically presents as a well-defined radiopaque lesion at the apex of a tooth. This condition is associated with:", 
        options: ["A vital tooth", "A non-vital tooth", "Trauma", "An unerupted tooth"], 
        correct: 1, 
        explanation: "Condensing Osteitis is seen at the apex of a non-vital tooth, caused by chronic low-grade infection." 
    },
    { 
        id: 21, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 35 years old", cc: "\"Jaw expansion.\"", history: "Slow growth.", findings: "Multilocular lesion." }, 
        text: "An Ameloblastoma is a benign but aggressive tumor. The recommended treatment involves surgical resection with wide margins. Where is this tumor MOST commonly located?", 
        options: ["Anterior Maxilla", "Posterior Maxilla", "Mandible (molar-ramus area)", "Anterior Mandible"], 
        correct: 2, 
        explanation: "Ameloblastoma is more common in the mandible, especially in the molar-ramus area." 
    },
    { 
        id: 22, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 29 years old", cc: "\"Swelling.\"", history: "Asymptomatic.", findings: "Honeycomb xray." }, 
        text: "Which odontogenic tumor arises from the odontogenic mesenchyme and presents radiographically as a multilocular radiolucency with a 'honeycomb' appearance?", 
        options: ["Odontogenic Myxoma", "Ameloblastoma", "Odontogenic Fibroma", "Cementoblastoma"], 
        correct: 0, 
        explanation: "Odontogenic Myxoma arises from odontogenic mesenchyme and shows a 'honeycomb' appearance." 
    },
    { 
        id: 23, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Female, 45 years old", cc: "\"Painless swelling.\"", history: "Posterior mandible.", findings: "Mixed lucency." }, 
        text: "Odontogenic Fibroma is a rare tumor that arises from the dental follicle. Its radiographic appearance is typically:", 
        options: ["Well-defined radiopacity", "Well-defined radiolucency, often with scattered radiopaque flecks", "Moth-eaten radiolucency", "Ground glass appearance"], 
        correct: 1, 
        explanation: "Odontogenic Fibroma presents as a well-defined radiolucency, often with scattered radiopaque flecks." 
    },
    { 
        id: 24, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Male, 15 years old", cc: "\"Blister on lip.\"", history: "Bit his lip.", findings: "Fluid filled." }, 
        text: "A teenager presents with a painless, bluish, soft swelling on the lower lip. The patient reports biting his lip recently. This lesion is MOST LIKELY a:", 
        options: ["Ranula", "Mucocele", "Lipoma", "Fibroma"], 
        correct: 1, 
        explanation: "A Mucocele is caused by the rupture of a minor salivary gland duct (often due to trauma like biting) and is common on the lower lip." 
    },
    { 
        id: 25, 
        images: { xray: null, photo: null }, 
        sidebar: { patient: "Child, 8 years old", cc: "\"Swelling under tongue.\"", history: "Bluish color.", findings: "Floor of mouth mass." }, 
        text: "Which cyst-like lesion is characterized by a bluish swelling on the floor of the mouth and is associated with the sublingual glands?", 
        options: ["Mucocele", "Ranula", "Dermoid Cyst", "Thyroglossal Duct Cyst"], 
        correct: 1, 
        explanation: "A Ranula is a bluish swelling on the floor of the mouth associated with the sublingual glands." 
    }
];

    let currentQuestionIndex = 0, userScore = 0, answeredCount = 0, correctCount = 0, incorrectCount = 0;
    let userAnswers = [], questionStartTime, timerInterval, totalTime = 30 * 60; // 30 min for 25 q
    let currentUser = "";

    function startQuiz() { 
        // Intentamos obtener el usuario de Supabase autom√°ticamente
        checkUserAndStart();
    }

    async function checkUserAndStart() {
        const { data: { session } } = await _supabase.auth.getSession();
        
        if (session) {
            currentUser = session.user.email;
            showView('quiz-view'); 
            loadQuestion(); 
            startTimer(); 
        } else {
            alert("Please log in to start.");
            window.location.href = 'index.html';
        }
    }

    function showView(viewId) {
        ['welcome-view', 'quiz-view', 'results-view'].forEach(id => document.getElementById(id).style.display = 'none');
        document.getElementById(viewId).style.display = (viewId === 'quiz-view') ? 'flex' : 'flex'; 
        
        const isQuiz = (viewId === 'quiz-view');
        document.getElementById('timer').style.display = isQuiz ? 'inline-block' : 'none';
        document.getElementById('question-counter').style.display = isQuiz ? 'inline-block' : 'none';
        
        if(viewId !== 'quiz-view') document.getElementById(viewId).style.display = 'flex';
    }

    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        const timerDisplay = document.getElementById('timer');
        function update() {
            const m = Math.floor(totalTime / 60);
            let s = totalTime % 60;
            timerDisplay.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            if (totalTime <= 0) { clearInterval(timerInterval); showResults(); } else { totalTime--; }
        }
        update();
        timerInterval = setInterval(update, 1000);
    }

    function loadQuestion() {
        const q = questions[currentQuestionIndex];
        questionStartTime = new Date(); 
        
        document.getElementById('question-counter').innerText = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
        
        document.getElementById('sidebar-patient').innerText = q.sidebar.patient || "";
        document.getElementById('sidebar-cc').innerText = q.sidebar.cc || "";
        document.getElementById('sidebar-history').innerText = q.sidebar.history || "";
        document.getElementById('sidebar-findings').innerText = q.sidebar.findings || "";

        const btnXray = document.getElementById('btn-xray');
        const btnPhoto = document.getElementById('btn-photo');
        if (q.images?.xray) { btnXray.classList.remove('disabled-btn'); btnXray.disabled = false; } else { btnXray.classList.add('disabled-btn'); btnXray.disabled = true; }
        if (q.images?.photo) { btnPhoto.classList.remove('disabled-btn'); btnPhoto.disabled = false; } else { btnPhoto.classList.add('disabled-btn'); btnPhoto.disabled = true; }

        document.getElementById('question-text').innerText = q.text;
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        document.getElementById('feedbackDisplay').style.display = 'none';
        document.getElementById('btn-next').style.display = 'none';

        q.options.forEach((opt, idx) => {
            const div = document.createElement('div');
            div.className = 'option';
            div.onclick = () => checkAnswer(div, idx);
            div.innerHTML = `<div class="option-circle"></div><span>${String.fromCharCode(65 + idx)}. ${opt}</span>`;
            container.appendChild(div);
        });
    }

    function checkAnswer(el, idx) {
        if (document.querySelector('.option.disabled')) return;
        
        const timeSpent = ((new Date() - questionStartTime) / 1000).toFixed(1);
        const q = questions[currentQuestionIndex];
        document.querySelectorAll('.option').forEach(o => o.classList.add('disabled'));

        const isCorrect = (idx === q.correct);
        userAnswers.push({ qIndex: currentQuestionIndex, selected: idx, isCorrect });
        answeredCount++;

        if (isCorrect) {
            correctCount++; userScore++;
            el.classList.add('correct-answer'); el.querySelector('.option-circle').innerText = '‚úì';
        } else {
            incorrectCount++;
            el.classList.add('wrong-answer'); el.querySelector('.option-circle').innerText = '‚úï';
            const correctEl = document.querySelectorAll('.option')[q.correct];
            correctEl.classList.add('correct-answer'); correctEl.querySelector('.option-circle').innerText = '‚úì';
        }
        document.getElementById('score-answered').innerText = answeredCount;
        document.getElementById('score-correct').innerText = correctCount;
        document.getElementById('score-incorrect').innerText = incorrectCount;
        
        const fb = document.getElementById('feedbackDisplay');
        fb.innerHTML = `${isCorrect ? "Correct! Well done." : "Incorrect."} <span class="time-badge">‚è±Ô∏è Time: ${timeSpent}s</span>`;
        fb.className = `feedback-message ${isCorrect ? 'success' : 'error'}`;
        fb.style.display = 'block';
        document.getElementById('btn-next').style.display = 'block';
    }

    function nextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < questions.length) loadQuestion(); else showResults();
    }

    function showResults() {
        clearInterval(timerInterval);
        showView('results-view');
        const pct = Math.round((userScore / questions.length) * 100);
        document.getElementById('final-score').innerText = pct + "%";
        document.getElementById('score-text').innerText = `You answered ${userScore} out of ${questions.length} correctly.`;
        
        const spent = (10 * 60) - totalTime;
        document.getElementById('final-time-value').innerText = `${Math.floor(spent/60)}m ${spent%60}s`;
        
        // Guardar progreso
        marcarExamenComoCompletado(); 

        const list = document.getElementById('review-list');
        list.innerHTML = '';
        userAnswers.forEach((ans, i) => {
            const q = questions[ans.qIndex];
            const item = document.createElement('div');
            item.className = 'review-item';
            item.innerHTML = `
                <div class="review-header"><span class="badge ${ans.isCorrect ? 'correct' : 'incorrect'}">${ans.isCorrect ? 'Correct' : 'Incorrect'}</span></div>
                <div class="review-question">${i+1}. ${q.text}</div>
                <div style="font-size:0.9em; margin-bottom:10px;">Correct Answer: <strong>${q.options[q.correct]}</strong></div>
                <button class="btn-explain" onclick="toggleExpl(${i})">Explanation</button>
                <div class="explanation-box" id="expl-${i}"><strong>Rationale:</strong><br>${q.explanation}</div>
            `;
            list.appendChild(item);
        });
    }

    async function marcarExamenComoCompletado() {
        // 1. Obtener ID del quiz de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const quizId = urlParams.get('quiz_id');

        // 2. Obtener usuario actual
        const { data: { session } } = await _supabase.auth.getSession();

        if (session && quizId) {
            console.log("Guardando progreso para usuario:", session.user.email);
            
            const { error } = await _supabase.from('user_progress').insert([
                { user_id: session.user.id, quiz_id: quizId }
            ]);

            if (!error) {
                console.log("Progreso guardado.");
            } else {
                console.error("Error guardando:", error);
            }
        } else {
            console.log("No se pudo guardar: Falta sesi√≥n o ID del quiz en la URL");
        }
    }

    function toggleExpl(i) {
        const b = document.getElementById(`expl-${i}`);
        b.style.display = b.style.display === 'block' ? 'none' : 'block';
    }

    function openImage(type) {
        const q = questions[currentQuestionIndex];
        if (!q.images || !q.images[type]) return;
        const modal = document.getElementById('image-modal');
        document.getElementById('modal-img').src = q.images[type];
        document.getElementById('modal-caption').innerText = type === 'xray' ? "Radiograph" : "Photo";
        modal.style.display = 'flex';
    }
    function closeModal() { document.getElementById('image-modal').style.display = 'none'; }
    document.addEventListener('keydown', e => { if (e.key === "Escape") closeModal(); });
    
    window.onload = () => {
        showView('welcome-view');
    };
</script>

</body>
</html>
