<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>INBDE Pro - Statistics Lab</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    /* --- 1. VARIABLES & BASE --- */
    :root {
        --accent: #facc15; 
        --accent-glow: rgba(250, 204, 21, 0.2);
        --bg-dark: #050505;
        --card-bg: #121214;
        --card-bg-hero: #1c1c20;
        --card-border: #27272a;
        --text-main: #ffffff;
        --text-muted: #a1a1aa;
        --success: #22c55e; 
        --danger: #ef4444; 
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        margin: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background-color: #000;
        color: var(--text-main);
        height: 100dvh;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        background: radial-gradient(circle at 50% 0%, #1a1830 0%, #000000 80%);
    }

    /* --- 2. LAYOUT --- */
    .lab-container {
        width: 100%;
        max-width: 600px;
        height: 100dvh;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--accent) #111;
    }

    /* --- 3. HEADER --- */
    .header-area {
        text-align: center;
        margin-bottom: 20px;
        flex-shrink: 0;
    }
    .lab-title { font-size: 1.8rem; font-weight: 900; text-transform: uppercase; margin: 0; color: #fff; }
    .lab-subtitle { color: var(--accent); font-weight: 600; font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; opacity: 0.9; }
    .user-badge { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; margin-top: 10px; display: inline-flex; }

    /* --- 4. CARDS --- */
    .stats-grid {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 100%;
    }

    /* Tarjeta Principal (Accuracy) */
    .card-promo-style {
        background: linear-gradient(180deg, rgba(30, 30, 35, 0.8) 0%, rgba(10, 10, 10, 0.9) 100%); 
        border: 1px solid var(--accent); border-radius: 16px; padding: 20px;
        text-align: center; position: relative; overflow: hidden;
    }
    .accuracy-display { font-size: 3.5rem; font-weight: 900; color: var(--accent); line-height: 1; text-shadow: 0 0 20px var(--accent-glow); }
    .card-label { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

    /* Grid 2x2 (Contadores) */
    .grid-2x2 {
        display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    .hero-card { 
        background: var(--card-bg-hero); border: 1px solid var(--card-border); border-radius: 14px; padding: 15px; 
        text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .hero-card .title { font-size: 1.5rem; font-weight: 800; color: #fff; margin: 0; }
    .hero-card .sub { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; }

    /* --- 5. SEMÁFORO / CONFIDENCE CARD --- */
    .card-confidence {
        background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px; padding: 20px;
        display: flex; flex-direction: column; align-items: center;
    }
    .confidence-header { width: 100%; text-align: left; margin-bottom: 15px; font-weight: 700; color: #fff; text-transform: uppercase; font-size: 0.9rem; border-bottom: 1px solid #333; padding-bottom: 10px; }
    
    .pie-chart {
        width: 140px; height: 140px; border-radius: 50%; margin: 10px auto; position: relative;
        background: conic-gradient(#333 0% 100%);
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        transition: background 1s ease;
    }
    .pie-chart::after {
        content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 100px; height: 100px; background: var(--card-bg); border-radius: 50%;
    }
    .pie-center-text {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        z-index: 2; text-align: center;
    }
    .pie-val { font-size: 1.5rem; font-weight: 900; color: #fff; }
    .pie-label { font-size: 0.6rem; color: #888; text-transform: uppercase; }

    .confidence-stats { display: flex; justify-content: space-around; width: 100%; margin-top: 15px; }
    .conf-item { text-align: center; }
    .conf-val { font-weight: 800; font-size: 1.1rem; }
    .conf-label { font-size: 0.65rem; text-transform: uppercase; color: #888; margin-top: 2px; }
    .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; }

    /* --- 6. CATEGORY LIST --- */
    .card-expandable {
        background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px; margin-bottom: 20px;
    }
    .expandable-header {
        padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;
    }
    .expandable-header h3 { margin: 0; font-size: 0.9rem; color: #fff; text-transform: uppercase; }
    .topic-list-container {
        display: none; padding: 0 20px 20px 20px; border-top: 1px solid var(--card-border);
    }
    .card-expandable.open .topic-list-container { display: block; animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .topic-item { padding: 10px 0; border-bottom: 1px solid #222; }
    .topic-row { display: flex; justify-content: space-between; font-size: 0.85rem; color: #ddd; margin-bottom: 5px; }
    .progress-track { width: 100%; height: 4px; background: #222; border-radius: 2px; }
    .progress-fill { height: 100%; background: var(--accent); border-radius: 2px; }

    /* --- 7. BUTTONS --- */
    .btn-start { 
        display: block; width: 100%; background: var(--accent); color: #000; font-weight: 900; padding: 15px; 
        border-radius: 12px; text-transform: uppercase; text-align: center; text-decoration: none; border: none; cursor: pointer;
        margin-top: auto;
    }
    .btn-back-link { display: block; text-align: center; color: #666; font-size: 0.8rem; margin-top: 15px; text-decoration: none; }

</style>
</head>
<body onload="loadStats()">

<div class="lab-container">
    
    <div class="header-area">
        <h1 class="lab-title">Performance Hub</h1>
        <div class="lab-subtitle">INBDE Pro Lab</div>
        <div class="user-badge" id="user-display">Loading...</div>
    </div>

    <div class="stats-grid">
        
        <div class="card-promo-style">
            <div class="card-label">Global Accuracy</div>
            <div id="accuracy-pct" class="accuracy-display">0%</div>
            <div class="card-label">Cumulative Score</div>
        </div>

        <div class="grid-2x2">
            <div class="hero-card">
                <div class="title" id="total-quizzes">0</div>
                <div class="sub">Categories</div>
            </div>
            <div class="hero-card">
                <div class="title" id="total-questions">0</div>
                <div class="sub">Questions</div>
            </div>
            <div class="hero-card" style="border-bottom: 2px solid var(--success);">
                <div class="title" id="total-correct" style="color:var(--success)">0</div>
                <div class="sub">Correct</div>
            </div>
            <div class="hero-card" style="border-bottom: 2px solid var(--danger);">
                <div class="title" id="total-incorrect" style="color:var(--danger)">0</div>
                <div class="sub">Incorrect</div>
            </div>
        </div>

        <div class="card-confidence">
            <div class="confidence-header">Performance</div>
            
            <div class="pie-chart" id="traffic-pie-chart">
                <div class="pie-center-text">
                    <div class="pie-val" id="total-mastered-display">0</div>
                    <div class="pie-label">Average</div>
                </div>
            </div>

            <div class="confidence-stats">
                <div class="conf-item">
                    <div class="conf-val" style="color:var(--danger)" id="count-learning">0</div>
                    <div class="conf-label"><span class="dot" style="background:var(--danger)"></span>Hard</div>
                </div>
                <div class="conf-item">
                    <div class="conf-val" style="color:var(--accent)" id="count-reviewing">0</div>
                    <div class="conf-label"><span class="dot" style="background:var(--accent)"></span>Medium</div>
                </div>
                <div class="conf-item">
                    <div class="conf-val" style="color:var(--success)" id="count-mastered">0</div>
                    <div class="conf-label"><span class="dot" style="background:var(--success)"></span>Easy</div>
                </div>
            </div>
        </div>

        <div class="card-expandable" id="topics-card" onclick="this.classList.toggle('open')">
            <div class="expandable-header">
                <h3>Categories</h3>
                <span>▼</span>
            </div>
            <div class="topic-list-container" id="topic-list-content">
                <div style="text-align:center; padding:10px; color:#666;">Loading...</div>
            </div>
        </div>

        <a href="quiz_engine.html?mode=standalone" class="btn-start">Start New Quiz</a>
        <a href="javascript:void(0)" onclick="goBack()" class="btn-back-link">← Back to Dashboard</a>

    </div>
</div>

<script src="app.js"></script>
<script>
    function goBack() {
        if (window.innerWidth <= 768) {
            window.location.href = 'mobile.html';
        } else {
            window.location.href = 'dashboard.html';
        }
    }

    async function loadStats() {
        if (typeof _supabase === 'undefined') {
            setTimeout(loadStats, 100); 
            return;
        }

        // --- GESTIÓN DE SESIÓN ---
        let { data: { session } } = await _supabase.auth.getSession();
        if (!session) {
            const { data: { user }, error } = await _supabase.auth.getUser();
            if (user) session = { user: user };
        }
        if (!session) {
             window.location.href = 'index.html';
             return;
        }

        const email = session.user.email;
        if(document.getElementById('user-display')) {
            document.getElementById('user-display').innerText = email.split('@')[0];
        }

        // --- NUEVA LÓGICA: FETCH DIRECTO CON JOIN A QUESTIONS_BANK ---
        // Esto asegura que usamos la columna 'category' real, no una vista antigua.
        const { data: attempts, error } = await _supabase
            .from('user_progress')
            .select(`
                status,
                questions_bank!inner (
                    category
                )
            `)
            .eq('user_id', session.user.id);

        if (error) {
            console.error("Error fetching stats:", error);
            return; // O manejar error visualmente
        }

        // --- CÁLCULOS MATEMÁTICOS EN CLIENTE ---
        let totalQuestions = 0;
        let totalCorrect = 0;
        
        let sumMastered = 0;   
        let sumReviewing = 0;  
        let sumLearning = 0;   
        
        const categoryMap = {}; // { 'Patología': {total: 10, correct: 5}, ... }

        if (attempts && attempts.length > 0) {
            attempts.forEach(row => {
                // Verificar integridad de datos
                if (row.questions_bank && row.questions_bank.category) {
                    const cat = row.questions_bank.category;
                    const status = row.status;
                    const isCorrect = (status === 'mastered'); // 'Mastered' cuenta como acierto para Accuracy

                    // Globales
                    totalQuestions++;
                    if (isCorrect) totalCorrect++;

                    if (status === 'mastered') sumMastered++;
                    else if (status === 'reviewing') sumReviewing++;
                    else if (status === 'learning') sumLearning++;

                    // Por Categoría
                    if (!categoryMap[cat]) {
                        categoryMap[cat] = { total: 0, correct: 0 };
                    }
                    categoryMap[cat].total++;
                    if (isCorrect) categoryMap[cat].correct++;
                }
            });
        }

        // Cálculos Finales
        const totalIncorrect = totalQuestions - totalCorrect;
        const accuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;

        // Convertir Mapa a Array para renderizar
        const topicList = Object.keys(categoryMap).map(key => ({
            name: key,
            pct: Math.round((categoryMap[key].correct / categoryMap[key].total) * 100)
        }));

        // --- ACTUALIZACIÓN DOM ---
        
        // 1. Contadores Globales
        // Total de categorías únicas encontradas en el historial
        document.getElementById('total-quizzes').innerText = Object.keys(categoryMap).length; 
        document.getElementById('total-questions').innerText = totalQuestions;
        document.getElementById('total-correct').innerText = totalCorrect;
        document.getElementById('total-incorrect').innerText = totalIncorrect;
        
        // 2. Lógica Color Accuracy (Rojo < 71%, Verde >= 71%)
        const accEl = document.getElementById('accuracy-pct');
        accEl.innerText = accuracy + "%";
        if (accuracy < 71) {
            accEl.style.color = "var(--danger)";
        } else {
            accEl.style.color = "var(--success)";
        }

        // 3. Semáforo y Gráfico
        document.getElementById('count-mastered').innerText = sumMastered;
        document.getElementById('count-reviewing').innerText = sumReviewing;
        document.getElementById('count-learning').innerText = sumLearning;
        document.getElementById('total-mastered-display').innerText = sumMastered;

        const totalTraffic = sumMastered + sumReviewing + sumLearning;
        if (totalTraffic > 0) {
            const pctRed = (sumLearning / totalTraffic) * 100;
            const pctYellow = (sumReviewing / totalTraffic) * 100;
            const pieEl = document.getElementById('traffic-pie-chart');
            pieEl.style.background = `conic-gradient(
                var(--danger) 0% ${pctRed}%, 
                var(--accent) ${pctRed}% ${pctRed + pctYellow}%, 
                var(--success) ${pctRed + pctYellow}% 100%
            )`;
        } else {
             document.getElementById('traffic-pie-chart').style.background = "#222";
        }

        renderTopics(topicList);
    }

    function renderTopics(list) {
        const container = document.getElementById('topic-list-content');
        if (list.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:10px; color:#666;">No data yet.</div>';
            return;
        }
        
        container.innerHTML = '';
        // Ordenar por porcentaje descendente
        list.sort((a,b) => b.pct - a.pct).forEach(topic => {
            // Siempre verde para la lista de categorías
            const color = "var(--success)"; 
            
            container.innerHTML += `
                <div class="topic-item">
                    <div class="topic-row">
                        <span>${topic.name}</span>
                        <span style="color:${color}; font-weight:bold;">${topic.pct}%</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" style="width:${topic.pct}%; background:${color};"></div>
                    </div>
                </div>
            `;
        });
    }
</script>
</body>
</html>
