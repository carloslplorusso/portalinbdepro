// ... (El resto de tu código de inicialización Load/Supabase se queda igual) ...

    // --- NUEVA FUNCIÓN INTELIGENTE DE RETORNO ---
    function goBackToDashboard() {
        // Detecta si la pantalla es menor a 1024px (Móvil/Tablet vertical)
        const isMobileScreen = window.innerWidth <= 1024;
        
        if (isMobileScreen) {
            window.location.href = 'mobile.html'; // UI Móvil
        } else {
            window.location.href = 'dashboard.html'; // UI Escritorio
        }
    }

    // --- PANTALLA FINAL DE RESULTADOS (ACTUALIZADA) ---
    function showFinalResults() {
        if (timerInterval) clearInterval(timerInterval);
        
        // 1. Ocultar interfaz del quiz
        document.getElementById('main-container-wrapper').classList.add('hidden');
        document.querySelector('.inbde-footer').classList.add('hidden'); 
        document.querySelector('.inbde-header')?.classList.add('hidden');
        document.getElementById('practice-header-el')?.classList.add('hidden');

        // 2. Mostrar contenedor de resultados
        const resultsView = document.getElementById('results-view');
        resultsView.classList.remove('hidden');
        resultsView.style.display = 'flex';

        // 3. Calcular estadísticas
        let totalCorrect = 0;
        let totalIncorrect = 0;
        srsCounters = { Learning: 0, Retrieving: 0, Mastered: 0 }; 

        quizData.forEach(q => {
            if (q.isCorrect) totalCorrect++;
            else if (q.userAnswer !== null) totalIncorrect++;

            if (q.srsRating && srsCounters.hasOwnProperty(q.srsRating)) {
                srsCounters[q.srsRating]++;
            }
        });

        // 4. Renderizar Tarjeta de Resumen
        const resultsContainer = document.querySelector('.final-results-container');
        const isDarkTheme = ['practice', 'daily', 'retry_mistakes', 'standalone', 'practice_custom'].includes(currentMode);

        if (isDarkTheme) {
            resultsContainer.innerHTML = `
                <h2 class="text-3xl font-black mb-8 text-white tracking-tight">Resultados</h2>
                <div class="flex justify-center items-center gap-12 mb-10">
                    <div class="flex flex-col items-center">
                        <span class="text-6xl font-black text-green-500" style="text-shadow: 0 0 20px rgba(34, 197, 94, 0.4);">${totalCorrect}</span>
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-2">Correctas</span>
                    </div>
                    <div class="h-16 w-px bg-gray-700"></div>
                    <div class="flex flex-col items-center">
                        <span class="text-6xl font-black text-red-500" style="text-shadow: 0 0 20px rgba(239, 68, 68, 0.4);">${totalIncorrect}</span>
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-2">Incorrectas</span>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3 w-full mb-2">
                    <div class="bg-red-900/20 border border-red-500/20 rounded-xl p-3 flex flex-col items-center">
                        <span class="text-2xl font-bold text-red-400">${srsCounters.Learning}</span>
                        <span class="text-[10px] uppercase font-bold text-red-300 mt-1">Learned</span>
                    </div>
                    <div class="bg-yellow-900/20 border border-yellow-500/20 rounded-xl p-3 flex flex-col items-center">
                        <span class="text-2xl font-bold text-yellow-400">${srsCounters.Retrieving}</span>
                        <span class="text-[10px] uppercase font-bold text-yellow-300 mt-1">Retrieving</span>
                    </div>
                    <div class="bg-green-900/20 border border-green-500/20 rounded-xl p-3 flex flex-col items-center">
                        <span class="text-2xl font-bold text-green-400">${srsCounters.Mastered}</span>
                        <span class="text-[10px] uppercase font-bold text-green-300 mt-1">Mastered</span>
                    </div>
                </div>
            `;
        } else {
            // Diseño Simulation (Claro)
            resultsContainer.innerHTML = `
                <h2 class="text-3xl font-bold mb-2 text-black">Quiz Completed!</h2>
                <p class="text-xl mb-4 text-gray-700">Total Score: ${totalCorrect} / ${quizData.length}</p>
            `;
        }

        // 5. Renderizar Lista de Revisión
        const reviewList = document.getElementById('review-list');
        reviewList.innerHTML = '';
        
        quizData.forEach((q, index) => {
            const isCorrect = q.isCorrect;
            const userAnswerText = q.options.find(opt => opt.id === q.userAnswer)?.text || "No Answered";
            const correctAnswerText = q.options.find(opt => opt.id === q.correctOption)?.text || "N/A";
            const srsTag = q.srsRating ? `<span class="ml-2 text-[10px] font-bold px-2 py-0.5 rounded text-black uppercase" style="background:${q.srsRating === 'Learning' ? '#fca5a5' : q.srsRating === 'Retrieving' ? '#fde047' : '#86efac'}">${q.srsRating}</span>` : '';
            
            const itemHTML = `
                <div class="review-item ${isCorrect ? 'correct-bg' : 'incorrect-bg'} p-5 rounded-xl mb-4 border border-gray-800 bg-[#121214]">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-sm text-gray-300">Question ${index + 1}</h4>
                        <div class="flex items-center">
                            ${isCorrect ? '<span class="text-green-400 font-bold text-sm">Correct ✅</span>' : '<span class="text-red-400 font-bold text-sm">Incorrect ❌</span>'}
                            ${srsTag}
                        </div>
                    </div>
                    <p class="mb-3 text-gray-100 font-medium text-lg leading-snug">${q.text}</p>
                    <div class="text-sm bg-black/30 p-3 rounded-lg border border-gray-800">
                        <p class="mb-1"><span class="text-gray-500">Tu respuesta:</span> <strong class="${isCorrect ? 'text-green-400' : 'text-red-400'}">${userAnswerText}</strong></p>
                        ${!isCorrect ? `<p><span class="text-gray-500">Correcta:</span> <strong class="text-green-400">${correctAnswerText}</strong></p>` : ''}
                    </div>
                    <button class="btn-explain-review w-full mt-3 bg-blue-600/20 text-blue-300 border border-blue-500/30 hover:bg-blue-600/40 transition py-2 rounded-lg" onclick="toggleReviewExplanation(this, ${index})">
                        Ver Explicación Completa
                    </button>
                    <div class="review-explanation-box hidden mt-3 p-4 bg-gray-900 border-l-4 border-blue-500 rounded-r-lg" id="review-expl-${index}">
                        <p class="text-gray-300 leading-relaxed text-sm">${q.explanation}</p>
                        <button class="mt-3 text-xs flex items-center gap-2 text-purple-400 hover:text-purple-300" onclick="triggerGeminiReview(${index})">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Ask AI Tutor
                        </button>
                        <div id="gemini-review-${index}" class="mt-2 text-sm text-gray-300 p-2 bg-purple-900/20 rounded border border-purple-500/20 hidden"></div>
                    </div>
                </div>
            `;
            reviewList.insertAdjacentHTML('beforeend', itemHTML);
        });

        // 6. Botones de Acción Final (AQUÍ ESTÁ LA MAGIA)
        const oldActions = document.getElementById('final-actions-row');
        if(oldActions) oldActions.remove();

        const actionContainer = document.createElement('div');
        actionContainer.id = 'final-actions-row';
        actionContainer.className = "mt-8 mb-12 flex flex-col gap-3";

        // Usamos onclick="goBackToDashboard()" en lugar de una URL fija
        actionContainer.innerHTML = `
            <button onclick="goBackToDashboard()" class="w-full py-4 bg-yellow-400 hover:bg-yellow-300 text-black font-black text-lg uppercase tracking-wide rounded-xl shadow-[0_0_20px_rgba(250,204,21,0.4)] transition transform active:scale-95 border-none cursor-pointer">
                Back to Home
            </button>
        `;
        
        document.querySelector('.max-w-4xl').appendChild(actionContainer);
        
        const oldBtn = document.querySelector('#results-view button.btn-start');
        if(oldBtn) oldBtn.style.display = 'none';
    }

    // --- ACTUALIZAR TAMBIÉN EL BOTÓN DEL FOOTER ---
    function finishQuiz() { 
        const isSimulation = !['practice', 'daily', 'retry_mistakes', 'standalone', 'practice_custom'].includes(currentMode);
        if (isSimulation) {
            showFinalResults();
        } else {
            if(window.confirm("Finish and exit?")) {
                goBackToDashboard(); // Usar la nueva función inteligente
            }
        }
    }
