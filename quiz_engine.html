<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INBDE Pro Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Base Reset */
        body { margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* --- MODO SIMULACIÓN (LIGHT) --- */
        body.sim-mode { background-color: #f0f0f0; color: #333; }
        body.sim-mode .inbde-header { background: #0060a9; color: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        body.sim-mode .inbde-footer { background: linear-gradient(to bottom, #0060a9 0%, #004b8d 100%); height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; position: fixed; bottom: 0; width: 100%; }
        body.sim-mode #main-container { display: flex; height: calc(100vh - 120px); margin-top: 0; }
        body.sim-mode #left-panel { width: 40%; background: white; border-right: 1px solid #ccc; padding: 15px; overflow-y: auto; }
        body.sim-mode #right-panel { width: 60%; background: white; padding: 20px; overflow-y: auto; }
        body.sim-mode .btn-glossy { background: linear-gradient(#4c96d7, #1a6cb0); color: white; border: 1px solid #0d4e85; padding: 8px 20px; font-weight: bold; cursor: pointer; }
        body.sim-mode .option-row { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; }
        body.sim-mode .option-row:hover { background: #f9f9f9; }
        body.sim-mode .option-row.selected { background: #dceefb; border-color: #0060a9; }
        body.sim-mode .mark-btn.active { background: #facc15; color: black; border-color: #eab308; }

        /* --- MODO PRÁCTICA (DARK) --- */
        body.practice-mode { background-color: #000; color: #fff; background: radial-gradient(circle at 50% 50%, #1a1830 0%, #000000 70%); }
        body.practice-mode .inbde-header, body.practice-mode .inbde-footer { display: none; } /* Hide Sim Bars */
        body.practice-mode #main-container { max-width: 800px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; padding: 20px; }
        body.practice-mode #left-panel { display: none; } /* No split screen in practice default */
        body.practice-mode #right-panel { width: 100%; background: transparent; }
        body.practice-mode .option-row { background: #121214; border: 1px solid #333; color: #ccc; padding: 20px; margin-bottom: 15px; border-radius: 12px; cursor: pointer; }
        body.practice-mode .option-row:hover { border-color: #555; }
        body.practice-mode .option-row.selected { border-color: #facc15; background: rgba(250,204,21,0.1); color: white; }
        body.practice-mode .option-row.correct { border-color: #22c55e; background: rgba(34,197,94,0.1); }
        body.practice-mode .option-row.wrong { border-color: #ef4444; background: rgba(239,68,68,0.1); }

        /* COMMON UTILS */
        .review-modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 50; display: none; justify-content: center; align-items: center; }
        .review-content { background: white; width: 80%; max-height: 80vh; overflow-y: auto; padding: 20px; border-radius: 8px; }
        .q-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; margin-top: 20px; }
        .q-box { width: 40px; height: 40px; border: 1px solid #ccc; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 0.8rem; }
        .q-box.answered { background: #dceefb; }
        .q-box.marked { border: 2px solid #facc15; font-weight: bold; }
        .q-box.current { border: 2px solid #0060a9; }

        /* RESULT SCREEN */
        .result-container { padding: 30px; text-align: center; background: #121214; color: white; border-radius: 20px; margin: 20px auto; max-width: 800px; }
        .ai-btn { background: linear-gradient(45deg, #7c3aed, #db2777); color: white; border: none; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body class="">

    <header class="inbde-header">
        <div style="width: 200px;">Question <span id="q-current">1</span> of <span id="q-total">--</span></div>
        <div class="font-bold text-center flex-1">INBDE Simulation</div>
        <div style="width: 200px; text-align: right;">Time: <span id="timer-display">--:--</span></div>
    </header>

    <div id="main-container">
        <div id="left-panel">
            <h3 class="font-bold border-b mb-2">Patient Profile</h3>
            <div id="patient-info">Loading case...</div>
        </div>

        <div id="right-panel">
            <div id="quiz-content">
                <p id="question-text" class="text-lg font-semibold mb-6">Loading Question...</p>
                <div id="options-container"></div>
            </div>
            
            <div id="result-screen" class="hidden result-container">
                <h1 class="text-3xl font-bold mb-6 text-yellow-400">Session Complete</h1>
                <div class="flex justify-center gap-10 mb-8">
                    <div><div class="text-5xl font-bold text-green-500" id="res-correct">0</div><div>Correct</div></div>
                    <div><div class="text-5xl font-bold text-red-500" id="res-incorrect">0</div><div>Incorrect</div></div>
                    <div><div class="text-5xl font-bold text-blue-500" id="res-score">0%</div><div>Score</div></div>
                </div>
                <button onclick="goBackToHome()" class="bg-yellow-400 text-black font-bold py-3 px-8 rounded-lg hover:bg-yellow-300 w-full max-w-md">BACK TO HOME</button>
                
                <div id="detailed-review" class="mt-10 text-left space-y-4"></div>
            </div>
        </div>
    </div>

    <footer class="inbde-footer">
        <button class="btn-glossy" onclick="prevQuestion()">Previous</button>
        <button class="btn-glossy mark-btn" id="btn-mark" onclick="toggleMark()">Mark</button>
        <button class="btn-glossy" onclick="openReviewModal()">Review (List)</button>
        <button class="btn-glossy" onclick="nextQuestion()">Next</button>
    </footer>

    <div id="review-modal" class="review-modal">
        <div class="review-content">
            <h2 class="text-xl font-bold text-black">Question Status</h2>
            <div class="q-grid" id="review-grid"></div>
            <div class="flex justify-end gap-4 mt-6">
                <button class="px-4 py-2 bg-gray-200 rounded text-black" onclick="closeReviewModal()">Keep Working</button>
                <button class="px-4 py-2 bg-red-600 text-white rounded font-bold" onclick="finishQuiz()">FINISH EXAM</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const SUPABASE_URL = 'https://arumiloijqsxthlswojt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFydW1pbG9panFzeHRobHN3b2p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MzUzNTEsImV4cCI6MjA3OTAxMTM1MX0.5EaB81wglbbtNi8FOzJoDMNd_aOmMULzm27pDClJDSg';
        const GEMINI_API_KEY = "AIzaSyCGdQ_3ZkPdqdtvM4TRa59t14ZxqDlxxlY"; // WARNING: Exposed Key
        const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // STATE
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'practice';
        const count = parseInt(urlParams.get('count')) || 10;
        
        let quizData = [];
        let currentIndex = 0;
        let markedQuestions = new Set();
        let userAnswers = {}; // { qId: optionId }
        let timerInterval;
        let secondsLeft = 0;

        // INIT
        document.addEventListener('DOMContentLoaded', async () => {
            setupUI();
            await loadQuestions();
            if(mode === 'simulation') startSimulationTimer();
        });

        function setupUI() {
            const body = document.body;
            if (mode === 'simulation') {
                body.classList.add('sim-mode');
                // Timer Logic: 1.2 min per question
                secondsLeft = Math.round(count * 1.2 * 60);
            } else {
                body.classList.add('practice-mode');
                document.getElementById('main-container').style.height = '100vh';
            }
        }

        async function loadQuestions() {
            // Simulación de carga desde DB (Aquí conectarías tu RPC real)
            const { data, error } = await _supabase.from('questions_bank').select('*').limit(count);
            
            if(error || !data) {
                alert("Error loading questions. Using backup data.");
                // Backup Data for testing
                quizData = Array.from({length: count}, (_, i) => ({
                    id: i, 
                    question_text: `Question ${i+1}: What is the primary cause of...?`,
                    option_a: "Option A", option_b: "Option B", option_c: "Option C", option_d: "Option D",
                    correct_answer: "Option A",
                    explanation: "This is the correct answer because..."
                }));
            } else {
                quizData = data;
            }

            document.getElementById('q-total').innerText = quizData.length;
            renderQuestion();
        }

        function renderQuestion() {
            const q = quizData[currentIndex];
            document.getElementById('q-current').innerText = currentIndex + 1;
            document.getElementById('question-text').innerText = q.question_text;
            document.getElementById('patient-info').innerText = "Patient: Adult Male\nHistory: No significant findings.\n(Case details would go here)";

            const opts = document.getElementById('options-container');
            opts.innerHTML = '';

            ['option_a', 'option_b', 'option_c', 'option_d'].forEach(optKey => {
                const optVal = q[optKey];
                const div = document.createElement('div');
                div.className = 'option-row';
                if (userAnswers[q.id] === optVal) div.classList.add('selected');
                
                div.innerHTML = `<div class="custom-radio"></div> ${optVal}`;
                div.onclick = () => selectOption(q.id, optVal);
                opts.appendChild(div);
            });

            // Update Mark Button
            const markBtn = document.getElementById('btn-mark');
            if (markedQuestions.has(currentIndex)) markBtn.classList.add('active');
            else markBtn.classList.remove('active');
        }

        function selectOption(qId, val) {
            userAnswers[qId] = val;
            renderQuestion(); // Re-render to show selection
        }

        function nextQuestion() {
            if(currentIndex < quizData.length - 1) {
                currentIndex++;
                renderQuestion();
            }
        }

        function prevQuestion() {
            if(currentIndex > 0) {
                currentIndex--;
                renderQuestion();
            }
        }

        function toggleMark() {
            if(markedQuestions.has(currentIndex)) markedQuestions.delete(currentIndex);
            else markedQuestions.add(currentIndex);
            renderQuestion();
        }

        // --- REVIEW MODAL ---
        function openReviewModal() {
            const grid = document.getElementById('review-grid');
            grid.innerHTML = '';
            quizData.forEach((q, idx) => {
                const box = document.createElement('div');
                box.className = 'q-box';
                box.innerText = idx + 1;
                if(userAnswers[q.id]) box.classList.add('answered');
                if(markedQuestions.has(idx)) box.classList.add('marked');
                if(idx === currentIndex) box.classList.add('current');
                box.onclick = () => { currentIndex = idx; renderQuestion(); closeReviewModal(); };
                grid.appendChild(box);
            });
            document.getElementById('review-modal').style.display = 'flex';
        }
        function closeReviewModal() { document.getElementById('review-modal').style.display = 'none'; }

        // --- TIMER ---
        function startSimulationTimer() {
            timerInterval = setInterval(() => {
                if(secondsLeft <= 0) {
                    clearInterval(timerInterval);
                    finishQuiz();
                } else {
                    secondsLeft--;
                    const m = Math.floor(secondsLeft / 60).toString().padStart(2, '0');
                    const s = (secondsLeft % 60).toString().padStart(2, '0');
                    document.getElementById('timer-display').innerText = `${m}:${s}`;
                }
            }, 1000);
        }

        // --- FINISH & RESULTS ---
        function finishQuiz() {
            clearInterval(timerInterval);
            document.querySelector('.inbde-header').classList.add('hidden');
            document.querySelector('.inbde-footer').classList.add('hidden');
            document.getElementById('main-container').style.display = 'block'; // Stack layout
            document.getElementById('left-panel').classList.add('hidden');
            document.getElementById('quiz-content').classList.add('hidden');
            document.getElementById('review-modal').style.display = 'none';
            
            // Calculate Results
            let correct = 0;
            let listHTML = '';

            quizData.forEach((q, idx) => {
                const userAns = userAnswers[q.id];
                const isCorrect = userAns === q.correct_answer;
                if(isCorrect) correct++;

                listHTML += `
                    <div class="bg-gray-800 p-4 rounded border border-gray-700">
                        <div class="font-bold text-white mb-2">Q${idx+1}: ${q.question_text}</div>
                        <div class="text-sm ${isCorrect ? 'text-green-400' : 'text-red-400'}">
                            Your Answer: ${userAns || 'Skipped'}
                        </div>
                        <div class="text-sm text-gray-400">Correct: ${q.correct_answer}</div>
                        <button class="ai-btn" onclick="askGemini(this, '${q.question_text}', '${q.correct_answer}')">✨ Explain with AI</button>
                        <div class="ai-response mt-2 text-gray-300 text-sm hidden"></div>
                    </div>
                `;
            });

            document.getElementById('res-correct').innerText = correct;
            document.getElementById('res-incorrect').innerText = quizData.length - correct;
            document.getElementById('res-score').innerText = Math.round((correct/quizData.length)*100) + "%";
            document.getElementById('detailed-review').innerHTML = listHTML;
            
            document.getElementById('result-screen').classList.remove('hidden');
        }

        async function askGemini(btn, qText, correct) {
            const outputDiv = btn.nextElementSibling;
            outputDiv.innerHTML = "Thinking...";
            outputDiv.classList.remove('hidden');
            
            const prompt = `Explain why "${correct}" is the correct answer for: "${qText}". Keep it concise for a dental student.`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                outputDiv.innerHTML = text.replace(/\*\*/g, '').replace(/\n/g, '<br>'); // Simple format
            } catch(e) {
                outputDiv.innerHTML = "Error contacting AI.";
            }
        }

        function goBackToHome() {
            if(window.innerWidth <= 768) window.location.href = 'mobile.html';
            else window.location.href = 'dashboard.html';
        }
    </script>
</body>
</html>
