<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INBDE Pro Lab Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style id="simulation-css">
        /* Base styles shared or specific to Simulation */
        body { 
            font-family: Arial, Helvetica, sans-serif; 
            background-color: #f0f0f0; 
            margin: 0;
        }

        /* --- INBDE SPECIFIC HEADER/FOOTER --- */
        .inbde-header {
            background-color: #0060a9;
            color: white;
        }
        .inbde-footer {
            background: linear-gradient(to bottom, #0060a9 0%, #004b8d 100%);
            border-top: 4px solid #004b8d;
        }

        /* Glossy Buttons */
        .btn-glossy {
            background: linear-gradient(to bottom, #4c96d7 0%, #1a6cb0 50%, #1a6cb0 100%);
            border: 1px solid #0d4e85;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), 0 2px 2px rgba(0,0,0,0.2);
            color: white;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 0.05em;
            text-shadow: 0 -1px 0 rgba(0,0,0,0.3);
            font-family: 'Arial Narrow', Arial, sans-serif;
        }
        .btn-glossy:hover { background: linear-gradient(to bottom, #5ba4e5 0%, #257bc4 50%, #257bc4 100%); }
        .btn-glossy:active { box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); transform: translateY(1px); }

        /* Tables & Tabs (Sim Mode) */
        .clinical-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .clinical-table th { background-color: #dceefb; color: #000; text-align: left; padding: 8px; border: 1px solid #888; font-weight: bold; }
        .clinical-table td { background-color: #fff; padding: 8px; border: 1px solid #888; vertical-align: top; color: #000; }

        .tab-btn { border: 1px solid #000; background-color: #fff; padding: 8px 16px; font-size: 13px; cursor: pointer; margin-right: 4px; border-bottom: none; position: relative; top: 1px; min-width: 100px; }
        .tab-btn.active { font-weight: bold; z-index: 10; border-bottom: 1px solid #fff; }
        .tab-btn.inactive { background-color: #e0e0e0; color: #555; }

        /* Option Styling (Default/Sim) */
        .option-row { display: flex; align-items: center; border: 1px solid #e0e0e0; background: white; padding: 12px; margin-bottom: 8px; border-radius: 4px; cursor: pointer; transition: all 0.1s; }
        .option-row:hover { border-color: #bbb; }
        .option-row.selected { background-color: #dceefb; border-color: #8fbce6; }
        
        .custom-radio { width: 18px; height: 18px; border: 1px solid #ccc; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; background: white; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        .option-row.selected .custom-radio { border-color: #0060a9; }
        .option-row.selected .custom-radio::after { content: ''; width: 10px; height: 10px; background-color: #0060a9; border-radius: 50%; }
    </style>

    <style id="practice-css" disabled>
        /* --- 1. VARIABLES & BASE --- */
        :root {
            --accent: #facc15; 
            --accent-glow: rgba(250, 204, 21, 0.15);
            --bg-dark: #050505;
            --card-bg: #121214;
            --card-bg-hero: #1c1c20;
            --card-border: #27272a;
            --text-main: #f4f4f5;
            --text-muted: #71717a;
            
            --success: #22c55e;
            --error: #ef4444;
            
            /* DIMENSIONES */
            --col-width: 200px;
            --sq-size: 190px;
        }

        /* Override Body for Dark Mode */
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
            background-color: #000 !important;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at 50% 50%, #1a1830 0%, #000000 70%) !important;
        }

        /* Hide Sim Elements in Practice Mode */
        .inbde-header, .inbde-footer { display: none !important; }

        /* --- PRACTICE LAYOUT ADAPTATION --- */
        .practice-header {
            display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; width: 100%;
            border-bottom: 1px solid var(--card-border); background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        }
        .practice-title { font-size: 1.5rem; font-weight: 900; text-transform: uppercase; letter-spacing: -1px; color: #fff; }
        .practice-subtitle { color: var(--accent); font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase; }

        /* Main Quiz Container Override */
        #main-container-wrapper {
            background: transparent !important; box-shadow: none !important; max-width: 1200px !important; margin: 0 auto; height: 100%;
        }

        #right-panel { width: 100% !important; background: transparent !important; color: var(--text-main) !important; border: none !important; }
        #question-text { color: #fff !important; font-size: 1.5rem !important; font-weight: 600 !important; line-height: 1.4 !important; }

        /* Option Cards Override (Dark Theme) */
        .option-row {
            background: var(--card-bg) !important; border: 1px solid var(--card-border) !important; color: var(--text-muted) !important;
            border-radius: 12px !important; padding: 20px !important; transition: all 0.3s !important;
        }
        .option-row:hover { transform: translateY(-2px); border-color: #52525b !important; background: #18181b !important; color: #fff !important; }
        .option-row.selected {
            background: linear-gradient(90deg, rgba(250, 204, 21, 0.1), transparent) !important; border-color: var(--accent) !important;
            color: #fff !important; box-shadow: 0 0 20px var(--accent-glow) !important;
        }
        
        /* VALIDATION STATES (CORRECT/INCORRECT) */
        .option-row.correct-answer {
            border-color: var(--success) !important; background: rgba(34, 197, 94, 0.1) !important; color: #fff !important;
        }
        .option-row.wrong-answer {
            border-color: var(--error) !important; background: rgba(239, 68, 68, 0.1) !important; color: #fff !important;
        }

        .custom-radio { background: transparent !important; border-color: var(--text-muted) !important; }
        .option-row.selected .custom-radio { border-color: var(--accent) !important; }
        .option-row.selected .custom-radio::after { background-color: var(--accent) !important; }
        
        .option-row.correct-answer .custom-radio { border-color: var(--success) !important; }
        .option-row.correct-answer .custom-radio::after { background-color: var(--success) !important; }
        .option-row.wrong-answer .custom-radio { border-color: var(--error) !important; }
        .option-row.wrong-answer .custom-radio::after { background-color: var(--error) !important; }

        /* Controls */
        .practice-controls { display: flex !important; gap: 20px; padding: 20px 0; margin-top: auto; justify-content: flex-end; }
        .btn-practice {
            background: var(--card-bg-hero); border: 1px solid var(--accent); color: var(--accent);
            padding: 12px 30px; border-radius: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn-practice:hover { background: var(--accent); color: #000; box-shadow: 0 0 20px var(--accent-glow); transform: translateY(-2px); }

        /* GEMINI BUTTON */
        .btn-gemini {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); border: 1px solid #a855f7; color: white;
            display: flex; align-items: center; gap: 8px; box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
            animation: pulse-gemini 2s infinite;
        }
        .btn-gemini:hover { transform: scale(1.05); filter: brightness(1.2); }
        @keyframes pulse-gemini { 0% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(168, 85, 247, 0); } 100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); } }

        /* SRS BUTTONS */
        .srs-container { display: flex; gap: 15px; width: 100%; justify-content: center; margin-top: 10px; }
        .btn-srs { flex: 1; padding: 15px; border-radius: 12px; font-weight: 800; text-transform: uppercase; color: #000; cursor: pointer; border: none; transition: transform 0.2s; max-width: 200px; }
        .btn-srs:hover { transform: translateY(-3px); filter: brightness(1.1); }
        .btn-learning { background: #ef4444; box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3); }
        .btn-retrieving { background: #eab308; box-shadow: 0 5px 15px rgba(234, 179, 8, 0.3); }
        .btn-mastered { background: #22c55e; box-shadow: 0 5px 15px rgba(34, 197, 94, 0.3); }

        /* Explanation Box Dark */
        #explanation-box { background: rgba(255,255,255,0.03) !important; border: 1px solid #333 !important; border-radius: 12px !important; color: #ccc !important; padding: 25px !important; }
        .gemini-response-box { background: linear-gradient(180deg, rgba(168, 85, 247, 0.1) 0%, rgba(0,0,0,0) 100%); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 8px; padding: 15px; margin-top: 15px; }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="inbde-header h-14 flex items-center justify-between px-4 shrink-0 shadow-md z-20">
        <div class="text-lg font-normal w-1/4">
            Question <span id="current-q-num">1</span> of <span id="total-q-num">--</span>
        </div>
        <div class="text-center flex flex-col justify-center w-2/4">
            <div class="text-sm font-bold tracking-wide">INBDE Pro Lab</div>
            <div id="mode-subtitle" class="text-xs text-blue-200">INBDE | Simulation Exam</div>
        </div>
        <div class="flex items-center justify-end gap-3 w-1/4">
            <div id="timer-container" class="text-lg">
                Time remaining: <span id="timer-display" class="font-mono">--:--:--</span>
            </div>
            <button class="text-white hover:text-blue-200"><i class="fa-solid fa-gear text-xl"></i></button>
        </div>
    </header>

    <header class="practice-header hidden" id="practice-header-el">
        <div>
            <h1 class="practice-title">INBDE Pro Lab</h1>
            <div class="practice-subtitle">Interactive Practice Mode</div>
        </div>
        <div class="flex items-center gap-4">
            <div class="header-countdown bg-yellow-900/30 text-yellow-400 border border-yellow-600/50 px-3 py-1 rounded-full text-xs font-bold">
                <i class="fa-solid fa-fire mr-1"></i> Streak: 3 Days
            </div>
            <button onclick="window.location.href='dashboard.html'" class="text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
    </header>

    <main id="main-container-wrapper" class="flex-1 flex overflow-hidden w-full max-w-7xl mx-auto bg-white shadow-xl">
        
        <section id="left-panel" class="w-[40%] flex flex-col border-r border-gray-300 bg-white p-4 overflow-hidden transition-all duration-300">
            <div class="flex border-b border-black mb-0 z-10">
                <button id="tab-photos" class="tab-btn inactive" onclick="switchTab('photos')">PHOTOS</button>
                <button id="tab-clinical" class="tab-btn active" onclick="switchTab('clinical')">CLINICAL EXAM</button>
            </div>
            <div class="border border-black border-t-0 flex-1 overflow-hidden relative bg-white">
                <div id="view-clinical" class="absolute inset-0 overflow-y-auto p-0 custom-scrollbar">
                    <table class="clinical-table">
                        <tr><th>Patient</th></tr>
                        <tr><td><div id="patient-info"></div></td></tr>
                        <tr><th>Chief Complaint</th></tr>
                        <tr><td><div id="chief-complaint"></div></td></tr>
                        <tr><th>Background and/or Patient History</th></tr>
                        <tr><td><div id="patient-history" class="space-y-1"></div></td></tr>
                        <tr><th>Current Findings</th></tr>
                        <tr><td><div id="current-findings"></div></td></tr>
                    </table>
                </div>
                <div id="view-photos" class="absolute inset-0 hidden bg-black flex items-center justify-center p-4">
                    <img id="case-image" src="" alt="Clinical Case Photo" class="max-w-full max-h-full object-contain">
                    <div id="no-photo-msg" class="text-white hidden">No photos available.</div>
                </div>
            </div>
        </section>

        <section id="right-panel" class="w-[60%] flex flex-col p-6 overflow-y-auto custom-scrollbar relative transition-all duration-300">
            
            <div class="max-w-4xl mx-auto w-full flex flex-col h-full"> 
                
                <div class="mb-6 fade-in">
                    <p id="question-text" class="text-lg text-gray-900 leading-snug">Loading...</p>
                </div>

                <div id="options-container" class="space-y-3 mb-8 fade-in" style="animation-delay: 0.1s;">
                    </div>

                <div id="explanation-box" class="hidden mt-6 fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-lg text-white">Explanation</h4>
                        
                        <button id="btn-explain-gemini" class="hidden btn-practice btn-gemini px-4 py-2 text-xs rounded-full" onclick="triggerGeminiExplanation()">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Explain this
                        </button>
                    </div>

                    <p id="explanation-text" class="leading-relaxed text-gray-300"></p>
                    
                    <div id="gemini-content" class="hidden gemini-response-box">
                        <div id="gemini-loading" class="flex items-center gap-3 text-purple-400">
                            <i class="fa-solid fa-circle-notch fa-spin"></i> Analyzing with Gemini AI...
                        </div>
                        <div id="gemini-text" class="hidden text-sm text-gray-300 space-y-2">
                            </div>
                    </div>
                </div>

                <div id="practice-controls-el" class="practice-controls hidden flex-col w-full">
                    
                    <div id="nav-buttons-row" class="flex justify-end gap-4 w-full">
                        <button class="btn-practice border-gray-600 text-gray-400 hover:text-white" onclick="prevQuestion()">
                            <i class="fa-solid fa-arrow-left mr-2"></i> Prev
                        </button>
                        <button id="btn-next-practice" class="btn-practice hidden" onclick="nextQuestion()">
                            Next <i class="fa-solid fa-arrow-right ml-2"></i>
                        </button>
                    </div>

                    <div id="srs-buttons-container" class="hidden srs-container fade-in">
                        <button class="btn-srs btn-learning" onclick="rateQuestion('learning')">
                            Learning
                        </button>
                        <button class="btn-srs btn-retrieving" onclick="rateQuestion('retrieving')">
                            Retrieving
                        </button>
                        <button class="btn-srs btn-mastered" onclick="rateQuestion('mastered')">
                            Mastered
                        </button>
                    </div>

                </div>
            </div>

        </section>

    </main>

    <footer class="inbde-footer h-16 flex items-center justify-between px-6 shrink-0 z-30">
        <div class="flex gap-4">
            <button class="btn-glossy px-6 py-2 rounded-sm text-sm" onclick="prevQuestion()">Previous</button>
            <button class="btn-glossy px-8 py-2 rounded-sm text-sm" onclick="nextQuestion()">Next</button>
        </div>
        <div class="flex gap-4">
            <button class="btn-glossy px-6 py-2 rounded-sm text-sm opacity-90" onclick="toggleMark()">Mark</button>
            <button class="btn-glossy px-6 py-2 rounded-sm text-sm opacity-90" onclick="finishQuiz()">Review</button>
        </div>
    </footer>

    <script>
        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://arumiloijqsxthlswojt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFydW1pbG9panFzeHRobHN3b2p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MzUzNTEsImV4cCI6MjA3OTAxMTM1MX0.5EaB81wglbbtNi8FOzJoDMNd_aOmMULzm27pDClJDSg';
        const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE & MODE CONFIG ---
        const urlParams = new URLSearchParams(window.location.search);
        
        const currentMode = urlParams.get('mode') || 'practice';
        const paramSubjects = urlParams.get('subjects'); 
        const paramCount = parseInt(urlParams.get('count')) || 10;

        let quizData = []; // Array dinÃ¡mico
        let currentIndex = 0;
        let selectedOptionId = null; 
        let timerSeconds = paramCount * 90; // ~1.5 min por pregunta
        let isAnswerChecked = false;
        let currentUser = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            await checkSession();
            configureLayoutMode();
            await loadQuestionsFromDB();
            
            if (quizData.length > 0) {
                renderQuestion();
                if (currentMode === 'simulation') {
                    startTimer();
                }
            } else {
                document.getElementById('question-text').textContent = "No questions found for selected criteria.";
            }
        });

        // --- AUTH CHECK ---
        async function checkSession() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                window.location.href = './index.html';
            }
            currentUser = session.user;
        }

        // --- LOAD DATA FROM SUPABASE ---
        async function loadQuestionsFromDB() {
            try {
                let query = _supabase.from('contenido_quizzes').select('*');

                // Filtrar por materias si vienen en la URL
                if (paramSubjects) {
                    const subjectsArray = decodeURIComponent(paramSubjects).split(',');
                    // Usar filtro 'in' para mÃºltiples valores
                    query = query.in('materia', subjectsArray);
                }

                // Limitar cantidad
                query = query.limit(paramCount);

                // Ejecutar consulta
                const { data, error } = await query;

                if (error) throw error;

                // Transformar datos de Supabase al formato interno
                quizData = data.map(item => ({
                    id: item.id,
                    text: item.titulo_quiz, // Asumiendo que titulo_quiz es la pregunta
                    materia: item.materia, // <--- IMPORTANTE: Guardar materia para stats
                    // Datos clÃ­nicos (Mapea tus columnas reales aquÃ­)
                    patientInfo: item.patient_info || "No patient info available",
                    chiefComplaint: item.chief_complaint || "N/A",
                    history: item.history || "N/A",
                    findings: item.findings || "N/A",
                    photoUrl: item.archivo_url, // Asumiendo que archivo_url es la imagen
                    options: [
                        { id: 'A', text: item.opcion_a || "Option A" },
                        { id: 'B', text: item.opcion_b || "Option B" },
                        { id: 'C', text: item.opcion_c || "Option C" },
                        { id: 'D', text: item.opcion_d || "Option D" }
                    ],
                    correctOption: item.respuesta_correcta, // Debe ser 'A', 'B', 'C' o 'D'
                    explanation: item.explicacion || "No explanation provided."
                }));

                // Actualizar total en UI
                document.getElementById('total-q-num').textContent = quizData.length;

            } catch (err) {
                console.error("Error loading questions:", err);
                document.getElementById('question-text').innerText = "Error loading questions from database.";
            }
        }

        // --- LAYOUT MANAGER ---
        function configureLayoutMode() {
            const leftPanel = document.getElementById('left-panel');
            const rightPanel = document.getElementById('right-panel');
            const practiceStyle = document.getElementById('practice-css');
            const practiceHeader = document.getElementById('practice-header-el');
            const practiceControls = document.getElementById('practice-controls-el');
            
            if (currentMode === 'practice' || currentMode === 'stand_alone') {
                // PRACTICE MODE
                practiceStyle.disabled = false;
                leftPanel.style.display = 'none';
                practiceHeader.classList.remove('hidden');
                practiceControls.classList.remove('hidden');
                practiceControls.style.display = 'flex';
            } else {
                // SIMULATION MODE
                practiceStyle.disabled = true;
                leftPanel.style.display = 'flex';
                rightPanel.classList.add('w-[60%]');
                practiceHeader.classList.add('hidden');
                practiceControls.classList.add('hidden');
            }
        }

        // --- RENDER LOGIC ---
        function renderQuestion() {
            if (!quizData[currentIndex]) return;

            const q = quizData[currentIndex];
            isAnswerChecked = false;
            selectedOptionId = null;

            // 1. Data Population
            document.getElementById('current-q-num').textContent = currentIndex + 1;
            document.getElementById('patient-info').innerHTML = q.patientInfo;
            document.getElementById('chief-complaint').innerHTML = q.chiefComplaint;
            document.getElementById('patient-history').innerHTML = q.history;
            document.getElementById('current-findings').innerHTML = q.findings;

            // Photo Logic
            const imgEl = document.getElementById('case-image');
            const noPhotoMsg = document.getElementById('no-photo-msg');
            if (q.photoUrl) {
                imgEl.src = q.photoUrl; imgEl.classList.remove('hidden'); noPhotoMsg.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden'); noPhotoMsg.classList.remove('hidden');
            }

            // 2. Question & Options
            document.getElementById('question-text').textContent = q.text;
            const optsContainer = document.getElementById('options-container');
            optsContainer.innerHTML = '';

            q.options.forEach(opt => {
                const row = document.createElement('div');
                row.className = 'option-row';
                row.dataset.id = opt.id;
                row.onclick = () => selectOption(opt.id);
                
                row.innerHTML = `
                    <div class="custom-radio"></div>
                    <span class="font-medium text-inherit">${opt.text}</span>
                `;
                optsContainer.appendChild(row);
            });

            // 3. Reset UI Elements
            document.getElementById('explanation-box').classList.add('hidden');
            document.getElementById('btn-explain-gemini').classList.add('hidden');
            document.getElementById('gemini-content').classList.add('hidden');
            
            // Practice Controls Reset
            if (currentMode === 'practice') {
                document.getElementById('nav-buttons-row').classList.remove('hidden');
                document.getElementById('srs-buttons-container').classList.add('hidden');
            }
        }

        function selectOption(id) {
            if (isAnswerChecked) return;

            selectedOptionId = id;
            isAnswerChecked = true; 
            
            validateAnswer();
        }

        function validateAnswer() {
            const q = quizData[currentIndex];
            const isCorrect = selectedOptionId === q.correctOption;

            // 1. Visual Validation
            document.querySelectorAll('.option-row').forEach(row => {
                row.style.cursor = 'default'; 
                const id = row.dataset.id;
                row.classList.remove('selected');

                if (id === q.correctOption) {
                    row.classList.add('correct-answer');
                } else if (id === selectedOptionId && !isCorrect) {
                    row.classList.add('wrong-answer');
                } else if (id === selectedOptionId && isCorrect) {
                    row.classList.add('correct-answer'); 
                }
            });

            // 2. Show Explanation
            const expBox = document.getElementById('explanation-box');
            document.getElementById('explanation-text').textContent = q.explanation;
            expBox.classList.remove('hidden');

            // 3. Show Gemini Button ONLY if Incorrect
            if (!isCorrect) {
                document.getElementById('btn-explain-gemini').classList.remove('hidden');
            }

            // 4. Swap Navigation for SRS Buttons (Only in Practice Mode)
            if (currentMode === 'practice') {
                document.getElementById('nav-buttons-row').classList.add('hidden');
                document.getElementById('srs-buttons-container').classList.remove('hidden');
                document.getElementById('srs-buttons-container').style.display = 'flex';
            }
        }

        async function rateQuestion(rating) {
            const currentQ = quizData[currentIndex];
            const isCorrect = selectedOptionId === currentQ.correctOption;

            // Guardar en Supabase (Tabla 'resultados' o 'user_progress')
            try {
                const { error } = await _supabase.from('resultados').insert([
                    {
                        username: currentUser.email,
                        quiz_id: currentQ.id, 
                        materia: currentQ.materia, // <--- CORREGIDO: Se agrega el campo materia
                        correct: isCorrect ? 1 : 0,
                        total: 1,
                        rating: rating // Nuevo campo para SRS
                    }
                ]);
                
                if(error) console.error("Error saving progress:", error);
                else console.log("Progress saved.");

            } catch (err) {
                console.error("Save error:", err);
            }
            
            nextQuestion();
        }

        function nextQuestion() {
            if (currentIndex < quizData.length - 1) {
                currentIndex++;
                renderQuestion();
            } else {
                alert("Quiz Completed! Returning to Dashboard.");
                window.location.href = 'dashboard.html';
            }
        }

        function prevQuestion() {
            if (currentIndex > 0) {
                currentIndex--;
                renderQuestion();
            }
        }

        // --- UTILS (Sim Mode) ---
        function switchTab(tabName) {
            const tabPhotos = document.getElementById('tab-photos');
            const tabClinical = document.getElementById('tab-clinical');
            const viewPhotos = document.getElementById('view-photos');
            const viewClinical = document.getElementById('view-clinical');

            if (tabName === 'clinical') {
                tabClinical.classList.add('active'); tabClinical.classList.remove('inactive');
                tabPhotos.classList.remove('active'); tabPhotos.classList.add('inactive');
                viewClinical.classList.remove('hidden'); viewPhotos.classList.add('hidden');
            } else {
                tabPhotos.classList.add('active'); tabPhotos.classList.remove('inactive');
                tabClinical.classList.remove('active'); tabClinical.classList.add('inactive');
                viewPhotos.classList.remove('hidden'); viewClinical.classList.add('hidden');
            }
        }

        function startTimer() {
            const display = document.getElementById('timer-display');
            const interval = setInterval(() => {
                if (timerSeconds > 0) {
                    timerSeconds--;
                    const h = Math.floor(timerSeconds / 3600).toString().padStart(2, '0');
                    const m = Math.floor((timerSeconds % 3600) / 60).toString().padStart(2, '0');
                    const s = (timerSeconds % 60).toString().padStart(2, '0');
                    display.textContent = `${h}:${m}:${s}`;
                } else {
                    clearInterval(interval);
                    alert("Time's up!");
                    window.location.href = 'dashboard.html';
                }
            }, 1000);
        }

        function triggerGeminiExplanation() {
            const container = document.getElementById('gemini-content');
            const loading = document.getElementById('gemini-loading');
            const text = document.getElementById('gemini-text');
            
            container.classList.remove('hidden');
            loading.classList.remove('hidden');
            text.classList.add('hidden');

            setTimeout(() => {
                loading.classList.add('hidden');
                text.classList.remove('hidden');
                text.innerHTML = `<p><strong class="text-purple-400">ðŸ¤– AI Analysis:</strong> Detailed explanation generated by AI would appear here.</p>`;
            }, 1500);
        }

        function toggleMark() { console.log("Mark toggled"); }
        function finishQuiz() { 
            if(confirm("Finish and exit?")) window.location.href = 'dashboard.html'; 
        }

    </script>
</body>
</html>
