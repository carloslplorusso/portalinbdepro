<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INBDE Pro Lab Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style id="simulation-css">
        /* Base styles shared or specific to Simulation */
        body { 
            font-family: Arial, Helvetica, sans-serif; 
            background-color: #f0f0f0; 
            margin: 0;
        }

        /* --- INBDE SPECIFIC HEADER/FOOTER --- */
        .inbde-header {
            background-color: #0060a9;
            color: white;
        }
        .inbde-footer {
            background: linear-gradient(to bottom, #0060a9 0%, #004b8d 100%);
            border-top: 4px solid #004b8d;
        }

        /* Glossy Buttons */
        .btn-glossy {
            background: linear-gradient(to bottom, #4c96d7 0%, #1a6cb0 50%, #1a6cb0 100%);
            border: 1px solid #0d4e85;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), 0 2px 2px rgba(0,0,0,0.2);
            color: white;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 0.05em;
            text-shadow: 0 -1px 0 rgba(0,0,0,0.3);
            font-family: 'Arial Narrow', Arial, sans-serif;
            transition: all 0.1s;
        }
        .btn-glossy:hover { background: linear-gradient(to bottom, #5ba4e5 0%, #257bc4 50%, #257bc4 100%); }
        .btn-glossy:active { box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); transform: translateY(1px); }

        /* Tables & Tabs (Sim Mode) */
        .clinical-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .clinical-table th { background-color: #dceefb; color: #000; text-align: left; padding: 8px; border: 1px solid #888; font-weight: bold; }
        .clinical-table td { background-color: #fff; padding: 8px; border: 1px solid #888; vertical-align: top; color: #000; }

        .tab-btn { border: 1px solid #000; background-color: #fff; padding: 8px 16px; font-size: 13px; cursor: pointer; margin-right: 4px; border-bottom: none; position: relative; top: 1px; min-width: 100px; }
        .tab-btn.active { font-weight: bold; z-index: 10; border-bottom: 1px solid #fff; }
        .tab-btn.inactive { background-color: #e0e0e0; color: #555; }

        /* Option Styling (Default/Sim) */
        .option-row { display: flex; align-items: center; border: 1px solid #e0e0e0; background: white; padding: 12px; margin-bottom: 8px; border-radius: 4px; cursor: pointer; transition: all 0.1s; }
        .option-row:hover { border-color: #bbb; }
        .option-row.selected { background-color: #dceefb; border-color: #8fbce6; }
        
        .custom-radio { width: 18px; height: 18px; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; background: white; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        .option-row.selected .custom-radio { border-color: #0060a9; }
        .option-row.selected .custom-radio::after { content: ''; width: 10px; height: 10px; background-color: #0060a9; border-radius: 50%; }
        
        /* RESULTADO EN P√ÅGINA FINAL */
        .review-item { border-bottom: 1px solid #e0e0e0; padding: 15px; background: white; }
        .review-item.correct-bg { background-color: #e6fcf5; border-left: 5px solid #22c55e; }
        .review-item.incorrect-bg { background-color: #fff5f5; border-left: 5px solid #ef4444; }
        .review-explanation-box { display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-left: 4px solid #facc15; font-size: 0.9em; }

        /* --- 3. RESPONSIVE / MOBILE LAYOUT --- */
        @media (max-width: 1024px) {
            /* Main Layout */
            #main-container-wrapper {
                flex-direction: column;
                overflow-y: hidden; /* Prevent main scroll */
                height: 100%;
                width: 100%;
                max-width: 100% !important;
            }

            /* Left Panel (Clinical Info / Photos) */
            #left-panel {
                width: 100% !important;
                height: 200px; /* Fixed height for summary on mobile */
                min-height: 200px;
                border-right: none;
                order: 1; /* Place above the question panel */
                border-bottom: 1px solid #ccc;
                position: relative;
                z-index: 50;
                /* Add subtle transition for expansion */
                transition: height 0.3s ease-in-out;
            }
            /* When expanded by JS toggleCasePanel() */
            #left-panel.mobile-expanded {
                height: 60vh;
            }

            /* Right Panel (Question / Options) */
            #right-panel {
                width: 100% !important;
                order: 2; /* Below the clinical info */
                padding: 15px;
                overflow-y: auto;
            }

            /* Headers / Footers */
            .inbde-header, .inbde-footer {
                height: auto;
                flex-wrap: wrap;
                padding: 10px 8px;
                align-items: center;
                justify-content: center;
            }
            
            /* INBDE Header Structure Adjustment */
            .inbde-header > div {
                width: 100%;
                text-align: center;
                margin-bottom: 5px;
            }
            .inbde-header .w-1/4, .inbde-header .w-2/4 {
                width: 100% !important;
            }
            .inbde-header .text-lg, .inbde-header #timer-container {
                font-size: 0.9rem;
            }
            .inbde-header .text-lg { order: 3; } /* Question X of Y */
            .inbde-header .text-center { order: 1; margin-bottom: 5px; } /* Title */
            .inbde-header .justify-end { order: 2; justify-content: center !important; margin-bottom: 10px; gap: 10px;} /* Timer/Settings/Toggle */
            
            #toggle-case-btn { display: block !important; }

            .inbde-footer {
                flex-direction: column;
                gap: 8px;
            }
            .inbde-footer .flex {
                width: 100%;
                justify-content: space-around;
            }

            /* Practice Header (Dark Mode) */
            .practice-header {
                flex-direction: column;
                gap: 10px;
                padding: 15px 10px;
            }
            .practice-header > div {
                width: 100%;
                text-align: center;
            }
            
            /* Question Text Size in Practice Mode */
            #right-panel #question-text {
                font-size: 1.15rem !important; /* Smaller on mobile */
            }
            
            /* Option Rows Padding */
            #right-panel .option-row {
                padding: 15px !important;
            }
            
            /* Footer Buttons */
            .btn-glossy {
                padding: 10px 15px;
            }
        }

        /* --- FORCE DESKTOP VIEW FOR SIMULATION (MOBILE OVERRIDE) --- */
        body.force-desktop-view {
            overflow: auto !important; /* Permitir scroll si es necesario */
        }

        body.force-desktop-view #main-container-wrapper {
            flex-direction: row !important; /* Forzar lado a lado */
            min-width: 1024px; /* Forzar ancho de escritorio */
            overflow-y: hidden;
            height: calc(100vh - 112px); /* Ajustar altura restando header/footer */
        }

        /* Panel Izquierdo */
        body.force-desktop-view #left-panel {
            width: 40% !important;
            height: 100% !important;
            display: flex !important;
            order: 1 !important; /* Restaurar orden original */
            border-right: 1px solid #ccc;
            border-bottom: none !important;
        }

        /* Panel Derecho */
        body.force-desktop-view #right-panel {
            width: 60% !important;
            height: 100% !important;
            order: 2 !important;
            overflow-y: auto !important;
        }

        /* Header y Footer anchos */
        body.force-desktop-view .inbde-header,
        body.force-desktop-view .inbde-footer {
            min-width: 1024px; /* Asegurar que las barras cubran todo el ancho */
            flex-wrap: nowrap !important;
        }

        /* Ocultar bot√≥n de toggle m√≥vil */
        body.force-desktop-view #toggle-case-btn {
            display: none !important;
        }

        /* Restaurar estructura del Header */
        body.force-desktop-view .inbde-header > div {
            width: auto !important;
            margin-bottom: 0 !important;
        }
        body.force-desktop-view .inbde-header .text-lg { order: 1 !important; width: 25% !important; text-align: left; }
        body.force-desktop-view .inbde-header .text-center { order: 2 !important; width: 50% !important; }
        body.force-desktop-view .inbde-header .justify-end { order: 3 !important; width: 25% !important; justify-content: flex-end !important; margin-bottom: 0 !important; }

    </style>

    <style id="practice-css" disabled>
        /* --- Dark Mode Styles for Stand Alone --- */
        :root {
            --accent: #facc15; 
            --accent-glow: rgba(250, 204, 21, 0.15);
            --bg-dark: #050505;
            --card-bg: #121214;
            --card-border: #27272a;
            --text-main: #f4f4f5;
            --text-muted: #71717a;
            --success: #22c55e;
            --error: #ef4444;
        }

        /* Override Body for Dark Mode */
        body {
            background-color: #000 !important;
            color: var(--text-main);
            background: radial-gradient(circle at 50% 50%, #1a1830 0%, #000000 70%) !important;
        }

        /* Hide Sim Elements in Practice Mode */
        .inbde-header, .inbde-footer { display: none !important; }
        #main-container-wrapper { background: transparent !important; box-shadow: none !important; max-width: 1200px !important; margin: 0 auto; height: 100%; }
        #right-panel { width: 100% !important; background: transparent !important; color: var(--text-main) !important; border: none !important; }
        #question-text { color: #fff !important; font-size: 1.5rem !important; font-weight: 600 !important; line-height: 1.4 !important; }

        /* Option Cards Override (Dark Theme) */
        .option-row {
            background: var(--card-bg) !important; border: 1px solid var(--card-border) !important; color: var(--text-muted) !important;
            border-radius: 12px !important; padding: 20px !important; transition: all 0.3s !important;
        }
        .option-row:hover { transform: translateY(-2px); border-color: #52525b !important; background: #18181b !important; color: #fff !important; }
        .option-row.selected {
            background: linear-gradient(90deg, rgba(250, 204, 21, 0.1), transparent) !important; border-color: var(--accent) !important;
            color: #fff !important; box-shadow: 0 0 20px var(--accent-glow) !important;
        }
        
        /* VALIDATION STATES (CORRECT/INCORRECT) */
        .option-row.correct-answer {
            border-color: var(--success) !important; background: rgba(34, 197, 94, 0.1) !important; color: #fff !important;
        }
        .option-row.wrong-answer {
            border-color: var(--error) !important; background: rgba(239, 68, 68, 0.1) !important; color: #fff !important;
        }
        .option-row.correct-answer .custom-radio { border-color: var(--success) !important; background-color: var(--success) !important; content: '‚úì';}
        .option-row.wrong-answer .custom-radio { border-color: var(--error) !important; background-color: var(--error) !important; content: '‚úï';}
        
        /* Controls & SRS Buttons */
        .practice-controls { display: flex !important; gap: 20px; padding: 20px 0; margin-top: auto; justify-content: flex-end; }
        .srs-container { display: flex; gap: 15px; width: 100%; justify-content: center; margin-top: 10px; }
        .btn-srs { flex: 1; padding: 15px; border-radius: 12px; font-weight: 800; text-transform: uppercase; color: #000; cursor: pointer; border: none; transition: transform 0.2s; max-width: 200px; }
        .btn-learning { background: #ef4444; } .btn-retrieving { background: #eab308; } .btn-mastered { background: #22c55e; }

        /* Explanation Box Dark */
        #explanation-box { background: rgba(255,255,255,0.03) !important; border: 1px solid #333 !important; border-radius: 12px !important; color: #ccc !important; padding: 25px !important; }
        #results-view { 
            background: radial-gradient(circle at 50% 50%, #1a1830 0%, #000000 70%) !important;
            overflow-y: auto;
        }
        .final-results-container { 
            background: var(--card-bg-hero); border: 2px solid var(--accent); border-radius: 16px; padding: 30px; 
            color: #fff; text-align: center; margin-bottom: 20px;
        }
        .review-item { background: #121214 !important; border: 1px solid #27272a !important; }
        .review-item.correct-bg { border-left-color: var(--success) !important; background-color: rgba(34, 197, 94, 0.1) !important; }
        .review-item.incorrect-bg { border-left-color: var(--error) !important; background-color: rgba(239, 68, 68, 0.1) !important; }
        .review-explanation-box { background: #000 !important; color: #ccc !important; border-left: 4px solid #6366f1 !important; }
        .btn-explain-review { background: #6366f1; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; font-size: 0.8em; margin-top: 10px; }
        
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="inbde-header h-14 flex items-center justify-between px-4 shrink-0 shadow-md z-20">
        <div class="text-lg font-normal w-1/4">
            Question <span id="current-q-num">1</span> of <span id="total-q-num">--</span>
        </div>
        <div class="text-center flex flex-col justify-center w-2/4">
            <div class="text-sm font-bold tracking-wide">INBDE Pro Lab</div>
            <div id="mode-subtitle" class="text-xs text-blue-200">INBDE | Simulation Exam</div>
        </div>
        <div class="flex items-center justify-end gap-3 w-1/4">
            <button id="toggle-case-btn" class="hidden text-white bg-blue-700/50 px-3 py-1 rounded text-xs font-bold transition hover:bg-blue-600" onclick="toggleCasePanel()">
                <i class="fa-solid fa-notes-medical"></i> Case Info
            </button>
            <div id="timer-container" class="text-lg">
                Time remaining: <span id="timer-display" class="font-mono">--:--:--</span>
            </div>
            <button class="text-white hover:text-blue-200"><i class="fa-solid fa-gear text-xl"></i></button>
        </div>
    </header>

    <header class="practice-header hidden" id="practice-header-el">
        <div>
            <h1 class="practice-title">INBDE Pro Lab</h1>
            <div class="practice-subtitle">Interactive Practice Mode</div>
        </div>
        <div class="flex items-center gap-4">
            <div class="header-countdown bg-yellow-900/30 text-yellow-400 border border-yellow-600/50 px-3 py-1 rounded-full text-xs font-bold">
                <i class="fa-solid fa-fire mr-1"></i> Streak: <span id="streak-num">3</span> Days
            </div>
            <button onclick="window.location.href='dashboard.html'" class="text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
    </header>

    <main id="main-container-wrapper" class="flex-1 flex overflow-hidden w-full max-w-7xl mx-auto bg-white shadow-xl">
        
        <section id="left-panel" class="w-[40%] flex flex-col border-r border-gray-300 bg-white p-4 overflow-hidden transition-all duration-300">
            <div class="flex border-b border-black mb-0 z-10">
                <button id="tab-photos" class="tab-btn inactive" onclick="switchTab('photos')">PHOTOS</button>
                <button id="tab-clinical" class="tab-btn active" onclick="switchTab('clinical')">CLINICAL EXAM</button>
            </div>
            <div class="border border-black border-t-0 flex-1 overflow-hidden relative bg-white">
                <div id="view-clinical" class="absolute inset-0 overflow-y-auto p-0 custom-scrollbar">
                    <table class="clinical-table">
                        <tr><th>Patient</th></tr>
                        <tr><td><div id="patient-info"></div></td></tr>
                        <tr><th>Chief Complaint</th></tr>
                        <tr><td><div id="chief-complaint"></div></td></tr>
                        <tr><th>Background and/or Patient History</th></tr>
                        <tr><td><div id="patient-history"></div></td></tr>
                        <tr><th>Current Findings</th></tr>
                        <tr><td><div id="current-findings"></div></td></tr>
                    </table>
                </div>
                <div id="view-photos" class="absolute inset-0 hidden bg-black flex items-center justify-center p-4">
                    <img id="case-image" src="" alt="Clinical Case Photo" class="max-w-full max-h-full object-contain">
                    <div id="no-photo-msg" class="text-white hidden">No photos available.</div>
                </div>
            </div>
        </section>

        <section id="right-panel" class="w-[60%] flex flex-col p-6 overflow-y-auto custom-scrollbar relative transition-all duration-300">
            
            <div class="max-w-4xl mx-auto w-full flex flex-col h-full"> 
                
                <div class="mb-6 fade-in">
                    <p id="question-text" class="text-lg text-gray-900 leading-snug">Loading...</p>
                </div>

                <div id="options-container" class="space-y-3 mb-8 fade-in" style="animation-delay: 0.1s;">
                    </div>

                <div id="explanation-box" class="hidden mt-6 fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-lg text-white">Explanation</h4>
                        
                        <button id="btn-explain-gemini" class="hidden btn-practice btn-gemini px-4 py-2 text-xs rounded-full" onclick="triggerGeminiExplanation()">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Explain this
                        </button>
                    </div>

                    <p id="explanation-text" class="leading-relaxed text-gray-300"></p>
                    
                    <div id="gemini-content" class="hidden gemini-response-box">
                        <div id="gemini-loading" class="flex items-center gap-3 text-purple-400">
                            <i class="fa-solid fa-circle-notch fa-spin"></i> Analyzing with Gemini AI...
                        </div>
                        <div id="gemini-text" class="hidden text-sm text-gray-300 space-y-2">
                            </div>
                    </div>
                </div>

                <div id="practice-controls-el" class="practice-controls hidden flex-col w-full">
                    
                    <div id="nav-buttons-row" class="flex justify-end gap-4 w-full">
                        <button class="btn-practice border-gray-600 text-gray-400 hover:text-white" onclick="prevQuestion()">
                            <i class="fa-solid fa-arrow-left mr-2"></i> Prev
                        </button>
                        <button id="btn-next-practice" class="btn-practice hidden" onclick="nextQuestion()">
                            Next <i class="fa-solid fa-arrow-right ml-2"></i>
                        </button>
                    </div>

                    <div id="srs-buttons-container" class="hidden srs-container fade-in">
                        <button class="btn-srs btn-learning" onclick="rateQuestion('Learning')">
                            Learning
                        </button>
                        <button class="btn-srs btn-retrieving" onclick="rateQuestion('Retrieving')">
                            Retrieving
                        </button>
                        <button class="btn-srs btn-mastered" onclick="rateQuestion('Mastered')">
                            Mastered
                        </button>
                    </div>

                </div>
            </div>

        </section>
        
        <section id="results-view" class="hidden w-full h-full p-6 overflow-y-auto custom-scrollbar flex-col items-center">
            <div class="max-w-4xl mx-auto w-full">
                <div class="final-results-container">
                    <h2 class="text-3xl font-bold mb-2">Quiz Completed!</h2>
                    <p class="text-xl mb-4">Total Correct: <span id="final-correct" class="text-green-500">0</span> / <span id="final-total">0</span></p>
                    <div class="flex justify-center gap-4 text-xs font-semibold mt-4">
                        <span class="text-red-400">Learning: <span id="srs-learning-count">0</span></span>
                        <span class="text-yellow-400">Retrieving: <span id="srs-retrieving-count">0</span></span>
                        <span class="text-green-400">Mastered: <span id="srs-mastered-count">0</span></span>
                    </div>
                </div>
                
                <h3 class="text-xl font-bold mb-4 mt-6 text-gray-800 dark:text-gray-200">Review and Explanation:</h3>
                
                <div id="review-list" class="space-y-4">
                    </div>
                
                <button onclick="window.location.href='dashboard.html'" class="btn-start btn-glossy w-full mt-8 p-3 text-lg">
                    Back to Dashboard
                </button>
            </div>
        </section>

    </main>

    <footer class="inbde-footer h-16 flex items-center justify-between px-6 shrink-0 z-30">
        <div class="flex gap-4">
            <button class="btn-glossy px-6 py-2 rounded-sm text-sm" onclick="prevQuestion()">Previous</button>
            <button class="btn-glossy px-8 py-2 rounded-sm text-sm" onclick="nextQuestion()">Next</button>
        </div>
        <div class="flex gap-4">
            <button class="btn-glossy px-6 py-2 rounded-sm text-sm opacity-90" onclick="toggleMark()">Mark</button>
            <button class="btn-glossy px-6 py-2 rounded-sm text-sm opacity-90" onclick="finishQuiz()">Review</button>
        </div>
    </footer>

    <script>
        // --- 1. CONFIGURACI√ìN SUPABASE & GEMINI ---
        const SUPABASE_URL = 'https://arumiloijqsxthlswojt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFydW1pbG9panFzeHRobHN3b2p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MzUzNTEsImV4cCI6MjA3OTAxMTM1MX0.5EaB81wglbbtNi8FOzJoDMNd_aOmMULzm27pDClJDSg';
        const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ‚ö†Ô∏è IMPORTANTE: PEGA TU CLAVE DE GEMINI AQU√ç ABAJO ‚ö†Ô∏è
        // ATENCI√ìN: Esta clave es p√∫blica en el Front-end. √ösala bajo tu propio riesgo o usa un proxy seguro.
        const GEMINI_API_KEY = "AIzaSyCGdQ_3ZkPdqdtvM4TRa59t14ZxqDlxxlY"; 

        // --- STATE & MODE CONFIG ---
        const urlParams = new URLSearchParams(window.location.search);
        const currentMode = urlParams.get('mode') || 'practice';
        const paramSubjects = urlParams.get('subjects'); 
        const paramCount = parseInt(urlParams.get('count')) || 10;

        let quizData = []; 
        let currentIndex = 0;
        let selectedOptionId = null; 
        let timerSeconds = paramCount * 90; 
        let isAnswerChecked = false;
        let currentUser = null;
        
        // NEW SRS COUNTERS FOR QUIZ SUMMARY
        let srsCounters = { Learning: 0, Retrieving: 0, Mastered: 0 }; 

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            await checkSession();
            configureLayoutMode();
            await loadQuestionsFromDB();
            
            if (quizData.length > 0) {
                // Initialize user answers array within quizData
                quizData.forEach(q => q.userAnswer = null);
                renderQuestion();
                if (currentMode === 'simulation') {
                    startTimer();
                }
            } else {
                document.getElementById('question-text').textContent = "No questions found in the database. Please run the SQL setup script.";
            }
        });

        // --- AUTH CHECK ---
        async function checkSession() {
            // Nota: Aqu√≠ estamos asumiendo que el usuario ya est√° logueado, sino redirigimos
            // La l√≥gica de signInWithCustomToken para Canvas no se puede implementar aqu√≠ directamente sin los globals.
            // Para mantener la funcionalidad de Supabase, usaremos la l√≥gica existente.
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                // window.location.href = './index.html';
                // Usar un usuario de prueba para que la UI cargue.
                currentUser = { id: 'test-user', email: 'test@inbde.com' };
                return;
            }
            currentUser = session.user;
        }

        // --- 2. LOAD DATA (CORRECCI√ìN DE L√ìGICA RPC) ---
       // --- 2. LOAD DATA (FUNCI√ìN DE CARGA CENTRAL) ---
async function loadQuestionsFromDB() {
    try {
        // Variables para la respuesta de la base de datos
        let data = null;
        let error = null;
        let rpc_name = null;
        let params = {};

        // Variables de la URL
        const paramIds = urlParams.get('ids'); 
        const STAND_ALONE_MODES = ['practice', 'daily', 'retry_mistakes', 'standalone', 'practice_custom'];
        
        // >>>>>>>>>>> L√ìGICA DE DETERMINACI√ìN DE CARGA <<<<<<<<<<<

        if (currentMode === 'daily' && paramIds) {
            // MODO DAILY RUN: Carga de preguntas fijas por ID
            const idsArray = paramIds.split(',');
            
            // 1. LLAMADA DIRECTA A LA TABLA (NO RPC)
            const response = await _supabase
                .from('questions_bank') // <--- ¬°Tu tabla de preguntas!
                .select('*')
                .in('id', idsArray);
            
            data = response.data;
            error = response.error;
            
        } else if (currentMode.includes('simulation') || currentMode === 'itemsets') {
            // MODO 1: SIMULACI√ìN / ITEM SET (Define RPC para conjuntos)
            rpc_name = 'get_simulation_questions'; 
            params = { quantity: paramCount };
            
        } else if (STAND_ALONE_MODES.includes(currentMode)) {
            // MODO 2: PR√ÅCTICA / STAND ALONE / RETRY (Define RPC para stand-alone)
            rpc_name = (currentMode === 'retry_mistakes') ? 'get_failed_questions' : 'get_stand_alone_questions'; 
            params = { quantity: paramCount };
        } 
        
        // >>>>>>>>>>> MANEJO DE LLAMADAS RPC <<<<<<<<<<<
        // Si el modo no fue 'daily' con IDs, y se defini√≥ un RPC, lo ejecutamos aqu√≠.
        if (rpc_name) {
            // Usamos 'quantity' en los par√°metros si no se defini√≥ antes (lo cual se hace en los bloques anteriores)
            if (!params.quantity) params = { quantity: paramCount }; 
            
            const response = await _supabase.rpc(rpc_name, params);
            data = response.data;
            error = response.error;
        }

        // --- MANEJO DE ERRORES Y CASOS CL√çNICOS ---

        if (error) throw error;
        if (!data || data.length === 0) {
            document.getElementById('question-text').innerText = `No se encontraron preguntas para el modo '${currentMode}'. Aseg√∫rese de que hay datos con el filtro correcto.`;
            return;
        }

        // --- GESTI√ìN DE CASOS CL√çNICOS ---
        const caseIds = [...new Set(data.map(q => q.case_id).filter(id => id !== null))];
        let casesMap = {};

        if (caseIds.length > 0) {
            const { data: casesData } = await _supabase
                .from('clinical_cases')
                .select('*')
                .in('id', caseIds);
                
            if(casesData) casesData.forEach(c => casesMap[c.id] = c);
        }

        // --- MAPEO DE DATOS ---
        quizData = data.map(item => {
            const relatedCase = item.case_id ? casesMap[item.case_id] : null;
            const patient = relatedCase && relatedCase.patient_data ? relatedCase.patient_data : {};

            return {
                id: item.id,
                text: item.question_text,          
                materia: item.category,          
                
                // Datos del Caso
                patientInfo: relatedCase ? `Age: ${patient.age || 'N/A'}, Gender: ${patient.gender || 'N/A'}` : "Stand Alone Question",
                chiefComplaint: relatedCase ? (patient.cc || "N/A") : "N/A",
                history: relatedCase ? (patient.history || "See scenario") : "N/A",
                findings: relatedCase ? (patient.findings || "See scenario") : "N/A",
                
                photoUrl: item.image_url,          
                
                options: [
                    { id: 'A', text: item.option_a }, 
                    { id: 'B', text: item.option_b },
                    { id: 'C', text: item.option_c },
                    { id: 'D', text: item.option_d }
                ],
                correctOption: getOptionLetter(item.correct_answer, item), 
                explanation: item.explanation || "No explanation provided.",
                userAnswer: null, // Track user selection (ID)
                isCorrect: null,  // Track final correctness
                srsRating: null   // Track SRS rating
            };
        });

        document.getElementById('total-q-num').textContent = quizData.length;

    } catch (err) {
        console.error("Error loading questions:", err);
        document.getElementById('question-text').innerText = `Error loading database: ${err.message}. Revise sus RPCs.`;
    }
}

        // Helper para deducir la letra correcta
        function getOptionLetter(correctText, item) {
            if (correctText === item.option_a) return 'A';
            if (correctText === item.option_b) return 'B';
            if (correctText === item.option_c) return 'C';
            if (correctText === item.option_d) return 'D';
            return 'A'; 
        }

        // Helper para chequear si es m√≥vil
        function isMobile() {
            return window.matchMedia("(max-width: 1024px)").matches;
        }
        
        // --- MOBILE/SIMULATION TOGGLE ---
        function toggleCasePanel() {
            const leftPanel = document.getElementById('left-panel');
            const toggleBtn = document.getElementById('toggle-case-btn');
            
            if (leftPanel.classList.contains('mobile-expanded')) {
                leftPanel.classList.remove('mobile-expanded');
                leftPanel.style.height = '200px';
                toggleBtn.innerHTML = '<i class="fa-solid fa-notes-medical"></i> Case Info';
            } else {
                // Expand to fill available height, but restrict max
                leftPanel.classList.add('mobile-expanded');
                leftPanel.style.height = '60vh'; 
                toggleBtn.innerHTML = '<i class="fa-solid fa-compress"></i> Collapse Info';
            }
        }

        // --- LAYOUT MANAGER ---
        function configureLayoutMode() {
            const leftPanel = document.getElementById('left-panel');
            const rightPanel = document.getElementById('right-panel');
            const practiceStyle = document.getElementById('practice-css');
            const simHeader = document.querySelector('.inbde-header');
            const simFooter = document.querySelector('.inbde-footer');
            const practiceHeader = document.getElementById('practice-header-el');
            const practiceControls = document.getElementById('practice-controls-el');
            const toggleCaseButton = document.getElementById('toggle-case-btn');
            
            // Lista de modos de pr√°ctica (Dark Mode)
            const IS_PRACTICE_MODE = ['practice', 'daily', 'retry_mistakes', 'standalone', 'practice_custom'].includes(currentMode);

            if (IS_PRACTICE_MODE) {
                // --- MODO PR√ÅCTICA (DARK / MOBILE FRIENDLY) ---
                document.body.classList.remove('force-desktop-view'); // Quitar forzado de escritorio
                
                practiceStyle.disabled = false;
                
                leftPanel.style.display = 'none';
                simHeader.classList.add('hidden');
                simFooter.classList.add('hidden');
                toggleCaseButton.classList.add('hidden');

                practiceHeader.classList.remove('hidden');
                practiceControls.classList.remove('hidden');
                practiceControls.style.display = 'flex';
                
                rightPanel.style.width = '100%';
                
                // T√≠tulos espec√≠ficos
                if(currentMode === 'daily') {
                    document.querySelector('.practice-subtitle').innerText = "Daily Lab Sprint";
                } else if (currentMode === 'retry_mistakes') {
                    document.querySelector('.practice-subtitle').innerText = "Retry Mistakes Session";
                }
                
            } else {
                // --- MODO SIMULACI√ìN (WHITE / FORCE DESKTOP LAYOUT) ---
                
                // AQU√ç EST√Å LA MAGIA:
                document.body.classList.add('force-desktop-view'); 
                
                practiceStyle.disabled = true;

                leftPanel.style.display = 'flex';
                simHeader.classList.remove('hidden');
                simFooter.classList.remove('hidden');

                practiceHeader.classList.add('hidden');
                practiceControls.classList.add('hidden');
                
                // Forzamos estilos inline para asegurar el split 40/60 incluso si el CSS falla
                rightPanel.style.width = '60%'; 
                leftPanel.style.width = '40%';
                toggleCaseButton.classList.add('hidden'); // Ocultar bot√≥n m√≥vil expl√≠citamente
            }
        }
        
        // --- RENDER LOGIC ---
        function renderQuestion() {
            if (!quizData[currentIndex]) return;

            const q = quizData[currentIndex];
            isAnswerChecked = false;
            selectedOptionId = null;

            document.getElementById('current-q-num').textContent = currentIndex + 1;
            
            // UI elements reset/update
            document.getElementById('patient-info').innerHTML = q.patientInfo;
            document.getElementById('chief-complaint').innerHTML = q.chiefComplaint;
            document.getElementById('patient-history').innerHTML = q.history.replace(/\n/g, '<br>') || "See scenario"; 
            document.getElementById('current-findings').innerHTML = q.findings;
            
            document.getElementById('question-text').textContent = q.text;
            document.getElementById('explanation-box').classList.add('hidden');
            document.getElementById('btn-explain-gemini').classList.add('hidden');
            document.getElementById('gemini-content').classList.add('hidden');

            const optsContainer = document.getElementById('options-container');
            optsContainer.innerHTML = '';
            
            // Determine if we are re-rendering a validated question (for navigation)
            const isSimulation = !['practice', 'daily', 'retry_mistakes', 'standalone', 'practice_custom'].includes(currentMode);
            const isAnswered = q.userAnswer !== null;

            q.options.forEach(opt => {
                const row = document.createElement('div');
                row.className = 'option-row';
                row.dataset.id = opt.id;
                
                // Si ya est√° respondida (navegando en modo Simulaci√≥n), deshabilitar interacci√≥n
                if (isAnswered) {
                    row.classList.add('disabled');
                    if (opt.id === q.userAnswer) row.classList.add('selected'); // Mantener la selecci√≥n del usuario
                } else {
                    row.onclick = () => selectOption(opt.id);
                    if (selectedOptionId === opt.id) row.classList.add('selected');
                }

                row.innerHTML = `<div class="custom-radio"></div><span class="font-medium text-inherit">${opt.text}</span>`;
                optsContainer.appendChild(row);
            });

            // Adjust controls visibility
            document.getElementById('srs-buttons-container').classList.add('hidden');
            document.getElementById('btn-next-practice').classList.add('hidden');
            
            if (isAnswered && !isSimulation) {
                // Si es modo pr√°ctica y ya est√° respondida (revisi√≥n r√°pida), mostrar SRS
                validateAnswer(true); // Re-validar sin hacer doble clic/doble log
            }
        }

        // --- MANEJO DE CLIC DE OPCI√ìN ---
        function selectOption(id) {
            const IS_PRACTICE_MODE = ['practice', 'daily', 'retry_mistakes', 'standalone', 'practice_custom'].includes(currentMode);

            document.querySelectorAll('.option-row').forEach(row => row.classList.remove('selected'));
            document.querySelector(`[data-id="${id}"]`).classList.add('selected');
            
            selectedOptionId = id;
            
            if (IS_PRACTICE_MODE) {
                // MODO PR√ÅCTICA (STAND ALONE): Validaci√≥n Inmediata
                if (isAnswerChecked) return;
                isAnswerChecked = true; 
                validateAnswer(false); // Validar y mostrar SRS botones
            }
            // MODO SIMULACI√ìN: Solo marca la opci√≥n. El bot√≥n Next del footer guarda la respuesta.
        }

        // --- VALIDACI√ìN Y FEEDBACK (Llamado solo en modo pr√°ctica) ---
        function validateAnswer(re_render) {
            const q = quizData[currentIndex];
            const isCorrect = selectedOptionId === q.correctOption;
            
            // Evita que se dispare la validaci√≥n en modo Simulaci√≥n.
            if (!re_render && !['practice', 'daily', 'retry_mistakes', 'standalone', 'practice_custom'].includes(currentMode)) return;

            // 1. Mostrar color-coding y deshabilitar opciones
            document.querySelectorAll('.option-row').forEach(row => {
                row.style.cursor = 'default'; 
                row.classList.add('disabled'); // Deshabilitar
                const id = row.dataset.id;

                if (id === q.correctOption) {
                    row.classList.add('correct-answer');
                } else if (id === selectedOptionId && !isCorrect) {
                    row.classList.add('wrong-answer');
                }
            });

            // 2. Mostrar Explicaci√≥n y bot√≥n Gemini
            document.getElementById('explanation-text').textContent = q.explanation;
            document.getElementById('explanation-box').classList.remove('hidden');
            if (!isCorrect && GEMINI_API_KEY) {
                document.getElementById('btn-explain-gemini').classList.remove('hidden');
            }

            // 3. MODO PR√ÅCTICA: Mostrar botones SRS
            document.getElementById('nav-buttons-row').classList.add('hidden');
            document.getElementById('srs-buttons-container').classList.remove('hidden');
            document.getElementById('srs-buttons-container').style.display = 'flex';
        }

        // --- MANEJO DE BOTONES (NEXT/SRS) ---
        async function rateQuestion(rating) { 
            // 1. Logear respuesta al DB y registrar rating SRS
            const currentQ = quizData[currentIndex];
            currentQ.userAnswer = selectedOptionId;
            currentQ.isCorrect = selectedOptionId === currentQ.correctOption;
            currentQ.srsRating = rating;
            srsCounters[rating]++; // Aumentar contador SRS de la sesi√≥n

            if (currentUser && currentUser.id !== 'test-user') {
                try {
                    // Asumimos que la tabla user_analytics ya tiene la columna srs_rating
                    const { error } = await _supabase.from('user_analytics').insert([
                        {
                            user_email: currentUser.email,
                            question_id: currentQ.id,
                            is_correct: currentQ.isCorrect,
                            srs_rating: rating // ENLACE CR√çTICO con la base de datos
                        }
                    ]);
                    if(error) console.error("Supabase error:", error);
                } catch (err) { console.error("Save error:", err); }
            }
            
            // 2. Avanzar
            nextQuestion();
        }

        function nextQuestion() {
            const currentQ = quizData[currentIndex];
            const isSimulation = !['practice', 'daily', 'retry_mistakes', 'standalone', 'practice_custom'].includes(currentMode);

            if (isSimulation) {
                // MODO SIMULACI√ìN: Guardar respuesta y avanzar SIN validar visualmente
                if (!selectedOptionId) {
                    // Reemplazamos alert() por console.error o un modal custom si fuera un entorno real.
                    console.error("Por favor, selecciona una respuesta para continuar."); 
                    return;
                }
                
                // Registrar la respuesta en el objeto de datos (para la revisi√≥n final)
                currentQ.userAnswer = selectedOptionId;
                currentQ.isCorrect = selectedOptionId === currentQ.correctOption;

                // Loguear la respuesta de Simulaci√≥n inmediatamente
                if (currentUser && currentUser.id !== 'test-user') {
                    _supabase.from('user_analytics').insert([
                        {
                            user_email: currentUser.email,
                            question_id: currentQ.id,
                            is_correct: currentQ.isCorrect,
                            srs_rating: 'Simulation' // Marcar el rating como Simulaci√≥n/Examen
                        }
                    ]).then(res => { if(res.error) console.error("Sim log error:", res.error); });
                }
                
                // Si es la √∫ltima pregunta, vamos a los resultados.
                if (currentIndex === quizData.length - 1) {
                    showFinalResults();
                    return;
                }
                
                // Si no es la √∫ltima, pasamos a la siguiente.
                currentIndex++;
                renderQuestion();
                return;
            } 
            
            // MODO PR√ÅCTICA (SRS): L√≥gica de avance ya manejada por rateQuestion()
            if (currentIndex < quizData.length - 1) {
                currentIndex++;
                renderQuestion();
            } else {
                showFinalResults();
            }
        }
        
        function prevQuestion() {
            if (currentIndex > 0) {
                currentIndex--;
                renderQuestion();
            }
        }

        // --- TIMER LOGIC (Placeholder for Simulation Mode) ---
        let timerInterval;
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    showFinalResults();
                } else {
                    timerSeconds--;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timerSeconds / 3600);
            const minutes = Math.floor((timerSeconds % 3600) / 60);
            const seconds = timerSeconds % 60;

            const display = [hours, minutes, seconds]
                .map(v => v.toString().padStart(2, '0'))
                .join(':');
            
            document.getElementById('timer-display').textContent = display;
        }


        // --- PANTALLA FINAL DE RESULTADOS (MODO EXAMEN/PR√ÅCTICA) ---
        function showFinalResults() {
            if (timerInterval) clearInterval(timerInterval);
            
            // Ocultar UI de Quiz
            document.getElementById('main-container-wrapper').classList.add('hidden');
            document.querySelector('.inbde-footer').classList.add('hidden'); 
            
            // Ocultar headers
            document.querySelector('.inbde-header')?.classList.add('hidden');
            document.getElementById('practice-header-el')?.classList.add('hidden');

            // Mostrar UI de Resultados
            const resultsView = document.getElementById('results-view');
            resultsView.classList.remove('hidden');
            resultsView.style.display = 'flex';

            // 1. Tally Scores
            let totalCorrect = quizData.filter(q => q.isCorrect).length;
            let totalQuestions = quizData.length;

            // 2. Render Summary
            document.getElementById('final-correct').innerText = totalCorrect;
            document.getElementById('final-total').innerText = totalQuestions;
            document.getElementById('srs-learning-count').innerText = srsCounters.Learning;
            document.getElementById('srs-retrieving-count').innerText = srsCounters.Retrieving;
            document.getElementById('srs-mastered-count').innerText = srsCounters.Mastered;
            
            // 3. Render Review List (with Explanations)
            const reviewList = document.getElementById('review-list');
            reviewList.innerHTML = '';
            
            quizData.forEach((q, index) => {
                const isCorrect = q.isCorrect;
                const userAnswerText = q.options.find(opt => opt.id === q.userAnswer)?.text || "No Answered";
                const correctAnswerText = q.options.find(opt => opt.id === q.correctOption)?.text || "N/A";
                const srsTag = q.srsRating ? `<span class="font-bold text-xs p-1 rounded" style="background:${q.srsRating === 'Learning' ? '#ef4444' : q.srsRating === 'Retrieving' ? '#eab308' : '#22c55e'}">${q.srsRating}</span>` : '';
                
                // Estructura de revisi√≥n
                const itemHTML = `
                    <div class="review-item ${isCorrect ? 'correct-bg' : 'incorrect-bg'} p-4">
                        <h4 class="font-bold text-md mb-2 text-gray-900 dark:text-white">Q${index + 1}: ${isCorrect ? 'Correcta ‚úÖ' : 'Incorrecta ‚ùå'} ${srsTag}</h4>
                        <p class="mb-1">${q.text}</p>
                        <p class="text-sm">Tu Respuesta: <strong class="${isCorrect ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${userAnswerText}</strong></p>
                        <p class="text-sm">Respuesta Correcta: <strong>${correctAnswerText}</strong></p>
                        
                        <button class="btn-explain-review" onclick="toggleReviewExplanation(this, ${index})">
                            Mostrar Explicaci√≥n y IA
                        </button>
                        
                        <div class="review-explanation-box" id="review-expl-${index}">
                            <p><strong>Racional:</strong> ${q.explanation}</p>
                            <button class="btn-explain-review mt-2 bg-purple-600 hover:bg-purple-700" onclick="triggerGeminiReview(${index})">
                                ü§ñ AI Explain This
                            </button>
                            <div id="gemini-review-${index}" class="mt-2 text-sm text-gray-300"></div>
                        </div>
                    </div>
                `;
                reviewList.insertAdjacentHTML('beforeend', itemHTML);
            });
        }
        
        // --- UTILIDADES PANTALLA FINAL ---
        
        function toggleReviewExplanation(button, index) {
            const explBox = document.getElementById(`review-expl-${index}`);
            if (explBox.style.display === 'block') {
                explBox.style.display = 'none';
                button.innerText = 'Mostrar Explicaci√≥n y IA';
            } else {
                explBox.style.display = 'block';
                button.innerText = 'Ocultar Explicaci√≥n';
            }
        }
        
        async function triggerGeminiReview(index) {
            const reviewContainer = document.getElementById(`gemini-review-${index}`);
            const q = quizData[index];
            
            reviewContainer.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Analyzing with Gemini AI...';
            
            const prompt = `Explain why the answer "${q.correctOption}" is correct for the dental question: "${q.text}". Keep it concise and educational.`;

            // Utiliza la clave insertada al inicio del script
            const apiKey = GEMINI_API_KEY; 

            // Si la clave es el placeholder, alertamos al usuario.
            if(apiKey === "YOUR_SECURE_GEMINI_API_KEY_HERE" || !apiKey) { 
                reviewContainer.innerHTML = `<p class="text-red-500"><strong>ü§ñ Error de IA:</strong> La clave de IA no est√° configurada o es el valor placeholder. La clave es visible en el Front-end, √∫sala bajo tu propio riesgo.</p>`;
                return; 
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: "Act as an expert dental exam tutor. Explain the medical rationale clearly." }] }
                    })
                });
                
                const data = await response.json();
                
                if (response.status !== 200 || data.error) {
                    const errorMessage = data.error?.message || `Error HTTP ${response.status}. La clave podr√≠a estar vencida.`;
                    reviewContainer.innerHTML = `<p class="text-red-500"><strong>ü§ñ Error de IA:</strong> ${errorMessage}</p>`;
                    return;
                }

                const explanation = data.candidates?.[0]?.content?.parts?.[0]?.text || "AI could not generate an explanation.";
                const formatted = explanation.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');

                reviewContainer.innerHTML = `<p><strong class="text-purple-400">ü§ñ AI Analysis:</strong><br>${formatted}</p>`;

            } catch (e) {
                reviewContainer.innerText = `Error de conexi√≥n: ${e.message}`;
            }
        }


        // --- UTILS (No-SRS/Footer functions) ---
        function switchTab(tabId) {
            document.getElementById('view-photos').classList.toggle('hidden', tabId === 'clinical');
            document.getElementById('view-clinical').classList.toggle('hidden', tabId === 'photos');
            document.getElementById('tab-photos').classList.toggle('active', tabId === 'photos');
            document.getElementById('tab-photos').classList.toggle('inactive', tabId !== 'photos');
            document.getElementById('tab-clinical').classList.toggle('active', tabId === 'clinical');
            document.getElementById('tab-clinical').classList.toggle('inactive', tabId !== 'clinical');
        }

        function toggleMark() { console.log("Mark toggled"); }
        function finishQuiz() { 
            // En modo Simulaci√≥n, el bot√≥n 'Review' del footer debe llevar a la pantalla final.
            const isSimulation = !['practice', 'daily', 'retry_mistakes', 'standalone', 'practice_custom'].includes(currentMode);
            if (isSimulation) {
                showFinalResults();
            } else {
                // Reemplazamos alert() por confirm para evitar errores en ciertos entornos.
                if(window.confirm("Finish and exit?")) window.location.href = 'dashboard.html'; 
            }
        }

    </script>
</body>
</html>
