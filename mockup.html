<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>INBDE PRO Lab - Responsive</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    /* =========================================
       1. VARIABLES & BASE (ESTILOS GLOBALES)
       ========================================= */
    :root {
        --accent: #facc15; 
        --accent-glow: rgba(250, 204, 21, 0.15);
        --bg-dark: #050505;
        --card-bg: #121214;
        --card-bg-hero: #1c1c20;
        --card-border: #27272a;
        --text-main: #f4f4f5;
        --text-muted: #71717a;
        
        /* Dimensiones Desktop */
        --col-width: 200px;
        --sq-size: 190px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        margin: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background-color: #000;
        color: var(--text-main);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: radial-gradient(circle at 50% 50%, #1a1830 0%, #000000 70%);
    }

    /* =========================================
       2. LAYOUT DE ESCRITORIO (GRID - DEFAULT)
       ========================================= */
    .lab-container {
        width: 100%;
        max-width: 1500px;
        height: 96vh;
        display: grid;
        grid-template-columns: var(--col-width) 1fr var(--col-width);
        grid-template-rows: auto 1fr;
        gap: 25px; 
        padding: 20px;
        overflow: hidden;
        position: relative;
    }

    /* Clases de Utilidad */
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.5s ease forwards; }
    .fade-out { animation: fadeOut 0.3s ease forwards; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    /* --- HEADER --- */
    .header-area {
        grid-column: 2 / 3;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding-bottom: 20px;
        z-index: 10;
        min-height: 80px;
    }

    .lab-title {
        font-size: 2.2rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: -1px;
        margin: 0;
        color: #fff;
        cursor: pointer;
    }

    .lab-subtitle {
        color: var(--accent);
        font-weight: 600;
        font-size: 0.9rem;
        letter-spacing: 2px;
        text-transform: uppercase;
        margin-top: 5px;
        opacity: 0.8;
    }

    #header-welcome-section {
        margin-top: 10px;
        display: flex; 
        flex-direction: column;
        align-items: center;
        gap: 5px;
        transition: opacity 0.3s;
    }

    .user-welcome {
        font-size: 1.2rem;
        color: var(--text-muted);
        font-weight: 400;
        display: flex; align-items: center; gap: 15px;
    }

    .header-countdown {
        background: rgba(250, 204, 21, 0.1);
        border: 1px solid rgba(250, 204, 21, 0.3);
        color: var(--accent);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        display: inline-flex; align-items: center; gap: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .header-countdown:hover {
        background: rgba(250, 204, 21, 0.2);
        transform: scale(1.05);
    }

    /* --- COLUMNAS (Desktop) --- */
    #dashboard-content { display: contents; }

    .col-side { display: flex; flex-direction: column; justify-content: space-between; padding-top: 40px; gap: 20px; opacity: 0.9; transition: opacity 0.3s; }
    .col-side:hover { opacity: 1; }
    .col-left { grid-column: 1 / 2; grid-row: 1 / 3; }
    .col-right { grid-column: 3 / 4; grid-row: 1 / 3; }
    .col-center { grid-column: 2 / 3; grid-row: 2 / 3; display: flex; flex-direction: column; align-items: center; gap: 25px; position: relative; }

    /* --- TARJETAS GENERALES (Desktop) --- */
    .card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 14px; padding: 15px; position: relative; transition: all 0.3s; cursor: pointer; }
    .card-secondary { box-shadow: none; }
    .card-secondary:hover { background: #18181b; border-color: #52525b; }
    .card-secondary .card-title { font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px; } 
    .card-secondary .card-desc { font-size: 0.75rem; }

    /* --- CARD PROMO STYLE (Daily & IA Lab) --- */
    .card-promo-style {
        width: 100%; background: linear-gradient(145deg, rgba(250, 204, 21, 0.15), rgba(0,0,0,0) 70%); border: 2px solid var(--accent); border-radius: 16px; padding: 20px;
        box-shadow: 0 0 20px rgba(250, 204, 21, 0.15); cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; min-height: 160px; 
        display: flex; flex-direction: column; justify-content: center;
    }
    .card-promo-style:hover { transform: scale(1.05) translateY(-5px); box-shadow: 0 10px 30px rgba(250, 204, 21, 0.3); background: linear-gradient(145deg, rgba(250, 204, 21, 0.25), rgba(0,0,0,0) 80%); }

    .promo-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    @keyframes pulse-fire { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    .fire-icon { font-size: 1.5rem; animation: pulse-fire 2s infinite ease-in-out; }
    .ai-icon { font-size: 1.5rem; filter: drop-shadow(0 0 5px var(--accent)); }
    .promo-title { font-size: 1rem; font-weight: 800; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; }
    .promo-desc { font-size: 0.8rem; color: #ddd; margin-bottom: 15px; line-height: 1.3; }
    .btn-start { display: block; width: 100%; background: var(--accent); color: #000; font-weight: 900; font-size: 0.85rem; padding: 12px 0; border-radius: 8px; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 10px rgba(250, 204, 21, 0.3); text-align: center; border: none; cursor: pointer; }

    /* --- CENTER HERO (Desktop) --- */
    .card-learn-banner { width: 100%; padding: 20px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 15px; border: 2px solid var(--accent); background: rgba(250, 204, 21, 0.05); margin-bottom: 20px; border-radius: 16px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .card-learn-banner:hover { background: rgba(250, 204, 21, 0.12); transform: translateY(-2px); }
    .card-learn-banner h2 { margin: 0; font-size: 1.2rem; font-weight: 700; color: #fff; }
    .banner-icon { color: var(--accent); display: flex; }

    .center-row-hero { width: 100%; display: flex; justify-content: center; gap: 25px; flex: 1; align-items: flex-start; }
    .hero-card { flex: 1; max-width: 260px; aspect-ratio: 1 / 1; background: var(--card-bg-hero); border: 1px solid var(--accent); box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5), 0 0 20px var(--accent-glow); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 15px; cursor: pointer; }
    .hero-card .icon { font-size: 3rem; margin-bottom: 15px; }
    .hero-card .title { font-size: 1.2rem; font-weight: 800; color: #fff; margin-bottom: 5px; }
    .hero-card .sub { font-size: 0.8rem; color: var(--text-muted); }

    .square-card-bottom { width: var(--sq-size); height: var(--sq-size); margin-top: auto; display: flex; flex-direction: column; }
    .card-notes { background-image: radial-gradient(#333 1px, transparent 1px); background-size: 12px 12px; }
    .card-metrics { background: linear-gradient(180deg, var(--card-bg-hero) 0%, #080808 100%); border-top: 1px solid #333; box-shadow: 0 -10px 40px -20px rgba(0,0,0,1); }
    .metrics-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .metrics-title { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    .metrics-icon { opacity: 0.7; color: #fff; display: flex; align-items: center; }

    .pie-container { flex: 1; display: flex; align-items: center; justify-content: center; }
    .pie-chart-main { width: 90px; height: 90px; border-radius: 50%; background: conic-gradient(var(--accent) 0% 65%, #27272a 65% 100%); box-shadow: 0 0 15px rgba(0,0,0,0.5); }
    .usage-container { align-items: center; justify-content: center; gap: 10px; }
    .usage-header { width: 100%; text-align: left; }
    .ring-chart { width: 60px; height: 60px; border-radius: 50%; background: conic-gradient(var(--accent) 65%, #27272a 0); display: flex; justify-content: center; align-items: center; }
    .ring-chart::after { content: ""; width: 48px; height: 48px; background: var(--card-bg); border-radius: 50%; }
    .activity-dots { display: flex; gap: 3px; justify-content: center; flex-wrap: wrap; width: 100%; }
    .dot { width: 6px; height: 6px; background: #333; border-radius: 1px; }
    .dot.active { background: var(--accent); }
    
    /* --- MODALS UI --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    .modal-content { background: #18181b; border: 1px solid var(--card-border); border-radius: 20px; width: 90%; max-width: 500px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform: translateY(20px); transition: transform 0.3s ease; display: flex; flex-direction: column; gap: 15px; }
    .modal-overlay.active .modal-content { transform: translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .modal-title { font-size: 1.5rem; font-weight: 800; color: #fff; display: flex; align-items: center; gap: 10px; }
    .date-input { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 15px; font-size: 1.2rem; text-align: center; border-radius: 8px; margin-bottom: 20px; color-scheme: dark; }
    .btn-start-confirm { width: 100%; background: var(--accent); color: #000; padding: 15px; border: none; font-weight: 900; border-radius: 8px; cursor: pointer; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; }
    .btn-back-small { background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); padding: 10px 25px; border-radius: 30px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; }


    /* =========================================
       3. MEDIA QUERIES (VISTA M√ìVIL)
       ========================================= */
    /* Este bloque toma el control para dispositivos peque√±os (<1024px) */
    @media (max-width: 1024px) {
        body { height: 100dvh; overflow: hidden; align-items: flex-start; padding: 0; }
        
        .lab-container {
            height: 100dvh;
            display: grid;
            /* ESTRUCTURA M√ìVIL (1 COLUMNA FLUIDA) */
            grid-template-columns: 1fr; 
            /* Filas: Header | Hero | Banner | Daily | Metrics | Espacio extra */
            grid-template-rows: min-content 1fr min-content min-content min-content 1fr;
            gap: 8px; 
            padding: 10px 12px 12px 12px;
            width: 100%;
        }

        /* Redefinir columnas y √°reas para el layout m√≥vil */
        .col-side, .col-center { display: contents; }

        /* --- ORDENAMIENTO Y VISIBILIDAD --- */

        /* 1¬∫: HEADER (Order 0) - Centrado */
        .header-area { 
            grid-column: 1 / -1; 
            order: 0; 
            padding-bottom: 5px; 
            min-height: auto; 
            align-items: center; 
            justify-content: center; 
            text-align: center;
            margin-bottom: 15px; /* ESPACIO A√ëADIDO */
        }
        .lab-title { font-size: 1.5rem; }
        .header-countdown { padding: 2px 8px; font-size: 0.7rem; }
        .user-welcome span:first-child { display: none; }
        .user-welcome { font-size: 0.9rem; }
        #header-welcome-section { 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            width: 100%; 
            max-width: 300px; 
            margin-top: 5px; 
        }

        /* 2¬∫: HERO CARDS (Order 1) - Iconos Mobile */
        .center-row-hero {
            grid-column: 1 / -1; 
            order: 1;
            flex-direction: row !important;
            gap: 6px;
            /* AUMENTO DE MARGEN INFERIOR A 25px */
            margin: 0 0 25px 0; 
            height: 100%; 
            align-items: stretch;
            justify-content: space-around;
            flex-wrap: nowrap;
        }
        .hero-card {
            min-height: 0;
            padding: 12px 5px;
            flex-direction: column; 
            justify-content: center;
            flex: 1;
            aspect-ratio: 1 / 1;
            max-width: 100px;
        }
        .hero-card .icon { margin-bottom: 5px; font-size: 2rem; }
        .hero-card .title { font-size: 0.8rem; line-height: 1.1; font-weight: 700; }
        .hero-card .sub { display: none; }

        /* 3¬∫: BANNER LEARN (Order 2) - Barra Horizontal Peque√±a */
        .card-learn-banner { 
            grid-column: 1 / -1; 
            order: 2;
            margin: 0; 
            padding: 8px 15px; 
            min-height: 45px; 
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }
        .card-learn-banner h2 { font-size: 0.85rem; }

        /* 4¬∫: DAILY LAB (Order 3) - Barra Horizontal Peque√±a */
        .col-left .card-promo-style:first-child {
            display: flex !important; /* Hacemos visible */
            grid-column: 1 / -1;
            order: 3;
            width: 100%;
            /* ALTURA FIJA UNIFICADA: 70px */
            min-height: 70px;
            padding: 8px 15px;
            margin: 0;
            flex-direction: row; /* Layout horizontal */
            align-items: center;
            justify-content: space-between;
            border: 2px solid var(--accent);
        }
        /* Ajustes internos para Daily Lab en barra */
        .col-left .card-promo-style:first-child .promo-header { margin-bottom: 0; gap: 10px; }
        .col-left .card-promo-style:first-child .promo-desc { display: none; } /* Ocultar descripci√≥n */
        .col-left .card-promo-style:first-child .btn-start { 
            width: auto; 
            margin: 0; 
            padding: 6px 15px; 
            font-size: 0.7rem; 
        }

        /* 5¬∫: METRICS (Order 4) - MODIFICADO PARA SER ID√âNTICO A DAILY LAB */
        .col-center .card-metrics {
            display: flex !important; /* Hacemos visible */
            grid-column: 1 / -1;
            order: 4;
            width: 100%;
            /* ALTURA FIJA UNIFICADA: 70px (Igual que Daily Lab) */
            min-height: 70px; 
            padding: 8px 15px;
            margin: 0;
            flex-direction: row; /* Layout horizontal */
            align-items: center;
            justify-content: space-between;
            /* ESTILO COPIADO DE DAILY LAB */
            background: linear-gradient(145deg, rgba(250, 204, 21, 0.15), rgba(0,0,0,0) 70%); 
            border: 2px solid var(--accent); /* Borde amarillo */
            border-radius: 16px;
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.15);
        }
        /* Ajustes internos para Metrics en barra */
        .metrics-header { width: auto; margin-bottom: 0; gap: 10px; }
        .metrics-title { font-size: 0.7rem; font-weight: 800; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; }
        .metrics-icon { display: none; } /* Ocultar icono extra */
        /* Eliminamos el elemento <svg> directo y lo reemplazamos con un div para el "bot√≥n" de Performance */
        .pie-container { flex: 0 0 auto; justify-content: flex-end; }
        .pie-chart-main { width: 30px; height: 30px; box-shadow: none; } /* Gr√°fico m√°s peque√±o */
        /* Nuevo estilo para el bot√≥n de Performance */
        .metrics-button {
            background: var(--accent);
            color: #000;
            font-weight: 900;
            font-size: 0.7rem;
            padding: 6px 15px;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            border: none;
            cursor: pointer;
            width: auto; /* Para que no ocupe todo el ancho */
        }


        /* ELEMENTOS OCULTOS */
        .col-side .card-notes, /* Notes */
        .col-right .usage-container, /* Activity Log */
        .col-right .card-promo-style:first-child /* IA Lab */
        {
            display: none !important;
        }

        /* Ajustar vistas internas para ocupar toda la pantalla */
        #learning-view, #simulation-view, #pomodoro-view, #selection-view, #simulation-customization-view, #pomodoro-customization-view, #pomodoro-timer-view {
             grid-column: 1 / -1; 
             grid-row: 2 / -1; 
             position: absolute; 
             z-index: 100; /* Asegurar que est√© por encima del dashboard */
             height: 100%;
             width: 100%;
             top: 0;
             left: 0;
             padding: 10px;
        }
    }
</style>
</head>
<body>

<div class="lab-container">

    <header class="header-area">
        <h1 class="lab-title" onclick="goBackToDashboard()">INBDE PRO <span style="font-weight:300; opacity:0.5;">Lab</span></h1>
        <div class="lab-subtitle">Train in our lab. Become a Pro.</div>
        <div id="header-welcome-section">
            <div class="user-welcome">
                <span>Welcome back, <span style="color:var(--accent); font-weight:700;" id="user-name-display">Doctor</span></span>
            </div>
            <div class="header-countdown" onclick="openDateModal()" id="countdown-badge">
                <span style="font-size:1.1em">‚è±</span> <span id="countdown-value">-- Days Left</span>
            </div>
        </div>
    </header>

    <div id="dashboard-content">
        <!-- Columna Izquierda (Contiene Daily y Notes) --><div class="col-side col-left">
            <div class="card-promo-style">
                <div class="promo-header"><div class="fire-icon">üî•</div><div class="promo-title">DAILY LAB <br>RUN</div></div>
                <div class="promo-desc">10-question sprint. Keep the streak alive.</div>
                <button class="btn-start" onclick="startQuizEngine('daily')">START NOW</button>
            </div>
            <!-- Elemento oculto en m√≥vil (por CSS) --><div class="card card-secondary card-notes square-card-bottom" onclick="openAIModal('notes')">
                <div class="card-title">üìù Notes ‚ú®</div>
                <div class="card-desc" style="font-style:italic; opacity:0.5;">Click to organize notes with AI...</div>
            </div>
        </div>

        <!-- Columna Central (Contiene Banner, Hero Cards y Metrics) --><div class="col-center">
            <div class="card-learn-banner">
                <div class="banner-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>
                <h2>Learn about the INBDE our way</h2>
            </div>
            <div class="center-row-hero">
                <div class="hero-card" onclick="showLearningLab()">
                    <div class="icon">üß™</div><div><div class="title">Learning Lab</div><div class="sub">Deep dive study</div></div>
                </div>
                <div class="hero-card" onclick="showSimulationLab()">
                    <div class="icon">‚ö°</div><div><div class="title">Simulation Lab</div><div class="sub">Exam mode</div></div>
                </div>
                <div class="hero-card" onclick="showPomodoro()">
                    <div class="icon">üçÖ</div><div><div class="title">Pomodoro</div><div class="sub">Focus timer</div></div>
                </div>
            </div>
            
            <div class="card card-metrics square-card-bottom" onclick="safeNavigate('stats.html')">
                <div class="metrics-header">
                    <span class="metrics-title">Performance</span>
                    <span class="metrics-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg></span>
                </div>
                <div class="pie-container"><div class="pie-chart-main"></div></div>
            </div>
        </div>

        <!-- Columna Derecha (Contiene IA Lab y Activity Log) --><div class="col-side col-right">
            <div class="card-promo-style" onclick="openAIModal('ia_search')">
                <div class="promo-header"><div class="ai-icon">ü§ñ</div><div class="promo-title">IA LAB ‚ú®</div></div>
                <div class="promo-desc">Smart Search. Find or generate questions instantly.</div>
                <button class="btn-start">ASK AI</button>
            </div>
            <!-- Elemento oculto en m√≥vil (por CSS) --><div class="card card-secondary usage-container square-card-bottom">
                <div class="usage-header"><div class="card-title" style="font-size:0.85rem;">Activity Log</div></div>
                <div class="ring-chart"></div>
                <div class="activity-dots"><div class="dot active"></div><div class="dot active"></div><div class="dot"></div><div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot active"></div><div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot active"></div><div class="dot"></div></div>
            </div>
        </div>
    </div>

    <!-- VISTAS INTERNAS (C√ìDIGO SIMPLIFICADO POR ESPACIO) --><div id="learning-view" class="hidden">
        <div class="learning-cards-row">
            <div class="learning-card" onclick="openSelectionView('standalone')">
                <div class="learning-icon">üß†</div><h3>Stand Alone</h3><p>Practice specific topics.</p>
            </div>
            <div class="learning-card" onclick="openSelectionView('itemsets')">
                <div class="learning-icon">üîó</div><h3>Item
